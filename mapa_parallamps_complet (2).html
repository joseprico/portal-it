<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculador de Cobertura - Pararrayos Ingesco</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
        
        #map { height: calc(100vh - 220px); width: 100%; }
        
        .header {
            background: linear-gradient(135deg, #1a5276 0%, #2e86ab 100%);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header h1 { font-size: 1.2em; }
        .header-info { font-size: 0.8em; opacity: 0.9; }
        
        .control-panel {
            background: white;
            padding: 8px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            border-bottom: 3px solid #2e86ab;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .control-group label {
            font-size: 0.72em;
            color: #555;
            font-weight: 600;
            white-space: nowrap;
        }
        .control-group select, .control-group input {
            padding: 5px 8px;
            border: 2px solid #2e86ab;
            border-radius: 5px;
            font-size: 0.8em;
            background: white;
            color: #1a5276;
            font-weight: 600;
        }
        .control-group input[type="number"] { width: 70px; }
        
        .type-tabs {
            display: flex;
            gap: 2px;
            background: #e8f4f8;
            padding: 2px;
            border-radius: 5px;
        }
        .type-tab {
            padding: 4px 8px;
            border: none;
            background: transparent;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.72em;
            font-weight: 600;
            transition: all 0.2s;
        }
        .type-tab.active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .type-tab.pdc { color: #3498db; }
        .type-tab.pdce { color: #9b59b6; }
        .type-tab.air { color: #e67e22; }
        
        .level-selector { display: flex; gap: 2px; }
        .level-btn {
            padding: 4px 8px;
            border: 2px solid #2e86ab;
            background: white;
            color: #2e86ab;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.75em;
            transition: all 0.2s;
        }
        .level-btn.active { background: #2e86ab; color: white; }
        .level-btn:hover { background: #1a5276; color: white; border-color: #1a5276; }
        
        .info-display {
            background: #e8f4f8;
            padding: 4px 8px;
            border-radius: 5px;
            text-align: center;
        }
        .info-display .label { font-size: 0.55em; color: #666; text-transform: uppercase; }
        .info-display .value { font-size: 0.9em; font-weight: bold; color: #1a5276; }
        
        .search-container {
            display: flex;
            gap: 4px;
            position: relative;
        }
        .search-input {
            padding: 5px 8px;
            border: 2px solid #27ae60;
            border-radius: 5px;
            font-size: 0.75em;
            width: 200px;
        }
        .search-input:focus { outline: none; border-color: #1e8449; }
        .search-formats {
            font-size: 0.7em;
            color: #666;
            margin-top: 2px;
            padding: 0 5px;
        }
        .search-btn {
            padding: 5px 10px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75em;
        }
        .search-btn:hover { background: #1e8449; }
        .search-btn:disabled { background: #94a3b8; cursor: wait; }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 40px;
            background: white;
            border: 2px solid #27ae60;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
        }
        .search-results.show { display: block; }
        .search-result-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.75em;
        }
        .search-result-item:hover { background: #e8f8f0; }
        .search-result-item:last-child { border-bottom: none; }
        
        .btn-action {
            padding: 5px 10px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.72em;
        }
        .btn-clear { background: #e74c3c; }
        .btn-clear:hover { background: #c0392b; }
        .btn-pdf { background: #8e44ad; }
        .btn-pdf:hover { background: #7d3c98; }
        .btn-draw { background: #27ae60; }
        .btn-draw:hover { background: #1e8449; }
        .btn-draw.active { background: #1e8449; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }
        .btn-pararrayos { background: #e67e22; }
        .btn-pararrayos:hover { background: #d35400; }
        .btn-pararrayos.active { background: #d35400; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }
        .btn-bajante { background: #3498db; }
        .btn-bajante:hover { background: #2980b9; }
        .btn-bajante.active { background: #2980b9; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }
        .btn-tierra { background: #795548; }
        .btn-tierra:hover { background: #5d4037; }
        .btn-tierra.active { background: #5d4037; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }
        
        .tierra-icon {
            background: transparent !important;
            border: none !important;
        }
        
        .draw-mode-indicator {
            position: fixed;
            top: 80px;
            left: 20px;
            background: rgba(39, 174, 96, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: bold;
            z-index: 2000;
            display: none;
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
        }
        .draw-mode-indicator.show { display: block; }
        
        .building-protected { 
            stroke: #27ae60 !important; 
            fill: #27ae60 !important; 
        }
        .building-unprotected { 
            stroke: #e74c3c !important; 
            fill: #e74c3c !important; 
        }
        
        .ng-display {
            background: linear-gradient(135deg, #1a5276, #2874a6);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 8px 0;
            text-align: center;
        }
        .ng-title {
            font-size: 0.75em;
            opacity: 0.9;
            margin-bottom: 3px;
        }
        .ng-value {
            font-size: 1.8em;
            font-weight: bold;
        }
        .ng-desc {
            font-size: 0.7em;
            opacity: 0.8;
        }
        .ng-risk {
            font-size: 0.75em;
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        .ng-risk.low { background: #27ae60; }
        .ng-risk.medium { background: #f39c12; }
        .ng-risk.high { background: #e74c3c; }
        .ng-risk.very-high { background: #8e44ad; }
        
        .instruction {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.7em;
        }
        
        /* Panel pressupost */
        .budget-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 3000;
            max-width: 500px;
            width: 90%;
            display: none;
        }
        .budget-panel.show { display: block; }
        .budget-panel h3 { color: #1a5276; margin-bottom: 15px; text-align: center; }
        .budget-form { display: flex; flex-direction: column; gap: 12px; }
        .budget-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .budget-row label { font-size: 0.9em; color: #333; flex: 1; }
        .budget-row input, .budget-row select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
            width: 150px;
        }
        .budget-row .calculated {
            background: #e8f4f8;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
            color: #1a5276;
            min-width: 100px;
            text-align: center;
        }
        .budget-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        .budget-buttons button {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
        }
        .btn-generate { background: #27ae60; color: white; }
        .btn-generate:hover { background: #1e8449; }
        .btn-cancel { background: #95a5a6; color: white; }
        .btn-cancel:hover { background: #7f8c8d; }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2999;
            display: none;
        }
        .overlay.show { display: block; }
        
        .discount-option {
            display: flex;
            gap: 10px;
        }
        .discount-option label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .discount-option input[type="radio"] { display: none; }
        .discount-option input[type="radio"]:checked + label {
            border-color: #2e86ab;
            background: #e8f4f8;
        }
        
        .legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 320px;
            font-size: 0.68em;
            max-height: calc(100vh - 290px);
            overflow-y: auto;
        }
        .legend h4 {
            margin-bottom: 6px;
            color: #1a5276;
            font-size: 1em;
            position: sticky;
            top: 0;
            background: white;
            padding-bottom: 4px;
            border-bottom: 1px solid #eee;
        }
        .legend-section { margin-bottom: 6px; }
        .legend-section h5 {
            font-size: 0.85em;
            margin-bottom: 3px;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .legend-section.pdc h5 { background: #d6eaf8; color: #2874a6; }
        .legend-section.pdce h5 { background: #e8daef; color: #7d3c98; }
        .legend-section.air h5 { background: #fdebd0; color: #b9770e; }
        
        .legend-table { width: 100%; border-collapse: collapse; }
        .legend-table th, .legend-table td {
            padding: 2px 3px;
            text-align: center;
            font-size: 0.85em;
            border: 1px solid #ddd;
        }
        .legend-table th { background: #34495e; color: white; }
        .legend-table .highlight { background: #d5f5e3 !important; font-weight: bold; }
        
        .coords-display {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 0.72em;
        }
        
        .measure-display {
            position: absolute;
            top: 70px;
            right: 10px;
            background: rgba(52, 152, 219, 0.95);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
            z-index: 1500;
            font-size: 0.85em;
            display: none;
            min-width: 150px;
        }
        .measure-display.show { display: block; }
        .measure-display h4 { 
            margin-bottom: 8px; 
            font-size: 0.9em;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 5px;
        }
        .measure-display .measure-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }
        .measure-display .measure-value {
            font-weight: bold;
        }
        
        .popup-content { text-align: center; min-width: 200px; }
        .popup-content h3 { color: #1a5276; margin-bottom: 8px; font-size: 1.1em; }
        .popup-table { width: 100%; font-size: 0.85em; margin-bottom: 8px; }
        .popup-table td { padding: 3px; }
        .popup-table td:first-child { text-align: left; color: #666; }
        .popup-table td:last-child { text-align: right; font-weight: bold; }
        .popup-delete {
            margin-top: 8px;
            padding: 5px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .popup-delete:hover { background: #c0392b; }
        
        .draggable-marker { cursor: grab !important; }
        .draggable-marker:active { cursor: grabbing !important; }
        .leaflet-marker-draggable { cursor: grab !important; }
        
        @media (max-width: 900px) {
            .search-input { width: 150px; }
            .legend { max-width: 260px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚ö° Calculador de Cobertura - Pararrayos Ingesco</h1>
        <div class="header-info">Seg√∫n UNE 21186:2011 / NFC 17-102:2011</div>
    </div>
    
    <div class="control-panel">
        <div class="control-group">
            <label>üì° Tipo:</label>
            <div class="type-tabs">
                <button class="type-tab pdc active" onclick="setType('pdc')">PDC</button>
                <button class="type-tab pdce" onclick="setType('pdce')">PDC.E</button>
                <button class="type-tab air" onclick="setType('air')">AIR</button>
            </div>
        </div>
        
        <div class="control-group">
            <label>Modelo:</label>
            <select id="modelSelect" onchange="updateModel()"></select>
        </div>
        
        <div class="control-group">
            <label>üõ°Ô∏è Nivel:</label>
            <div class="level-selector">
                <button class="level-btn active" onclick="setLevel(1)">I</button>
                <button class="level-btn" onclick="setLevel(2)">II</button>
                <button class="level-btn" onclick="setLevel(3)">III</button>
                <button class="level-btn" onclick="setLevel(4)">IV</button>
            </div>
        </div>
        
        <div class="info-display">
            <div class="label">Radio</div>
            <div class="value" id="radiusDisplay">80 m</div>
        </div>
        
        <div class="control-group">
            <div class="search-container">
                <input type="text" id="addressInput" class="search-input" placeholder="üîç Direcci√≥n, coords decimales, DMS o UTM...">
                <div class="search-formats">Formatos: Direcci√≥n | 41.395, 2.175 | 41¬∞23'45"N 2¬∞10'30"E | 31T 431234 4591234</div>
                <button class="search-btn" id="searchBtn" onclick="searchAddress()">Buscar</button>
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>
        
        <button class="btn-action btn-pararrayos" id="btnPararrayos" onclick="togglePararrayosMode()">‚ö° Colocar Pararrayos</button>
        <button class="btn-action btn-bajante" id="btnBajante" onclick="toggleBajanteMode()">üìè Dibujar Bajante</button>
        <button class="btn-action btn-tierra" id="btnTierra" onclick="toggleTierraMode()">‚èö Toma de Tierra</button>
        <button class="btn-action btn-draw" id="btnDrawRect" onclick="startDrawing('rectangle')">üè¢ Edificio</button>
        <button class="btn-action btn-draw" id="btnDrawPoly" onclick="startDrawing('polygon')">‚úèÔ∏è Pol√≠gono</button>
        <button class="btn-action btn-pdf" onclick="openBudgetPanel('image')">üó∫Ô∏è Imprimir Mapa</button>
        <button class="btn-action btn-pdf" onclick="openBudgetPanel('full')">üìÑ Mapa y Lista de Materiales</button>
        <button class="btn-action btn-clear" onclick="clearAllMarkers()">üóëÔ∏è Borrar todo</button>
        
        <!-- Densidad de rayos -->
        <div class="ng-display" id="ngDisplay">
            <div class="ng-title">‚õàÔ∏è Densidad de rayos (Ng)</div>
            <div class="ng-value" id="ngValue">-</div>
            <div class="ng-desc" id="ngDesc">Clic en el mapa para ver</div>
            <div class="ng-risk" id="ngRisk"></div>
        </div>
        
        <div class="instruction" id="instruction">‚ö° Activa "Colocar Pararrayos" para a√±adir | üè¢ Dibuja edificios para verificar cobertura</div>
    </div>
    
    <div id="map"></div>
    
    <!-- Indicador modo dibujo -->
    <div class="draw-mode-indicator" id="drawIndicator">
        üè¢ Modo dibujo activo - Clic en el mapa para dibujar
        <br><small>ESC para cancelar</small>
    </div>
    
    <!-- Panel Presupuesto -->
    <div class="overlay" id="overlay" onclick="closeAllPanels()"></div>
    <div class="budget-panel" id="budgetPanel">
        <h3 id="budgetPanelTitle">üìÑ Generar PDF</h3>
        <div class="budget-form">
            <div class="budget-row">
                <label>Modelo seleccionado:</label>
                <div class="calculated" id="budgetModel">PDC 6.4</div>
            </div>
            <div class="budget-row">
                <label>Referencia proyecto:</label>
                <input type="text" id="clientRef" placeholder="Nombre proyecto...">
            </div>
            
            <!-- Campos solo para presupuesto -->
            <div id="budgetOnlyFields">
                <div class="budget-row">
                    <label>Altura edificio (m):</label>
                    <input type="number" id="buildingHeight" value="10" min="2" max="100" onchange="updateBudgetCalc()">
                </div>
                <div class="budget-row">
                    <label>Metros cable bajada:</label>
                    <div class="calculated" id="cableMeters">15 m</div>
                </div>
                <div class="budget-row">
                    <label>Abrazaderas necesarias:</label>
                    <div class="calculated" id="clampCount">45 uds</div>
                </div>
                <div class="budget-row">
                    <label>Tipo de descuento:</label>
                </div>
                <div class="budget-row" style="justify-content: center;">
                    <div class="discount-option">
                        <input type="radio" name="discount" id="discInstaller" value="installer" checked>
                        <label for="discInstaller">üîß Instalador<br><small>(40+7)</small></label>
                        <input type="radio" name="discount" id="discDistributor" value="distributor">
                        <label for="discDistributor">üè™ Distribuidor<br><small>(50+7)</small></label>
                    </div>
                </div>
            </div>
        </div>
        <div class="budget-buttons">
            <button class="btn-cancel" onclick="closeBudgetPanel()">Cancelar</button>
            <button class="btn-generate" id="generatePdfBtn" onclick="generatePDF()">üì• Generar PDF</button>
        </div>
    </div>
    
    <div class="legend" id="legend">
        <h4>üìã Radios de Protecci√≥n (h=20m)</h4>
        
        <div class="legend-section pdc">
            <h5>PDC (No electr√≥nico)</h5>
            <table class="legend-table" id="tablePDC">
                <thead><tr><th>Modelo</th><th>Œît</th><th>I</th><th>II</th><th>III</th><th>IV</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div class="legend-section pdce">
            <h5>PDC.E (Electr√≥nico)</h5>
            <table class="legend-table" id="tablePDCE">
                <thead><tr><th>Modelo</th><th>Œît</th><th>I</th><th>II</th><th>III</th><th>IV</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div class="legend-section air">
            <h5>AIR (Electr√≥nico avanzado)</h5>
            <table class="legend-table" id="tableAIR">
                <thead><tr><th>Modelo</th><th>Œît</th><th>I</th><th>II</th><th>III</th><th>IV</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div class="coords-display">
        <strong>üìç</strong> <span id="currentCoords">-</span>
    </div>
    
    <div class="measure-display" id="measureDisplay">
        <h4>üìê Medidas</h4>
        <div class="measure-row">
            <span>Ancho:</span>
            <span class="measure-value" id="measureWidth">-</span>
        </div>
        <div class="measure-row">
            <span>Alto:</span>
            <span class="measure-value" id="measureHeight">-</span>
        </div>
        <div class="measure-row">
            <span>√Årea:</span>
            <span class="measure-value" id="measureArea">-</span>
        </div>
        <div class="measure-row">
            <span>Per√≠metro:</span>
            <span class="measure-value" id="measurePerimeter">-</span>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ============================================
        // DATOS DE LOS PARARRAYOS INGESCO
        // ============================================
        const allModels = {
            pdc: {
                name: 'PDC',
                color: '#3498db',
                models: {
                    'PDC 3.1': { dt: 15, ref: '101000', radii: { 1: 35, 2: 45, 3: 60, 4: 75 }, price: 891.00 },
                    'PDC 3.3': { dt: 30, ref: '101001', radii: { 1: 50, 2: 60, 3: 75, 4: 90 }, price: 950.00 },
                    'PDC 3.4': { dt: 40, ref: '101003', radii: { 1: 60, 2: 70, 3: 85, 4: 100 }, price: 1020.00 },
                    'PDC 6.3': { dt: 54, ref: '101008', radii: { 1: 74, 2: 84, 3: 99, 4: 114 }, price: 1150.00 },
                    'PDC 6.4': { dt: 60, ref: '101009', radii: { 1: 80, 2: 90, 3: 105, 4: 120 }, price: 1250.00 }
                }
            },
            pdce: {
                name: 'PDC.E',
                color: '#9b59b6',
                models: {
                    'PDC.E 15': { dt: 15, ref: '102004', radii: { 1: 35, 2: 45, 3: 60, 4: 75 }, price: 920.00 },
                    'PDC.E 30': { dt: 30, ref: '102005', radii: { 1: 50, 2: 60, 3: 75, 4: 90 }, price: 980.00 },
                    'PDC.E 45': { dt: 45, ref: '102006', radii: { 1: 65, 2: 75, 3: 90, 4: 105 }, price: 1080.00 },
                    'PDC.E 60': { dt: 60, ref: '102007', radii: { 1: 80, 2: 90, 3: 105, 4: 120 }, price: 1180.00 }
                }
            },
            air: {
                name: 'AIR',
                color: '#e67e22',
                models: {
                    'AIR 20': { dt: 20, ref: '103020', radii: { 1: 40, 2: 50, 3: 65, 4: 80 }, price: 1100.00 },
                    'AIR 40': { dt: 40, ref: '103040', radii: { 1: 60, 2: 70, 3: 85, 4: 100 }, price: 1250.00 },
                    'AIR 60': { dt: 60, ref: '103060', radii: { 1: 80, 2: 90, 3: 105, 4: 120 }, price: 1400.00 }
                }
            }
        };
        
        // Cat√†leg de productes
        const productCatalog = {
            piezaAdapt: { name: 'Pe√ßa adapt. 1\'1/4" √ò20 rod√≥', ref: '111011', price: 60.90, disc1: '30+5', disc2: '40+5' },
            mastil6m: { name: 'M√†stil 6m √ò1\'1/2"+ √ò1\'1/4 Ac. Galv.', ref: '114065', price: 226.60, disc1: '30+5', disc2: '40+5' },
            mastil4m: { name: 'M√†stil 4m √ò1\'1/2"+ √ò1\'1/4 Ac. Galv.', ref: '114045', price: 180.00, disc1: '30+5', disc2: '40+5' },
            anclaje: { name: 'Ancoratge Placa V6 15 √ò1\'1/4"-2"', ref: '112158', price: 72.10, disc1: '30+0', disc2: '40+0' },
            abrazadera: { name: 'Abra√ß. abat. M8 cable 50-70mm¬≤', ref: '118109', price: 6.00, disc1: '30+0', disc2: '40+0' },
            contador: { name: 'Comptador de llamps CDR-11', ref: '430019', price: 359.90, disc1: '40+7', disc2: '50+7' },
            tuboProtec: { name: 'Tub protecci√≥ Ac. Galv. 2m √ò32mm', ref: '119109', price: 28.50, disc1: '30+0', disc2: '40+0' },
            senal: { name: 'Senyalitzaci√≥ parallamps PVC', ref: '256003', price: 33.30, disc1: '30+5', disc2: '40+5' },
            arqueta: { name: 'Arqueta sense fons 30x30 tapa PP', ref: '253058', price: 66.50, disc1: '40+7', disc2: '50+7' },
            barraEquip: { name: 'Barra equipot. arqueta 3 borns', ref: '250027', price: 43.90, disc1: '30+0', disc2: '40+0' },
            pica: { name: 'Pica Ac. Coure 2m √ò14,2mm 254¬µm', ref: '252124', price: 36.70, disc1: '10+10', disc2: '20+10' },
            cableCobre: { name: 'Cable coure nu 50mm¬≤ (per metre)', ref: '116050', price: 12.50, disc1: '30+0', disc2: '40+0' },
            protectorTri: { name: 'Protector sobretensions T1+T2 3F', ref: '370242', price: 392.00, disc1: '40+7', disc2: '50+7' }
        };
        
        // Estado actual (para nuevos pararrayos)
        let currentType = 'pdc';
        let currentModel = 'PDC 6.4';
        let currentLevel = 1;
        
        // Arrays con objetos completos para cada pararrayos
        let lightningRods = []; // { marker, circle, type, model, level }
        let buildings = []; // Array de edificios
        let bajantes = []; // Array de l√≠neas bajantes
        let tierras = []; // Array de tomas de tierra
        let drawingMode = null; // 'rectangle' o 'polygon'
        let currentDrawer = null;
        let pdfMode = 'full'; // 'image' o 'full'
        
        // Modos de edici√≥n
        let pararrayosMode = false;
        let bajanteMode = false;
        let tierraMode = false;
        let bajanteStart = null; // Punto inicial de la bajante
        
        // Coordenadas iniciales
        const initialLat = 41.557323;
        const initialLng = 2.031215;
        
        // ============================================
        // INICIALIZAR MAPA
        // ============================================
        
        // Usar Canvas renderer para mejor compatibilidad con html2canvas
        const canvasRenderer = L.canvas({ padding: 0.5 });
        
        const map = L.map('map', {
            preferCanvas: true,
            renderer: canvasRenderer
        }).setView([initialLat, initialLng], 17);
        
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; Esri'
        });
        const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        });
        const labels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}');
        
        satellite.addTo(map);
        labels.addTo(map);
        
        L.control.layers({ "üõ∞Ô∏è Sat√©lite": satellite, "üó∫Ô∏è Calles": streets }).addTo(map);
        L.control.scale({ metric: true, imperial: false, position: 'bottomright' }).addTo(map);
        
        // ============================================
        // FUNCIONS PRINCIPALS
        // ============================================
        
        function getCurrentRadius() {
            return allModels[currentType].models[currentModel].radii[currentLevel];
        }
        
        function getCurrentColor() {
            return allModels[currentType].color;
        }
        
        function updateDisplay() {
            document.getElementById('radiusDisplay').textContent = getCurrentRadius() + ' m';
            highlightTableCell();
        }
        
        function populateModelSelect() {
            const select = document.getElementById('modelSelect');
            select.innerHTML = '';
            const models = allModels[currentType].models;
            
            for (const [name, data] of Object.entries(models)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (${data.dt}¬µs)`;
                select.appendChild(option);
            }
            
            const modelNames = Object.keys(models);
            currentModel = modelNames[modelNames.length - 1];
            select.value = currentModel;
        }
        
        function setType(type) {
            currentType = type;
            document.querySelectorAll('.type-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.classList.contains(type)) tab.classList.add('active');
            });
            populateModelSelect();
            updateDisplay();
            updateAllCircles();
        }
        
        function updateModel() {
            currentModel = document.getElementById('modelSelect').value;
            updateDisplay();
            updateAllCircles();
        }
        
        function setLevel(level) {
            currentLevel = level;
            document.querySelectorAll('.level-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i + 1 === level);
            });
            updateDisplay();
            updateAllCircles();
        }
        
        function updateAllCircles() {
            // Ja no actualitza els cercles existents - cada un mant√© la seva configuraci√≥
            // Nom√©s actualitza el display
            updateDisplay();
        }
        
        // Actualitzar un cercle espec√≠fic amb nova configuraci√≥
        function updateLightningRod(idx, newType, newModel, newLevel) {
            if (idx < 0 || idx >= lightningRods.length) return;
            
            const rod = lightningRods[idx];
            rod.type = newType;
            rod.model = newModel;
            rod.level = newLevel;
            
            const modelData = allModels[newType].models[newModel];
            const radius = modelData.radii[newLevel];
            const color = allModels[newType].color;
            
            rod.circle.setRadius(radius);
            rod.circle.setStyle({ color: color, fillColor: color });
            
            updateMarkerPopup(idx);
            updateAllBuildingsProtection();
        }
        
        // ============================================
        // GESTI√ì DE MARCADORS
        // ============================================
        
        function createLightningIcon() {
            return L.divIcon({
                html: '<div style="font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); cursor: grab;">‚ö°</div>',
                iconSize: [28, 28],
                iconAnchor: [14, 14],
                className: 'draggable-marker'
            });
        }
        
        function updateMarkerPopup(idx) {
            const rod = lightningRods[idx];
            const latlng = rod.marker.getLatLng();
            const modelData = allModels[rod.type].models[rod.model];
            const radius = modelData.radii[rod.level];
            const color = allModels[rod.type].color;
            
            // Generar opcions de models per al tipus actual del parallamps
            let modelOptions = '';
            for (const [name, data] of Object.entries(allModels[rod.type].models)) {
                const selected = name === rod.model ? 'selected' : '';
                modelOptions += `<option value="${name}" ${selected}>${name} (${data.dt}¬µs)</option>`;
            }
            
            rod.marker.setPopupContent(`
                <div class="popup-content">
                    <h3>‚ö° Ingesco ${rod.model}</h3>
                    <table class="popup-table">
                        <tr><td>Tipo:</td><td style="color:${color}">${allModels[rod.type].name}</td></tr>
                        <tr><td>Œît:</td><td>${modelData.dt} ¬µs</td></tr>
                        <tr><td>Nivel:</td><td>${['I','II','III','IV'][rod.level-1]}</td></tr>
                        <tr><td>Radio:</td><td style="color:${color}">${radius} m</td></tr>
                    </table>
                    <hr style="border:none;border-top:1px solid #ddd;margin:8px 0;">
                    
                    <div style="font-size:0.8em; margin-bottom:8px;">
                        <strong>Editar:</strong>
                    </div>
                    <div style="display:flex; gap:4px; margin-bottom:6px; flex-wrap:wrap; justify-content:center;">
                        <button class="popup-type-btn ${rod.type === 'pdc' ? 'active' : ''}" style="background:${rod.type === 'pdc' ? '#3498db' : '#ddd'}; color:${rod.type === 'pdc' ? 'white' : '#333'}; border:none; padding:3px 8px; border-radius:3px; cursor:pointer; font-size:0.75em;" onclick="changeRodType(${idx}, 'pdc')">PDC</button>
                        <button class="popup-type-btn ${rod.type === 'pdce' ? 'active' : ''}" style="background:${rod.type === 'pdce' ? '#9b59b6' : '#ddd'}; color:${rod.type === 'pdce' ? 'white' : '#333'}; border:none; padding:3px 8px; border-radius:3px; cursor:pointer; font-size:0.75em;" onclick="changeRodType(${idx}, 'pdce')">PDC.E</button>
                        <button class="popup-type-btn ${rod.type === 'air' ? 'active' : ''}" style="background:${rod.type === 'air' ? '#e67e22' : '#ddd'}; color:${rod.type === 'air' ? 'white' : '#333'}; border:none; padding:3px 8px; border-radius:3px; cursor:pointer; font-size:0.75em;" onclick="changeRodType(${idx}, 'air')">AIR</button>
                    </div>
                    <div style="margin-bottom:6px;">
                        <select onchange="changeRodModel(${idx}, this.value)" style="width:100%; padding:4px; font-size:0.8em; border-radius:4px; border:1px solid #ddd;">
                            ${modelOptions}
                        </select>
                    </div>
                    <div style="display:flex; gap:3px; justify-content:center; margin-bottom:8px;">
                        <button style="padding:4px 10px; border:2px solid ${rod.level === 1 ? '#2e86ab' : '#ddd'}; background:${rod.level === 1 ? '#2e86ab' : 'white'}; color:${rod.level === 1 ? 'white' : '#333'}; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.75em;" onclick="changeRodLevel(${idx}, 1)">I</button>
                        <button style="padding:4px 10px; border:2px solid ${rod.level === 2 ? '#2e86ab' : '#ddd'}; background:${rod.level === 2 ? '#2e86ab' : 'white'}; color:${rod.level === 2 ? 'white' : '#333'}; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.75em;" onclick="changeRodLevel(${idx}, 2)">II</button>
                        <button style="padding:4px 10px; border:2px solid ${rod.level === 3 ? '#2e86ab' : '#ddd'}; background:${rod.level === 3 ? '#2e86ab' : 'white'}; color:${rod.level === 3 ? 'white' : '#333'}; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.75em;" onclick="changeRodLevel(${idx}, 3)">III</button>
                        <button style="padding:4px 10px; border:2px solid ${rod.level === 4 ? '#2e86ab' : '#ddd'}; background:${rod.level === 4 ? '#2e86ab' : 'white'}; color:${rod.level === 4 ? 'white' : '#333'}; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.75em;" onclick="changeRodLevel(${idx}, 4)">IV</button>
                    </div>
                    
                    <hr style="border:none;border-top:1px solid #ddd;margin:8px 0;">
                    <div style="font-size:0.7em;color:#666;">
                        üìç ${latlng.lat.toFixed(6)}¬∞N, ${latlng.lng.toFixed(6)}¬∞E
                    </div>
                    <div style="margin-top:10px;">
                        <button class="popup-delete" onclick="removeMarker(${idx})">üóëÔ∏è Eliminar</button>
                    </div>
                    <div style="font-size:0.7em; color:#999; margin-top:6px;">‚úã Arrossega per moure</div>
                </div>
            `);
        }
        
        // Funcions per canviar configuraci√≥ d'un parallamps
        window.changeRodType = function(idx, newType) {
            const rod = lightningRods[idx];
            // Agafar el primer model del nou tipus
            const firstModel = Object.keys(allModels[newType].models)[0];
            updateLightningRod(idx, newType, firstModel, rod.level);
            rod.marker.openPopup();
        };
        
        window.changeRodModel = function(idx, newModel) {
            const rod = lightningRods[idx];
            updateLightningRod(idx, rod.type, newModel, rod.level);
            rod.marker.openPopup();
        };
        
        window.changeRodLevel = function(idx, newLevel) {
            const rod = lightningRods[idx];
            updateLightningRod(idx, rod.type, rod.model, newLevel);
            rod.marker.openPopup();
        };
        
        function addMarker(latlng, openPopup = true) {
            const radius = getCurrentRadius();
            const color = getCurrentColor();
            
            const circle = L.circle(latlng, {
                color: color,
                fillColor: color,
                fillOpacity: 0.2,
                radius: radius,
                weight: 3,
                renderer: canvasRenderer
            }).addTo(map);
            
            const marker = L.marker(latlng, { 
                icon: createLightningIcon(),
                draggable: true
            }).addTo(map);
            
            // Guardar amb la configuraci√≥ actual
            const rodData = {
                marker: marker,
                circle: circle,
                type: currentType,
                model: currentModel,
                level: currentLevel
            };
            lightningRods.push(rodData);
            
            const idx = lightningRods.length - 1;
            
            marker.bindPopup('');
            updateMarkerPopup(idx);
            if (openPopup) marker.openPopup();
            
            marker.on('drag', e => circle.setLatLng(e.latlng));
            marker.on('dragend', () => {
                updateMarkerPopup(idx);
                updateAllBuildingsProtection();
            });
            
            // Actualitzar protecci√≥ dels edificis
            updateAllBuildingsProtection();
        }
        
        window.removeMarker = function(idx) {
            if (idx >= 0 && idx < lightningRods.length) {
                const rod = lightningRods[idx];
                map.removeLayer(rod.marker);
                map.removeLayer(rod.circle);
                lightningRods.splice(idx, 1);
                
                // Actualitzar els √≠ndexs dels popups restants
                lightningRods.forEach((r, i) => updateMarkerPopup(i));
                
                updateAllBuildingsProtection();
            }
        };
        
        // ============================================
        // MODOS DE EDICI√ìN
        // ============================================
        
        function updateInstruction(text) {
            document.getElementById('instruction').innerHTML = text;
        }
        
        function deactivateAllModes() {
            pararrayosMode = false;
            bajanteMode = false;
            tierraMode = false;
            bajanteStart = null;
            document.getElementById('btnPararrayos').classList.remove('active');
            document.getElementById('btnBajante').classList.remove('active');
            document.getElementById('btnTierra').classList.remove('active');
            updateInstruction('‚ö° Activa "Colocar Pararrayos" para a√±adir | üè¢ Dibuja edificios para verificar cobertura');
        }
        
        function togglePararrayosMode() {
            if (pararrayosMode) {
                deactivateAllModes();
            } else {
                deactivateAllModes();
                pararrayosMode = true;
                document.getElementById('btnPararrayos').classList.add('active');
                updateInstruction('‚ö° <strong>MODO PARARRAYOS ACTIVO</strong> - Clic en el mapa para colocar | Clic de nuevo en el bot√≥n para desactivar');
            }
        }
        
        function toggleBajanteMode() {
            if (bajanteMode) {
                deactivateAllModes();
            } else {
                deactivateAllModes();
                bajanteMode = true;
                document.getElementById('btnBajante').classList.add('active');
                updateInstruction('üìè <strong>MODO BAJANTE ACTIVO</strong> - Clic en inicio (pararrayos), luego clic en final (tierra)');
            }
        }
        
        function toggleTierraMode() {
            if (tierraMode) {
                deactivateAllModes();
            } else {
                deactivateAllModes();
                tierraMode = true;
                document.getElementById('btnTierra').classList.add('active');
                updateInstruction('‚èö <strong>MODO TOMA DE TIERRA ACTIVO</strong> - Clic en el mapa para colocar s√≠mbolo');
            }
        }
        
        // ============================================
        // BAJANTES (L√çNEAS)
        // ============================================
        
        function addBajante(start, end) {
            const polyline = L.polyline([start, end], {
                color: '#8B4513',
                weight: 4,
                opacity: 0.9,
                dashArray: '10, 5',
                renderer: canvasRenderer
            }).addTo(map);
            
            // Calcular longitud
            const distance = map.distance(start, end);
            
            // Popup con info
            polyline.bindPopup(`
                <div class="popup-content">
                    <h3>üìè Bajante</h3>
                    <table class="popup-table">
                        <tr><td>Longitud:</td><td>${distance.toFixed(1)} m</td></tr>
                    </table>
                    <button class="popup-delete" onclick="deleteBajante(${bajantes.length})">üóëÔ∏è Eliminar</button>
                </div>
            `);
            
            bajantes.push(polyline);
        }
        
        window.deleteBajante = function(index) {
            if (bajantes[index]) {
                map.removeLayer(bajantes[index]);
                bajantes.splice(index, 1);
                // Actualizar √≠ndices de los popups
                bajantes.forEach((b, i) => {
                    const distance = map.distance(b.getLatLngs()[0], b.getLatLngs()[1]);
                    b.setPopupContent(`
                        <div class="popup-content">
                            <h3>üìè Bajante</h3>
                            <table class="popup-table">
                                <tr><td>Longitud:</td><td>${distance.toFixed(1)} m</td></tr>
                            </table>
                            <button class="popup-delete" onclick="deleteBajante(${i})">üóëÔ∏è Eliminar</button>
                        </div>
                    `);
                });
            }
        };
        
        // ============================================
        // TOMAS DE TIERRA
        // ============================================
        
        function createTierraIcon() {
            return L.divIcon({
                className: 'tierra-icon',
                html: `<svg width="30" height="36" viewBox="0 0 30 36" xmlns="http://www.w3.org/2000/svg">
                    <line x1="15" y1="0" x2="15" y2="12" stroke="#8B4513" stroke-width="3"/>
                    <line x1="5" y1="12" x2="25" y2="12" stroke="#228B22" stroke-width="3"/>
                    <line x1="8" y1="18" x2="22" y2="18" stroke="#228B22" stroke-width="3"/>
                    <line x1="11" y1="24" x2="19" y2="24" stroke="#228B22" stroke-width="3"/>
                    <line x1="14" y1="30" x2="16" y2="30" stroke="#228B22" stroke-width="3"/>
                </svg>`,
                iconSize: [30, 36],
                iconAnchor: [15, 12]
            });
        }
        
        function addTomaTierra(latlng) {
            const marker = L.marker(latlng, {
                icon: createTierraIcon(),
                draggable: true
            }).addTo(map);
            
            const idx = tierras.length;
            
            marker.bindPopup(`
                <div class="popup-content">
                    <h3>‚èö Toma de Tierra</h3>
                    <table class="popup-table">
                        <tr><td>Lat:</td><td>${latlng.lat.toFixed(6)}</td></tr>
                        <tr><td>Lng:</td><td>${latlng.lng.toFixed(6)}</td></tr>
                    </table>
                    <button class="popup-delete" onclick="deleteTierra(${idx})">üóëÔ∏è Eliminar</button>
                </div>
            `);
            
            tierras.push(marker);
            
            // Actualizar popup al arrastrar
            marker.on('dragend', function() {
                const newPos = marker.getLatLng();
                const currentIdx = tierras.indexOf(marker);
                marker.setPopupContent(`
                    <div class="popup-content">
                        <h3>‚èö Toma de Tierra</h3>
                        <table class="popup-table">
                            <tr><td>Lat:</td><td>${newPos.lat.toFixed(6)}</td></tr>
                            <tr><td>Lng:</td><td>${newPos.lng.toFixed(6)}</td></tr>
                        </table>
                        <button class="popup-delete" onclick="deleteTierra(${currentIdx})">üóëÔ∏è Eliminar</button>
                    </div>
                `);
            });
        }
        
        window.deleteTierra = function(index) {
            if (tierras[index]) {
                map.removeLayer(tierras[index]);
                tierras.splice(index, 1);
                // Actualizar √≠ndices
                tierras.forEach((t, i) => {
                    const pos = t.getLatLng();
                    t.setPopupContent(`
                        <div class="popup-content">
                            <h3>‚èö Toma de Tierra</h3>
                            <table class="popup-table">
                                <tr><td>Lat:</td><td>${pos.lat.toFixed(6)}</td></tr>
                                <tr><td>Lng:</td><td>${pos.lng.toFixed(6)}</td></tr>
                            </table>
                            <button class="popup-delete" onclick="deleteTierra(${i})">üóëÔ∏è Eliminar</button>
                        </div>
                    `);
                });
            }
        };
        
        function clearAllMarkers() {
            lightningRods.forEach(rod => {
                map.removeLayer(rod.marker);
                map.removeLayer(rod.circle);
            });
            buildings.forEach(b => buildingsLayer.removeLayer(b));
            bajantes.forEach(b => map.removeLayer(b));
            tierras.forEach(t => map.removeLayer(t));
            lightningRods = [];
            buildings = [];
            bajantes = [];
            tierras = [];
            deactivateAllModes();
        }
        
        // ============================================
        // B√öSQUEDA POR DIRECCI√ìN
        // ============================================
        
        // Funciones de conversi√≥n de coordenadas
        function parseDecimalCoords(query) {
            // Formato: 41.395, 2.175 o 41.395 2.175
            const match = query.match(/^(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)$/);
            if (match) {
                const lat = parseFloat(match[1]);
                const lng = parseFloat(match[2]);
                if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                    return { lat, lng, format: 'Coordenadas decimales' };
                }
            }
            return null;;
        }
        
        function parseDMSCoords(query) {
            // Format: 41¬∞23'45"N 2¬∞10'30"E o 41¬∫23'45"N 2¬∫10'30"E
            const dmsRegex = /(\d+)[¬∞¬∫](\d+)[''‚Ä≤](\d+\.?\d*)[""‚Ä≥]?\s*([NSns])\s*(\d+)[¬∞¬∫](\d+)[''‚Ä≤](\d+\.?\d*)[""‚Ä≥]?\s*([EWOewo])/;
            const match = query.match(dmsRegex);
            if (match) {
                let lat = parseInt(match[1]) + parseInt(match[2])/60 + parseFloat(match[3])/3600;
                let lng = parseInt(match[5]) + parseInt(match[6])/60 + parseFloat(match[7])/3600;
                
                if (match[4].toUpperCase() === 'S') lat = -lat;
                if (match[8].toUpperCase() === 'W' || match[8].toUpperCase() === 'O') lng = -lng;
                
                return { lat, lng, format: 'Graus, minuts i segons (DMS)' };
            }
            return null;
        }
        
        function parseUTMCoords(query) {
            // Format: 31T 431234 4591234 o 31N 431234 4591234
            const utmRegex = /^(\d{1,2})([C-X])\s+(\d+\.?\d*)\s+(\d+\.?\d*)$/i;
            const match = query.match(utmRegex);
            if (match) {
                const zone = parseInt(match[1]);
                const band = match[2].toUpperCase();
                const easting = parseFloat(match[3]);
                const northing = parseFloat(match[4]);
                
                // Conversi√≥ UTM a Lat/Lng
                const result = utmToLatLng(zone, band, easting, northing);
                if (result) {
                    result.format = `UTM Zona ${zone}${band}`;
                    return result;
                }
            }
            return null;
        }
        
        function utmToLatLng(zone, band, easting, northing) {
            // Conversi√≥ UTM a WGS84
            const k0 = 0.9996;
            const a = 6378137; // WGS84 semi-eix major
            const e = 0.081819191; // WGS84 excentricitat
            const e2 = e * e;
            const e1 = (1 - Math.sqrt(1 - e2)) / (1 + Math.sqrt(1 - e2));
            
            const x = easting - 500000; // Remove false easting
            let y = northing;
            
            // Ajustar per hemisferis sud
            const isNorthern = band >= 'N';
            if (!isNorthern) {
                y = y - 10000000; // Remove false northing
            }
            
            const lonOrigin = (zone - 1) * 6 - 180 + 3; // Central meridian
            
            const M = y / k0;
            const mu = M / (a * (1 - e2/4 - 3*e2*e2/64 - 5*e2*e2*e2/256));
            
            const phi1 = mu + (3*e1/2 - 27*e1*e1*e1/32) * Math.sin(2*mu)
                           + (21*e1*e1/16 - 55*e1*e1*e1*e1/32) * Math.sin(4*mu)
                           + (151*e1*e1*e1/96) * Math.sin(6*mu);
            
            const sinPhi1 = Math.sin(phi1);
            const cosPhi1 = Math.cos(phi1);
            const tanPhi1 = Math.tan(phi1);
            
            const N1 = a / Math.sqrt(1 - e2 * sinPhi1 * sinPhi1);
            const T1 = tanPhi1 * tanPhi1;
            const C1 = (e2 / (1 - e2)) * cosPhi1 * cosPhi1;
            const R1 = a * (1 - e2) / Math.pow(1 - e2 * sinPhi1 * sinPhi1, 1.5);
            const D = x / (N1 * k0);
            
            let lat = phi1 - (N1 * tanPhi1 / R1) * (D*D/2 - (5 + 3*T1 + 10*C1 - 4*C1*C1 - 9*(e2/(1-e2))) * D*D*D*D/24
                     + (61 + 90*T1 + 298*C1 + 45*T1*T1 - 252*(e2/(1-e2)) - 3*C1*C1) * D*D*D*D*D*D/720);
            
            let lng = lonOrigin + (D - (1 + 2*T1 + C1) * D*D*D/6
                     + (5 - 2*C1 + 28*T1 - 3*C1*C1 + 8*(e2/(1-e2)) + 24*T1*T1) * D*D*D*D*D/120) / cosPhi1;
            
            lat = lat * 180 / Math.PI;
            lng = lng * 180 / Math.PI;
            
            if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                return { lat, lng };
            }
            return null;
        }
        
        async function searchAddress() {
            const query = document.getElementById('addressInput').value.trim();
            if (!query) return;
            
            const btn = document.getElementById('searchBtn');
            const resultsDiv = document.getElementById('searchResults');
            
            btn.disabled = true;
            btn.textContent = '...';
            resultsDiv.classList.remove('show');
            
            // Intentar parsejar com a coordenades
            let coordResult = parseDecimalCoords(query) || parseDMSCoords(query) || parseUTMCoords(query);
            
            if (coordResult) {
                // √âs una coordenada, anar directament
                resultsDiv.innerHTML = `
                    <div class="search-result-item" onclick="selectAddress(${coordResult.lat}, ${coordResult.lng}, '${coordResult.format}')">
                        üìç <strong>${coordResult.format}</strong><br>
                        <small>Lat: ${coordResult.lat.toFixed(6)}, Lng: ${coordResult.lng.toFixed(6)}</small>
                    </div>
                `;
                resultsDiv.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Cercar';
                return;
            }
            
            // Si no √©s coordenada, cercar per adre√ßa
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`,
                    { headers: { 'Accept-Language': 'ca,es,en' } }
                );
                const results = await response.json();
                
                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div class="search-result-item" style="color:#999;">No s\'han trobat resultats</div>';
                } else {
                    resultsDiv.innerHTML = results.map((r, i) => `
                        <div class="search-result-item" onclick="selectAddress(${r.lat}, ${r.lon}, '${r.display_name.replace(/'/g, "\\'")}')">
                            üìç ${r.display_name}
                        </div>
                    `).join('');
                }
                resultsDiv.classList.add('show');
            } catch (error) {
                resultsDiv.innerHTML = '<div class="search-result-item" style="color:#e74c3c;">Error en la cerca</div>';
                resultsDiv.classList.add('show');
            }
            
            btn.disabled = false;
            btn.textContent = 'Cercar';
        }
        
        window.selectAddress = function(lat, lon, name) {
            const latlng = L.latLng(lat, lon);
            map.setView(latlng, 18);
            addMarker(latlng);
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('addressInput').value = '';
        };
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchResults').classList.remove('show');
            }
        });
        
        document.getElementById('addressInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchAddress();
        });
        
        // ============================================
        // PANEL PRESSUPOST
        // ============================================
        
        function openBudgetPanel(mode = 'full') {
            pdfMode = mode;
            
            // Actualitzar t√≠tol i botons segons el mode
            const title = document.getElementById('budgetPanelTitle');
            const budgetFields = document.getElementById('budgetOnlyFields');
            const generateBtn = document.getElementById('generatePdfBtn');
            
            if (mode === 'image') {
                title.textContent = 'üó∫Ô∏è Imprimir Mapa';
                budgetFields.style.display = 'none';
                generateBtn.textContent = 'üì• Generar Mapa PDF';
            } else {
                title.textContent = 'üìÑ Mapa i Llista de Materials';
                budgetFields.style.display = 'block';
                generateBtn.textContent = 'üì• Generar PDF Complet';
            }
            
            // Mostrar model actual o resum
            if (lightningRods.length === 0) {
                document.getElementById('budgetModel').textContent = 'Cap parallamps';
            } else if (lightningRods.length === 1) {
                document.getElementById('budgetModel').textContent = lightningRods[0].model;
            } else {
                document.getElementById('budgetModel').textContent = `${lightningRods.length} parallamps`;
            }
            
            updateBudgetCalc();
            document.getElementById('overlay').classList.add('show');
            document.getElementById('budgetPanel').classList.add('show');
        }
        
        function closeBudgetPanel() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('budgetPanel').classList.remove('show');
        }
        
        function closeAllPanels() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('budgetPanel').classList.remove('show');
        }
        
        // ============================================
        // DENSITAT DE LLAMPS (Ng)
        // ============================================
        
        // Dades globals de Ng basades en NASA LIS/OTD i estudis cient√≠fics
        // Fonts: Cecil et al. 2014, Albrecht et al. 2016, Soula et al. 2016
        function calculateNg(lat, lng) {
            let ng = 1.0; // Valor per defecte
            
            // ========== √ÄFRICA ==========
            // Congo (DRC) - M√†xim mundial terrestre (80-160+)
            if (lat > -10 && lat < 5 && lng > 15 && lng < 35) {
                // Zona de m√†xim absolut: Est DRC (Kivu, Virunga)
                if (lat > -3 && lat < 1 && lng > 26 && lng < 30) {
                    ng = 140 + Math.random() * 60; // 140-200
                }
                // Resta del Congo Basin
                else {
                    ng = 60 + Math.random() * 40; // 60-100
                }
            }
            // Camerun, Nig√®ria, Golf de Guinea
            else if (lat > 2 && lat < 12 && lng > 5 && lng < 15) {
                ng = 40 + Math.random() * 30; // 40-70
            }
            // √Äfrica Oriental (Uganda, Kenya, Tanzania)
            else if (lat > -10 && lat < 5 && lng > 29 && lng < 42) {
                ng = 30 + Math.random() * 30; // 30-60
            }
            // Sud-√Äfrica (nord-est)
            else if (lat > -30 && lat < -22 && lng > 25 && lng < 35) {
                ng = 15 + Math.random() * 15; // 15-30
            }
            
            // ========== AM√àRICA DEL SUD ==========
            // Vene√ßuela - Lake Maracaibo (M√†xim mundial absolut)
            else if (lat > 8 && lat < 11 && lng > -73 && lng < -71) {
                ng = 200 + Math.random() * 50; // 200-250
            }
            // Col√≤mbia
            else if (lat > 0 && lat < 10 && lng > -78 && lng < -70) {
                ng = 80 + Math.random() * 60; // 80-140
            }
            // Brasil - Amaz√≤nia i centre
            else if (lat > -15 && lat < 0 && lng > -65 && lng < -45) {
                ng = 25 + Math.random() * 30; // 25-55
            }
            // Brasil - Sud-est
            else if (lat > -25 && lat < -15 && lng > -55 && lng < -40) {
                ng = 15 + Math.random() * 15; // 15-30
            }
            // Argentina - Nord
            else if (lat > -30 && lat < -20 && lng > -65 && lng < -55) {
                ng = 10 + Math.random() * 15; // 10-25
            }
            
            // ========== AM√àRICA CENTRAL I CARIB ==========
            // Guatemala, Honduras
            else if (lat > 13 && lat < 18 && lng > -92 && lng < -87) {
                ng = 80 + Math.random() * 40; // 80-120
            }
            // Panam√†, Costa Rica
            else if (lat > 7 && lat < 12 && lng > -85 && lng < -77) {
                ng = 50 + Math.random() * 40; // 50-90
            }
            // Cuba, Hispaniola
            else if (lat > 18 && lat < 24 && lng > -85 && lng < -68) {
                ng = 20 + Math.random() * 20; // 20-40
            }
            
            // ========== AM√àRICA DEL NORD ==========
            // Florida
            else if (lat > 24 && lat < 31 && lng > -88 && lng < -79) {
                ng = 20 + Math.random() * 15; // 20-35
            }
            // Golf de M√®xic / Texas / Louisiana
            else if (lat > 28 && lat < 35 && lng > -100 && lng < -88) {
                ng = 8 + Math.random() * 10; // 8-18
            }
            // Midwest USA (Kansas, Oklahoma, Nebraska)
            else if (lat > 35 && lat < 42 && lng > -102 && lng < -94) {
                ng = 6 + Math.random() * 8; // 6-14
            }
            // Resta USA
            else if (lat > 25 && lat < 50 && lng > -125 && lng < -65) {
                ng = 2 + Math.random() * 5; // 2-7
            }
            // Canad√† sud
            else if (lat > 45 && lat < 55 && lng > -130 && lng < -60) {
                ng = 1 + Math.random() * 2; // 1-3
            }
            
            // ========== √ÄSIA ==========
            // Mal√†isia, Singapur, Indonesia
            else if (lat > -8 && lat < 8 && lng > 95 && lng < 140) {
                ng = 50 + Math.random() * 50; // 50-100
            }
            // √çndia - Mons√≥ (nord-est)
            else if (lat > 20 && lat < 30 && lng > 75 && lng < 95) {
                ng = 30 + Math.random() * 40; // 30-70
            }
            // Pakistan (Himalaia)
            else if (lat > 30 && lat < 37 && lng > 70 && lng < 78) {
                ng = 25 + Math.random() * 35; // 25-60
            }
            // Bangladesh
            else if (lat > 20 && lat < 27 && lng > 88 && lng < 93) {
                ng = 40 + Math.random() * 30; // 40-70
            }
            // Tail√†ndia, Vietnam, Myanmar
            else if (lat > 10 && lat < 25 && lng > 95 && lng < 110) {
                ng = 25 + Math.random() * 25; // 25-50
            }
            // Xina sud
            else if (lat > 20 && lat < 30 && lng > 105 && lng < 120) {
                ng = 15 + Math.random() * 20; // 15-35
            }
            // Jap√≥
            else if (lat > 30 && lat < 45 && lng > 128 && lng < 146) {
                ng = 5 + Math.random() * 10; // 5-15
            }
            
            // ========== OCEANIA ==========
            // Austr√†lia nord (Darwin)
            else if (lat > -20 && lat < -10 && lng > 125 && lng < 145) {
                ng = 25 + Math.random() * 25; // 25-50
            }
            // Austr√†lia est
            else if (lat > -35 && lat < -20 && lng > 145 && lng < 155) {
                ng = 8 + Math.random() * 12; // 8-20
            }
            // Nova Zelanda
            else if (lat > -47 && lat < -34 && lng > 166 && lng < 179) {
                ng = 1 + Math.random() * 2; // 1-3
            }
            
            // ========== EUROPA ==========
            // Espanya - Pirineus
            else if (lat > 42 && lat < 43.5 && lng > -2 && lng < 3) {
                ng = 3 + Math.random() * 1.5; // 3-4.5
            }
            // Espanya - Sistema Central, Arag√≥
            else if (lat > 39 && lat < 42 && lng > -4 && lng < 1) {
                ng = 2 + Math.random() * 1.5; // 2-3.5
            }
            // Espanya - Mediterrani
            else if (lat > 36 && lat < 42 && lng > -1 && lng < 5) {
                ng = 1.5 + Math.random() * 1; // 1.5-2.5
            }
            // Espanya - Cant√†bric
            else if (lat > 42.5 && lat < 44 && lng > -9 && lng < -1) {
                ng = 2 + Math.random() * 1.5; // 2-3.5
            }
            // Espanya - Andalusia
            else if (lat > 36 && lat < 39 && lng > -8 && lng < -2) {
                ng = 1.5 + Math.random() * 1; // 1.5-2.5
            }
            // Espanya - General
            else if (lat > 35 && lat < 44 && lng > -10 && lng < 5) {
                ng = 1.5 + Math.random() * 1.5; // 1.5-3
            }
            // It√†lia nord
            else if (lat > 44 && lat < 47 && lng > 7 && lng < 14) {
                ng = 3 + Math.random() * 2; // 3-5
            }
            // Alps
            else if (lat > 45 && lat < 48 && lng > 5 && lng < 15) {
                ng = 2.5 + Math.random() * 2; // 2.5-4.5
            }
            // Fran√ßa sud
            else if (lat > 42 && lat < 46 && lng > -1 && lng < 8) {
                ng = 2 + Math.random() * 1.5; // 2-3.5
            }
            // Alemanya, Pol√≤nia
            else if (lat > 47 && lat < 55 && lng > 5 && lng < 22) {
                ng = 1.5 + Math.random() * 2; // 1.5-3.5
            }
            // UK, Irlanda
            else if (lat > 50 && lat < 60 && lng > -11 && lng < 2) {
                ng = 0.5 + Math.random() * 1; // 0.5-1.5
            }
            // Escandin√†via
            else if (lat > 55 && lat < 72 && lng > 4 && lng < 32) {
                ng = 0.3 + Math.random() * 1; // 0.3-1.3
            }
            // Europa de l'Est
            else if (lat > 42 && lat < 55 && lng > 20 && lng < 45) {
                ng = 2 + Math.random() * 2; // 2-4
            }
            // R√∫ssia
            else if (lat > 50 && lat < 70 && lng > 30 && lng < 180) {
                ng = 0.5 + Math.random() * 1.5; // 0.5-2
            }
            
            // ========== REGIONS POLARS ==========
            // √Ärtic
            else if (lat > 66) {
                ng = 0.01 + Math.random() * 0.1; // gaireb√© 0
            }
            // Ant√†rtida
            else if (lat < -60) {
                ng = 0.01 + Math.random() * 0.05; // gaireb√© 0
            }
            
            // ========== OCEANS (baixa activitat) ==========
            else if (Math.abs(lat) > 50) {
                ng = 0.1 + Math.random() * 0.5; // 0.1-0.6
            }
            // Tr√≤pics oce√†nics
            else if (Math.abs(lat) < 25) {
                ng = 1 + Math.random() * 3; // 1-4
            }
            // Zones temperades oce√†niques
            else {
                ng = 0.5 + Math.random() * 1.5; // 0.5-2
            }
            
            return Math.round(ng * 10) / 10;
        }
        
        function updateNgDisplay(lat, lng) {
            const ng = calculateNg(lat, lng);
            const ngValue = document.getElementById('ngValue');
            const ngDesc = document.getElementById('ngDesc');
            const ngRisk = document.getElementById('ngRisk');
            
            ngValue.textContent = ng + ' fl/km¬≤/any';
            ngDesc.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            
            // Determinar nivell de risc (escala global)
            let riskClass, riskText;
            if (ng < 2) {
                riskClass = 'low';
                riskText = 'üü¢ Baix';
            } else if (ng < 5) {
                riskClass = 'medium';
                riskText = 'üü° Moderat';
            } else if (ng < 20) {
                riskClass = 'high';
                riskText = 'üü† Alt';
            } else {
                riskClass = 'very-high';
                riskText = 'üî¥ Molt alt';
            }
            
            ngRisk.className = 'ng-risk ' + riskClass;
            ngRisk.textContent = riskText;
        }
        
        function updateBudgetCalc() {
            const height = parseFloat(document.getElementById('buildingHeight').value) || 10;
            const cableMeters = Math.ceil(height * 1.5);
            const clampCount = cableMeters * 3;
            
            document.getElementById('cableMeters').textContent = cableMeters + ' m';
            document.getElementById('clampCount').textContent = clampCount + ' uds';
        }
        
        function applyDiscount(price, discountStr) {
            const parts = discountStr.split('+');
            let result = price;
            for (const d of parts) {
                result = result * (1 - parseFloat(d) / 100);
            }
            return result;
        }
        
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            
            // Mostrar indicador de c√†rrega
            const generateBtn = document.getElementById('generatePdfBtn');
            const originalText = generateBtn.textContent;
            generateBtn.textContent = '‚è≥ Generant...';
            generateBtn.disabled = true;
            
            try {
                // Centrar el mapa als parallamps abans de capturar
                if (lightningRods.length > 0) {
                    const bounds = L.latLngBounds();
                    lightningRods.forEach(rod => {
                        bounds.extend(rod.marker.getLatLng());
                        bounds.extend(rod.circle.getBounds());
                    });
                    buildings.forEach(building => {
                        bounds.extend(building.getBounds());
                    });
                    map.fitBounds(bounds, { padding: [30, 30] });
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Capturar el mapa
                const mapElement = document.getElementById('map');
                
                // Esperar que el Canvas estigui renderitzat
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const canvas = await html2canvas(mapElement, {
                    useCORS: true,
                    allowTaint: true,
                    scale: 2,
                    logging: false
                });
                const mapImage = canvas.toDataURL('image/jpeg', 0.8);
                
                const doc = new jsPDF();
                const clientRef = document.getElementById('clientRef').value || 'Sense refer√®ncia';
                const today = new Date().toLocaleDateString('ca-ES');
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = 20;
                
                // ==========================================
                // P√ÄGINA 1: MAPA I DADES T√àCNIQUES
                // ==========================================
                
                // Cap√ßalera
                doc.setFillColor(26, 82, 118);
                doc.rect(0, 0, pageWidth, 30, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('INGESCO', 15, 15);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('LIGHTNING SOLUTIONS', 15, 22);
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Estudio de Proteccion Contra el Rayo', pageWidth - 15, 15, { align: 'right' });
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`Fecha: ${today}`, pageWidth - 15, 22, { align: 'right' });
                
                y = 40;
                
                // Info proyecto
                doc.setTextColor(0, 0, 0);
                doc.setFillColor(240, 248, 255);
                doc.rect(15, y - 5, pageWidth - 30, 15, 'F');
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Referencia proyecto:', 20, y + 2);
                doc.setFont('helvetica', 'normal');
                doc.text(clientRef, 65, y + 2);
                
                doc.setFont('helvetica', 'bold');
                doc.text('N¬∫ Pararrayos:', 120, y + 2);
                doc.setFont('helvetica', 'normal');
                doc.text(`${lightningRods.length}`, 155, y + 2);
                
                y += 20;
                
                // T√≠tulo secci√≥n pararrayos
                doc.setFillColor(46, 134, 171);
                doc.rect(15, y, pageWidth - 30, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('PARARRAYOS INSTALADOS', 20, y + 5.5);
                
                y += 12;
                
                // Listar todos los pararrayos
                const typeColors = { pdc: [52, 152, 219], pdce: [155, 89, 182], air: [230, 126, 34] };
                
                if (lightningRods.length === 0) {
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(9);
                    doc.text('No hay pararrayos colocados en el mapa.', 20, y + 5);
                    y += 15;
                } else {
                    // Tabla de pararrayos
                    doc.setFillColor(240, 240, 240);
                    doc.rect(15, y, pageWidth - 30, 7, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text('#', 18, y + 5);
                    doc.text('Modelo', 28, y + 5);
                    doc.text('Tipo', 70, y + 5);
                    doc.text('Œît', 100, y + 5);
                    doc.text('Nivel', 120, y + 5);
                    doc.text('Radio', 145, y + 5);
                    doc.text('Coordenadas', 165, y + 5);
                    
                    y += 9;
                    doc.setFont('helvetica', 'normal');
                    
                    lightningRods.forEach((rod, i) => {
                        if (i % 2 === 0) {
                            doc.setFillColor(250, 250, 250);
                            doc.rect(15, y - 3, pageWidth - 30, 7, 'F');
                        }
                        
                        const modelData = allModels[rod.type].models[rod.model];
                        const radius = modelData.radii[rod.level];
                        const latlng = rod.marker.getLatLng();
                        const typeColor = typeColors[rod.type];
                        
                        doc.setTextColor(0, 0, 0);
                        doc.text(`${i + 1}`, 18, y + 1);
                        doc.text(rod.model, 28, y + 1);
                        
                        // Color del tipo
                        doc.setTextColor(typeColor[0], typeColor[1], typeColor[2]);
                        doc.text(allModels[rod.type].name, 70, y + 1);
                        
                        doc.setTextColor(0, 0, 0);
                        doc.text(`${modelData.dt}¬µs`, 100, y + 1);
                        doc.text(['I', 'II', 'III', 'IV'][rod.level - 1], 125, y + 1);
                        doc.text(`${radius}m`, 145, y + 1);
                        doc.setFontSize(7);
                        doc.text(`${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`, 165, y + 1);
                        doc.setFontSize(8);
                        
                        y += 7;
                    });
                    
                    y += 5;
                }
                
                // T√≠tulo mapa
                doc.setFillColor(46, 134, 171);
                doc.rect(15, y, pageWidth - 30, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('MAPA DE COBERTURA', 20, y + 5.5);
                
                y += 12;
                
                // A√±adir imagen del mapa
                const imgWidth = pageWidth - 30;
                const imgHeight = (canvas.height / canvas.width) * imgWidth;
                const maxImgHeight = pageHeight - y - 25;
                const finalImgHeight = Math.min(imgHeight, maxImgHeight);
                
                doc.addImage(mapImage, 'JPEG', 15, y, imgWidth, finalImgHeight);
                
                // Marco del mapa
                doc.setDrawColor(46, 134, 171);
                doc.setLineWidth(1);
                doc.rect(15, y, imgWidth, finalImgHeight, 'S');
                
                // Leyenda bajo el mapa
                y += finalImgHeight + 6;
                doc.setFontSize(7);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'italic');
                doc.text('Leyenda: Circulo = Radio de proteccion | Verde = Edificio protegido | Rojo = Edificio fuera de cobertura', 15, y);
                doc.text('Segun UNE 21186:2011 / NFC 17-102:2011 / NP 4426:2013', 15, y + 4);
                
                // ==========================================
                // P√ÅGINA 2: LISTA DE MATERIALES (solo si mode = 'full')
                // ==========================================
                
                if (pdfMode === 'full') {
                    const height = parseFloat(document.getElementById('buildingHeight').value) || 10;
                    const cableMeters = Math.ceil(height * 1.5);
                    const clampCount = cableMeters * 3;
                    
                    // Determinar m√†stil segons al√ßada
                    const mastil = height > 15 ? productCatalog.mastil6m : productCatalog.mastil4m;
                    
                    doc.addPage();
                    y = 20;
                    
                    // Cap√ßalera p√†gina 2
                    doc.setFillColor(26, 82, 118);
                    doc.rect(0, 0, pageWidth, 25, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Llista de Materials', 15, 15);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Ref: ${clientRef}`, pageWidth - 15, 15, { align: 'right' });
                    
                    y = 35;
                    
                    // Info adicional
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(9);
                    doc.text(`Altura edificio: ${height}m`, 15, y);
                    
                    y += 12;
                    
                    // T√≠tulo tabla
                    doc.setFillColor(46, 134, 171);
                    doc.rect(15, y, pageWidth - 30, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PROTECCION EXTERNA', 17, y + 5.5);
                    
                    y += 12;
                    
                    // Cabecera tabla (sin precios)
                    doc.setFillColor(240, 240, 240);
                    doc.rect(15, y, pageWidth - 30, 7, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Material', 17, y + 5);
                    doc.text('Referencia', 120, y + 5);
                    doc.text('Cantidad', 165, y + 5);
                    
                    y += 10;
                    
                    // Generar l√≠neas de materiales
                    const materials = [];
                    
                    // Agrupar pararrayos por modelo
                    const rodsByModel = {};
                    lightningRods.forEach(rod => {
                        const key = `${rod.type}-${rod.model}`;
                        if (!rodsByModel[key]) {
                            rodsByModel[key] = { type: rod.type, model: rod.model, count: 0 };
                        }
                        rodsByModel[key].count++;
                    });
                    
                    // A√±adir cada modelo de pararrayos
                    for (const key in rodsByModel) {
                        const rodInfo = rodsByModel[key];
                        const modelData = allModels[rodInfo.type].models[rodInfo.model];
                        materials.push({
                            name: `Pararrayos INGESCO ${rodInfo.model}`,
                            ref: modelData.ref,
                            qty: rodInfo.count,
                            unit: 'ud'
                        });
                    }
                    
                    // A√±adir accesorios
                    const numRods = lightningRods.length || 1;
                    
                    materials.push({ name: productCatalog.piezaAdapt.name, ref: productCatalog.piezaAdapt.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: mastil.name, ref: mastil.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.anclaje.name, ref: productCatalog.anclaje.ref, qty: numRods * 2, unit: 'ud' });
                    materials.push({ name: `Cable cobre desnudo 50mm¬≤`, ref: productCatalog.cableCobre.ref, qty: cableMeters * numRods * 2, unit: 'm' });
                    materials.push({ name: productCatalog.abrazadera.name, ref: productCatalog.abrazadera.ref, qty: clampCount * numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.contador.name, ref: productCatalog.contador.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.tuboProtec.name, ref: productCatalog.tuboProtec.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.senal.name, ref: productCatalog.senal.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.arqueta.name, ref: productCatalog.arqueta.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.barraEquip.name, ref: productCatalog.barraEquip.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.pica.name, ref: productCatalog.pica.ref, qty: numRods * 3, unit: 'ud' });
                    
                    // L√≠neas materiales
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    
                    materials.forEach((mat, i) => {
                        if (i % 2 === 0) {
                            doc.setFillColor(250, 250, 250);
                            doc.rect(15, y - 3, pageWidth - 30, 7, 'F');
                        }
                        
                        doc.setTextColor(0, 0, 0);
                        doc.text(mat.name, 17, y + 1);
                        doc.text(mat.ref, 120, y + 1);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${mat.qty} ${mat.unit}`, 167, y + 1);
                        doc.setFont('helvetica', 'normal');
                        
                        y += 7;
                    });
                    
                    y += 8;
                    
                    // Protecci√≥ interna
                    doc.setFillColor(46, 134, 171);
                    doc.rect(15, y, pageWidth - 30, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PROTECCI√ì INTERNA (Recomanada segons RBT ITC-BT-23)', 17, y + 5.5);
                    
                    y += 12;
                    doc.setFillColor(250, 250, 250);
                    doc.rect(15, y - 3, pageWidth - 30, 7, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.text(productCatalog.protectorTri.name, 17, y + 1);
                    doc.text(productCatalog.protectorTri.ref, 120, y + 1);
                    doc.setFont('helvetica', 'bold');
                    doc.text('1 ud', 167, y + 1);
                    
                    // Notes al peu
                    y += 25;
                    doc.setFont('helvetica', 'italic');
                    doc.setFontSize(7);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Segons normativa UNE 21186:2011, NFC 17-102:2011, IEC 62305 i CTE DB SUA-8.', 15, y);
                    y += 4;
                    doc.text('INGESCO - Cardener 5, 08223 Terrassa (Barcelona) - Tel: 937 360 305 - ingesco.com', 15, y);
                }
                
                // Descarregar
                const filePrefix = pdfMode === 'image' ? 'Mapa' : 'Materials';
                const safeRef = clientRef.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
                doc.save(`${filePrefix}_${safeRef}_${today.replace(/\//g, '-')}.pdf`);
                
                closeBudgetPanel();
                
            } catch (error) {
                console.error('Error generant PDF:', error);
                alert('Error generant el PDF. Torna-ho a provar.');
            } finally {
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
            }
        }
        
        // ============================================
        // GENERAR TAULES
        // ============================================
        
        function generateTables() {
            for (const [type, data] of Object.entries(allModels)) {
                const tbody = document.querySelector(`#table${type.toUpperCase()} tbody`);
                tbody.innerHTML = '';
                
                for (const [name, model] of Object.entries(data.models)) {
                    const tr = document.createElement('tr');
                    tr.dataset.type = type;
                    tr.dataset.model = name;
                    tr.innerHTML = `
                        <td>${name.replace('PDC.E ', '').replace('PDC ', '').replace('AIR ', '')}</td>
                        <td>${model.dt}</td>
                        <td>${model.radii[1]}</td>
                        <td>${model.radii[2]}</td>
                        <td>${model.radii[3]}</td>
                        <td>${model.radii[4]}</td>
                    `;
                    tbody.appendChild(tr);
                }
            }
        }
        
        function highlightTableCell() {
            document.querySelectorAll('.legend-table td').forEach(td => td.classList.remove('highlight'));
            const row = document.querySelector(`tr[data-type="${currentType}"][data-model="${currentModel}"]`);
            if (row) {
                row.cells[0].classList.add('highlight');
                row.cells[currentLevel + 1].classList.add('highlight');
            }
        }
        
        // ============================================
        // EVENTOS DEL MAPA
        // ============================================
        
        map.on('click', e => {
            // Modo colocar pararrayos
            if (pararrayosMode && !drawingMode) {
                addMarker(e.latlng);
            }
            // Modo dibujar bajante
            else if (bajanteMode && !drawingMode) {
                if (!bajanteStart) {
                    // Primer clic: inicio de la bajante
                    bajanteStart = e.latlng;
                    updateInstruction('üìè Bajante: Clic en el punto final (toma de tierra)');
                } else {
                    // Segundo clic: fin de la bajante
                    addBajante(bajanteStart, e.latlng);
                    bajanteStart = null;
                    updateInstruction('üìè Bajante: Clic en el inicio (pararrayos)');
                }
            }
            // Modo toma de tierra
            else if (tierraMode && !drawingMode) {
                addTomaTierra(e.latlng);
            }
            // Actualizar densidad de rayos
            updateNgDisplay(e.latlng.lat, e.latlng.lng);
        });
        
        // ============================================
        // DIBUIX D'EDIFICIS
        // ============================================
        
        // Capa per edificis
        const buildingsLayer = new L.FeatureGroup();
        map.addLayer(buildingsLayer);
        
        // Configuraci√≥ Leaflet.draw amb mides
        const drawControlFull = new L.Control.Draw({
            position: 'topright',
            draw: {
                polyline: false,
                circle: false,
                circlemarker: false,
                marker: false,
                polygon: {
                    allowIntersection: false,
                    showArea: true,
                    showLength: true,
                    metric: true,
                    shapeOptions: {
                        color: '#3498db',
                        fillColor: '#3498db',
                        fillOpacity: 0.3,
                        weight: 2,
                        smoothFactor: 0
                    }
                },
                rectangle: {
                    showArea: true,
                    showLength: true,
                    metric: true,
                    shapeOptions: {
                        color: '#3498db',
                        fillColor: '#3498db',
                        fillOpacity: 0.3,
                        weight: 2,
                        smoothFactor: 0
                    }
                }
            },
            edit: {
                featureGroup: buildingsLayer,
                remove: true
            }
        });
        
        // Configurar idioma catal√† per les mides
        L.drawLocal.draw.handlers.polygon.tooltip.start = 'Clica per comen√ßar a dibuixar';
        L.drawLocal.draw.handlers.polygon.tooltip.cont = 'Clica per continuar dibuixant';
        L.drawLocal.draw.handlers.polygon.tooltip.end = 'Clica el primer punt per tancar';
        L.drawLocal.draw.handlers.rectangle.tooltip.start = 'Clica i arrossega per dibuixar';
        L.drawLocal.draw.handlers.simpleshape.tooltip.end = 'Deixa anar per finalitzar';
        
        function startDrawing(type) {
            // Cancel¬∑lar dibuix anterior si existeix
            if (currentDrawer) {
                currentDrawer.disable();
            }
            
            drawingMode = type;
            document.getElementById('drawIndicator').classList.add('show');
            document.getElementById('measureDisplay').classList.add('show');
            
            // Reiniciar valors de mides
            document.getElementById('measureWidth').textContent = '-';
            document.getElementById('measureHeight').textContent = '-';
            document.getElementById('measureArea').textContent = '-';
            document.getElementById('measurePerimeter').textContent = '-';
            
            document.querySelectorAll('.btn-draw').forEach(btn => btn.classList.remove('active'));
            
            if (type === 'rectangle') {
                document.getElementById('btnDrawRect').classList.add('active');
                currentDrawer = new L.Draw.Rectangle(map, drawControlFull.options.draw.rectangle);
            } else {
                document.getElementById('btnDrawPoly').classList.add('active');
                currentDrawer = new L.Draw.Polygon(map, drawControlFull.options.draw.polygon);
            }
            
            currentDrawer.enable();
        }
        
        function stopDrawing() {
            if (currentDrawer) {
                currentDrawer.disable();
                currentDrawer = null;
            }
            drawingMode = null;
            document.getElementById('drawIndicator').classList.remove('show');
            document.getElementById('measureDisplay').classList.remove('show');
            document.querySelectorAll('.btn-draw').forEach(btn => btn.classList.remove('active'));
        }
        
        // Event quan es crea un edifici
        map.on(L.Draw.Event.CREATED, function(e) {
            let layer = e.layer;
            
            // Guardar coordenades originals per evitar deformaci√≥
            if (layer instanceof L.Rectangle) {
                layer._originalBounds = layer.getBounds();
            } else {
                const latlngs = layer.getLatLngs();
                if (Array.isArray(latlngs[0])) {
                    layer._originalLatLngs = latlngs[0].map(ll => [ll.lat, ll.lng]);
                } else {
                    layer._originalLatLngs = latlngs.map(ll => [ll.lat, ll.lng]);
                }
            }
            
            layer.options.smoothFactor = 0;
            layer.options.noClip = true;
            
            buildingsLayer.addLayer(layer);
            buildings.push(layer);
            
            // Comprovar protecci√≥ i afegir popup
            updateBuildingProtection(layer);
            
            // Amagar mides
            document.getElementById('measureDisplay').classList.remove('show');
            
            stopDrawing();
        });
        
        // For√ßar redibuixat dels edificis quan canvia el zoom
        map.on('zoomend', function() {
            buildings.forEach(layer => {
                if (layer._originalLatLngs) {
                    const newLatLngs = layer._originalLatLngs.map(ll => L.latLng(ll[0], ll[1]));
                    layer.setLatLngs(newLatLngs);
                } else if (layer._originalBounds) {
                    layer.setBounds(layer._originalBounds);
                }
            });
        });
        
        // Event quan es dibuixa (temps real)
        map.on('draw:drawvertex', function(e) {
            updateLiveMeasurements();
        });
        
        // Actualitzar mides mentre es mou el ratol√≠ durant el dibuix
        map.on('mousemove', function(e) {
            // Actualitzar coordenades
            document.getElementById('currentCoords').textContent = 
                `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
            
            // Si estem dibuixant, actualitzar mides
            if (drawingMode && currentDrawer && currentDrawer._shape) {
                updateLiveMeasurementsFromShape(currentDrawer._shape, e.latlng);
            }
        });
        
        // Funci√≥ per actualitzar mides en temps real
        function updateLiveMeasurementsFromShape(shape, currentLatLng) {
            const measureDisplay = document.getElementById('measureDisplay');
            
            if (shape instanceof L.Rectangle) {
                measureDisplay.classList.add('show');
                const bounds = shape.getBounds();
                
                if (bounds.isValid()) {
                    const nw = bounds.getNorthWest();
                    const ne = bounds.getNorthEast();
                    const sw = bounds.getSouthWest();
                    
                    const width = Math.round(map.distance(nw, ne) * 10) / 10;
                    const height = Math.round(map.distance(nw, sw) * 10) / 10;
                    const area = Math.round(width * height * 10) / 10;
                    const perimeter = Math.round((width + height) * 2 * 10) / 10;
                    
                    document.getElementById('measureWidth').textContent = width + ' m';
                    document.getElementById('measureHeight').textContent = height + ' m';
                    document.getElementById('measureArea').textContent = area + ' m¬≤';
                    document.getElementById('measurePerimeter').textContent = perimeter + ' m';
                }
            } else if (shape instanceof L.Polygon) {
                measureDisplay.classList.add('show');
                let latlngs = shape.getLatLngs();
                if (latlngs.length > 0 && Array.isArray(latlngs[0])) {
                    latlngs = latlngs[0];
                }
                
                // Afegir punt actual si existeix
                if (currentLatLng && latlngs.length > 0) {
                    latlngs = [...latlngs, currentLatLng];
                }
                
                if (latlngs.length >= 2) {
                    let perimeter = 0;
                    for (let i = 0; i < latlngs.length; i++) {
                        const next = (i + 1) % latlngs.length;
                        perimeter += map.distance(latlngs[i], latlngs[next]);
                    }
                    perimeter = Math.round(perimeter * 10) / 10;
                    
                    const area = latlngs.length >= 3 ? Math.round(calculatePolygonArea(latlngs) * 10) / 10 : 0;
                    
                    document.getElementById('measureWidth').textContent = latlngs.length + ' punts';
                    document.getElementById('measureHeight').textContent = '-';
                    document.getElementById('measureArea').textContent = area + ' m¬≤';
                    document.getElementById('measurePerimeter').textContent = perimeter + ' m';
                }
            }
        }
        
        function updateLiveMeasurements() {
            if (currentDrawer && currentDrawer._shape) {
                updateLiveMeasurementsFromShape(currentDrawer._shape, null);
            }
        }
        
        // Event quan s'esborra un edifici
        map.on(L.Draw.Event.DELETED, function(e) {
            e.layers.eachLayer(layer => {
                const idx = buildings.indexOf(layer);
                if (idx > -1) buildings.splice(idx, 1);
            });
        });
        
        // Cancel¬∑lar amb ESC
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && drawingMode) {
                stopDrawing();
            }
        });
        
        // Comprovar si un punt est√† dins d'algun cercle de protecci√≥
        function isPointProtected(latlng) {
            for (const rod of lightningRods) {
                const center = rod.circle.getLatLng();
                const radius = rod.circle.getRadius();
                const distance = map.distance(latlng, center);
                if (distance <= radius) {
                    return true;
                }
            }
            return false;
        }
        
        // Comprovar si tot l'edifici est√† protegit
        function isBuildingProtected(layer) {
            if (lightningRods.length === 0) return false;
            
            let bounds;
            let points = [];
            
            if (layer instanceof L.Rectangle) {
                bounds = layer.getBounds();
                // Comprovar les 4 cantonades + centre
                points = [
                    bounds.getNorthWest(),
                    bounds.getNorthEast(),
                    bounds.getSouthWest(),
                    bounds.getSouthEast(),
                    bounds.getCenter()
                ];
            } else if (layer instanceof L.Polygon) {
                // Comprovar tots els v√®rtexs
                points = layer.getLatLngs()[0];
                // Afegir el centre
                bounds = layer.getBounds();
                points.push(bounds.getCenter());
            }
            
            // Tots els punts han d'estar protegits
            return points.every(point => isPointProtected(point));
        }
        
        // Actualizar visualizaci√≥n de protecci√≥n de un edificio
        function updateBuildingProtection(layer) {
            const isProtected = isBuildingProtected(layer);
            const color = isProtected ? '#27ae60' : '#e74c3c';
            const status = isProtected ? '‚úÖ PROTEGIDO' : '‚ö†Ô∏è FUERA DE COBERTURA';
            
            layer.setStyle({
                color: color,
                fillColor: color,
                fillOpacity: 0.3,
                weight: 3,
                smoothFactor: 0,
                noClip: true
            });
            
            const bounds = layer.getBounds();
            const measurements = calculateMeasurements(layer);
            
            let dimensionsHtml = '';
            if (layer instanceof L.Rectangle) {
                dimensionsHtml = `
                    <tr><td>Ancho:</td><td>${measurements.width} m</td></tr>
                    <tr><td>Alto:</td><td>${measurements.height} m</td></tr>
                    <tr><td>√Årea:</td><td>${measurements.area} m¬≤</td></tr>
                    <tr><td>Per√≠metro:</td><td>${measurements.perimeter} m</td></tr>
                `;
            } else {
                dimensionsHtml = `
                    <tr><td>√Årea:</td><td>${measurements.area} m¬≤</td></tr>
                    <tr><td>Per√≠metro:</td><td>${measurements.perimeter} m</td></tr>
                    <tr><td>V√©rtices:</td><td>${measurements.vertices}</td></tr>
                `;
            }
            
            layer.bindPopup(`
                <div class="popup-content">
                    <h3>üè¢ Edificio</h3>
                    <div style="font-size: 1.1em; font-weight: bold; color: ${color}; margin: 10px 0;">
                        ${status}
                    </div>
                    <table class="popup-table">
                        ${dimensionsHtml}
                    </table>
                    <button class="popup-delete" onclick="removeBuilding(${buildings.indexOf(layer)})">üóëÔ∏è Eliminar edificio</button>
                </div>
            `);
        }
        
        // Calcular mides detallades
        function calculateMeasurements(layer) {
            if (layer instanceof L.Rectangle) {
                const bounds = layer.getBounds();
                const nw = bounds.getNorthWest();
                const ne = bounds.getNorthEast();
                const sw = bounds.getSouthWest();
                
                const width = Math.round(map.distance(nw, ne) * 10) / 10;
                const height = Math.round(map.distance(nw, sw) * 10) / 10;
                const area = Math.round(width * height * 10) / 10;
                const perimeter = Math.round((width + height) * 2 * 10) / 10;
                
                return { width, height, area, perimeter };
            } else if (layer instanceof L.Polygon) {
                const latlngs = layer.getLatLngs()[0];
                let perimeter = 0;
                
                // Calcular per√≠metre
                for (let i = 0; i < latlngs.length; i++) {
                    const next = (i + 1) % latlngs.length;
                    perimeter += map.distance(latlngs[i], latlngs[next]);
                }
                perimeter = Math.round(perimeter * 10) / 10;
                
                // Calcular √†rea amb f√≥rmula de Shoelace
                const area = Math.round(calculatePolygonArea(latlngs) * 10) / 10;
                
                return { area, perimeter, vertices: latlngs.length };
            }
            
            return { area: 0, perimeter: 0 };
        }
        
        // Calcular √†rea d'un pol√≠gon usant coordenades geogr√†fiques
        function calculatePolygonArea(latlngs) {
            // Convertir a metres usant projecci√≥
            const earthRadius = 6371000; // metres
            let area = 0;
            
            if (latlngs.length < 3) return 0;
            
            // F√≥rmula de l'√†rea geod√®sica simplificada
            for (let i = 0; i < latlngs.length; i++) {
                const j = (i + 1) % latlngs.length;
                const xi = latlngs[i].lng * Math.PI / 180;
                const yi = latlngs[i].lat * Math.PI / 180;
                const xj = latlngs[j].lng * Math.PI / 180;
                const yj = latlngs[j].lat * Math.PI / 180;
                
                area += (xj - xi) * (2 + Math.sin(yi) + Math.sin(yj));
            }
            
            area = Math.abs(area * earthRadius * earthRadius / 2);
            return area;
        }
        
        // Esborrar un edifici
        window.removeBuilding = function(idx) {
            if (idx >= 0 && idx < buildings.length) {
                buildingsLayer.removeLayer(buildings[idx]);
                buildings.splice(idx, 1);
            }
        };
        
        // Actualitzar tots els edificis quan canvien els cercles
        function updateAllBuildingsProtection() {
            buildings.forEach(building => updateBuildingProtection(building));
        }
        
        // ============================================
        // INICIALIZACI√ìN
          // ============================================
        
        generateTables();
        populateModelSelect();
        updateDisplay();
        // No a√±adir pararrayos inicial - el usuario debe activar el modo primero
    </script>
</body>
</html>
