<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculador de Cobertura - Parallamps Ingesco</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
        
        #map { height: calc(100vh - 180px); width: 100%; }
        
        .header {
            background: linear-gradient(135deg, #1a5276 0%, #2e86ab 100%);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header h1 { font-size: 1.2em; }
        .header-info { font-size: 0.8em; opacity: 0.9; }
        
        .control-panel {
            background: white;
            padding: 10px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            align-items: center;
            border-bottom: 3px solid #2e86ab;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .control-group label {
            font-size: 0.75em;
            color: #555;
            font-weight: 600;
            white-space: nowrap;
        }
        .control-group select {
            padding: 6px 8px;
            border: 2px solid #2e86ab;
            border-radius: 5px;
            font-size: 0.8em;
            background: white;
            color: #1a5276;
            font-weight: 600;
            cursor: pointer;
        }
        
        .type-tabs {
            display: flex;
            gap: 3px;
            background: #e8f4f8;
            padding: 3px;
            border-radius: 6px;
        }
        .type-tab {
            padding: 5px 10px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: 600;
            transition: all 0.2s;
        }
        .type-tab.active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .type-tab.pdc { color: #3498db; }
        .type-tab.pdce { color: #9b59b6; }
        .type-tab.air { color: #e67e22; }
        
        .level-selector { display: flex; gap: 3px; }
        .level-btn {
            padding: 5px 10px;
            border: 2px solid #2e86ab;
            background: white;
            color: #2e86ab;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8em;
            transition: all 0.2s;
        }
        .level-btn.active { background: #2e86ab; color: white; }
        .level-btn:hover { background: #1a5276; color: white; border-color: #1a5276; }
        
        .info-display {
            background: #e8f4f8;
            padding: 5px 10px;
            border-radius: 5px;
            text-align: center;
        }
        .info-display .label { font-size: 0.6em; color: #666; text-transform: uppercase; }
        .info-display .value { font-size: 0.95em; font-weight: bold; color: #1a5276; }
        
        .search-container {
            display: flex;
            gap: 5px;
            position: relative;
        }
        .search-input {
            padding: 7px 10px;
            border: 2px solid #27ae60;
            border-radius: 5px;
            font-size: 0.8em;
            width: 260px;
        }
        .search-input:focus { outline: none; border-color: #1e8449; }
        .search-btn {
            padding: 7px 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .search-btn:hover { background: #1e8449; }
        .search-btn:disabled { background: #94a3b8; cursor: wait; }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 40px;
            background: white;
            border: 2px solid #27ae60;
            border-radius: 5px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
        }
        .search-results.show { display: block; }
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.8em;
        }
        .search-result-item:hover { background: #e8f8f0; }
        .search-result-item:last-child { border-bottom: none; }
        
        .clear-btn {
            padding: 5px 10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.75em;
        }
        .clear-btn:hover { background: #c0392b; }
        
        .instruction {
            background: #fff3cd;
            color: #856404;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.75em;
        }
        
        .legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 340px;
            font-size: 0.7em;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }
        .legend h4 {
            margin-bottom: 8px;
            color: #1a5276;
            font-size: 1.1em;
            position: sticky;
            top: 0;
            background: white;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .legend-section { margin-bottom: 8px; }
        .legend-section h5 {
            font-size: 0.9em;
            margin-bottom: 4px;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .legend-section.pdc h5 { background: #d6eaf8; color: #2874a6; }
        .legend-section.pdce h5 { background: #e8daef; color: #7d3c98; }
        .legend-section.air h5 { background: #fdebd0; color: #b9770e; }
        
        .legend-table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
        .legend-table th, .legend-table td {
            padding: 2px 4px;
            text-align: center;
            font-size: 0.85em;
            border: 1px solid #ddd;
        }
        .legend-table th { background: #34495e; color: white; }
        .legend-table .highlight { background: #d5f5e3 !important; font-weight: bold; }
        
        .coords-display {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 8px 10px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 0.75em;
        }
        
        .popup-content { text-align: center; min-width: 200px; }
        .popup-content h3 { color: #1a5276; margin-bottom: 8px; font-size: 1.1em; }
        .popup-table { width: 100%; font-size: 0.85em; margin-bottom: 8px; }
        .popup-table td { padding: 3px; }
        .popup-table td:first-child { text-align: left; color: #666; }
        .popup-table td:last-child { text-align: right; font-weight: bold; }
        .popup-delete {
            margin-top: 8px;
            padding: 5px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .popup-delete:hover { background: #c0392b; }
        
        .draggable-marker { cursor: grab !important; }
        .draggable-marker:active { cursor: grabbing !important; }
        .leaflet-marker-draggable { cursor: grab !important; }
        .leaflet-marker-dragging .draggable-marker div { 
            transform: scale(1.2); 
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));
        }
        
        @media (max-width: 900px) {
            .search-input { width: 180px; }
            .legend { max-width: 280px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚ö° Calculador de Cobertura - Parallamps Ingesco</h1>
        <div class="header-info">Segons UNE 21186:2011 / NFC 17-102:2011 / NP 4426:2013</div>
    </div>
    
    <div class="control-panel">
        <div class="control-group">
            <label>üì° Tipus:</label>
            <div class="type-tabs">
                <button class="type-tab pdc active" onclick="setType('pdc')">PDC</button>
                <button class="type-tab pdce" onclick="setType('pdce')">PDC.E</button>
                <button class="type-tab air" onclick="setType('air')">AIR</button>
            </div>
        </div>
        
        <div class="control-group">
            <label>Model:</label>
            <select id="modelSelect" onchange="updateModel()"></select>
        </div>
        
        <div class="control-group">
            <label>üõ°Ô∏è Nivell:</label>
            <div class="level-selector">
                <button class="level-btn active" onclick="setLevel(1)">I</button>
                <button class="level-btn" onclick="setLevel(2)">II</button>
                <button class="level-btn" onclick="setLevel(3)">III</button>
                <button class="level-btn" onclick="setLevel(4)">IV</button>
            </div>
        </div>
        
        <div class="info-display">
            <div class="label">Radi</div>
            <div class="value" id="radiusDisplay">80 m</div>
        </div>
        
        <div class="control-group">
            <div class="search-container">
                <input type="text" id="addressInput" class="search-input" placeholder="üîç Cercar adre√ßa o lloc...">
                <button class="search-btn" id="searchBtn" onclick="searchAddress()">Cercar</button>
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>
        
        <button class="clear-btn" onclick="clearAllMarkers()">üóëÔ∏è Esborrar tot</button>
        
        <div class="instruction">üëÜ Clic per afegir | ‚úã Arrossega per moure | üóëÔ∏è Clic al ‚ö° per esborrar</div>
    </div>
    
    <div id="map"></div>
    
    <div class="legend" id="legend">
        <h4>üìã Radis de Protecci√≥ (h=20m)</h4>
        
        <div class="legend-section pdc">
            <h5>PDC (No electr√≤nic)</h5>
            <table class="legend-table" id="tablePDC">
                <thead><tr><th>Model</th><th>Œît</th><th>I</th><th>II</th><th>III</th><th>IV</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div class="legend-section pdce">
            <h5>PDC.E (Electr√≤nic)</h5>
            <table class="legend-table" id="tablePDCE">
                <thead><tr><th>Model</th><th>Œît</th><th>I</th><th>II</th><th>III</th><th>IV</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div class="legend-section air">
            <h5>AIR (Electr√≤nic avan√ßat)</h5>
            <table class="legend-table" id="tableAIR">
                <thead><tr><th>Model</th><th>Œît</th><th>I</th><th>II</th><th>III</th><th>IV</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        
        <p style="margin-top: 8px; font-size: 0.85em; color: #666;">
            Radis en metres. Altura de refer√®ncia: 20m
        </p>
    </div>
    
    <div class="coords-display">
        <strong>üìç</strong> <span id="currentCoords">-</span>
    </div>

    <script>
        // ============================================
        // DADES DELS PARALLAMPS INGESCO
        // ============================================
        const allModels = {
            pdc: {
                name: 'PDC',
                color: '#3498db',
                models: {
                    'PDC 3.1': { dt: 15, radii: { 1: 35, 2: 43, 3: 54, 4: 63 } },
                    'PDC 3.3': { dt: 25, radii: { 1: 45, 2: 54, 3: 65, 4: 75 } },
                    'PDC 4.3': { dt: 34, radii: { 1: 54, 2: 63, 3: 74, 4: 85 } },
                    'PDC 5.3': { dt: 43, radii: { 1: 63, 2: 72, 3: 84, 4: 95 } },
                    'PDC 6.3': { dt: 54, radii: { 1: 74, 2: 83, 3: 95, 4: 106 } },
                    'PDC 6.4': { dt: 60, radii: { 1: 80, 2: 89, 3: 102, 4: 113 } }
                }
            },
            pdce: {
                name: 'PDC.E',
                color: '#9b59b6',
                models: {
                    'PDC.E 15': { dt: 15, radii: { 1: 35, 2: 43, 3: 54, 4: 63 } },
                    'PDC.E 30': { dt: 30, radii: { 1: 50, 2: 59, 3: 70, 4: 80 } },
                    'PDC.E 45': { dt: 45, radii: { 1: 65, 2: 74, 3: 86, 4: 97 } },
                    'PDC.E 60': { dt: 60, radii: { 1: 80, 2: 89, 3: 102, 4: 113 } }
                }
            },
            air: {
                name: 'AIR',
                color: '#e67e22',
                models: {
                    'AIR 20': { dt: 20, radii: { 1: 40, 2: 49, 3: 60, 4: 69 } },
                    'AIR 40': { dt: 40, radii: { 1: 60, 2: 69, 3: 80, 4: 91 } },
                    'AIR 60': { dt: 60, radii: { 1: 80, 2: 89, 3: 102, 4: 113 } }
                }
            }
        };
        
        // Estat actual
        let currentType = 'pdc';
        let currentModel = 'PDC 6.4';
        let currentLevel = 1;
        let markers = [];
        let circles = [];
        
        // Coordenades inicials
        const initialLat = 41.557323;
        const initialLng = 2.031215;
        
        // ============================================
        // INICIALITZAR MAPA
        // ============================================
        const map = L.map('map').setView([initialLat, initialLng], 17);
        
        // Capes base
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; Esri'
        });
        const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        });
        const labels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}');
        
        satellite.addTo(map);
        labels.addTo(map);
        
        L.control.layers({ "üõ∞Ô∏è Sat√®l¬∑lit": satellite, "üó∫Ô∏è Carrers": streets }).addTo(map);
        L.control.scale({ metric: true, imperial: false, position: 'bottomright' }).addTo(map);
        
        // ============================================
        // FUNCIONS PRINCIPALS
        // ============================================
        
        function getCurrentRadius() {
            return allModels[currentType].models[currentModel].radii[currentLevel];
        }
        
        function getCurrentColor() {
            return allModels[currentType].color;
        }
        
        function updateDisplay() {
            document.getElementById('radiusDisplay').textContent = getCurrentRadius() + ' m';
            highlightTableCell();
        }
        
        function populateModelSelect() {
            const select = document.getElementById('modelSelect');
            select.innerHTML = '';
            const models = allModels[currentType].models;
            
            for (const [name, data] of Object.entries(models)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (${data.dt}¬µs)`;
                select.appendChild(option);
            }
            
            // Seleccionar el model amb major Œît per defecte
            const modelNames = Object.keys(models);
            currentModel = modelNames[modelNames.length - 1];
            select.value = currentModel;
        }
        
        function setType(type) {
            currentType = type;
            
            // Actualitzar tabs
            document.querySelectorAll('.type-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.classList.contains(type)) tab.classList.add('active');
            });
            
            populateModelSelect();
            updateDisplay();
            updateAllCircles();
        }
        
        function updateModel() {
            currentModel = document.getElementById('modelSelect').value;
            updateDisplay();
            updateAllCircles();
        }
        
        function setLevel(level) {
            currentLevel = level;
            document.querySelectorAll('.level-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i + 1 === level);
            });
            updateDisplay();
            updateAllCircles();
        }
        
        function updateAllCircles() {
            const radius = getCurrentRadius();
            const color = getCurrentColor();
            
            circles.forEach(circle => {
                circle.setRadius(radius);
                circle.setStyle({ color: color, fillColor: color });
            });
            
            markers.forEach((marker, i) => updateMarkerPopup(marker, circles[i]));
        }
        
        // ============================================
        // GESTI√ì DE MARCADORS
        // ============================================
        
        function createLightningIcon() {
            return L.divIcon({
                html: '<div style="font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); cursor: grab; transition: transform 0.1s;" onmousedown="this.style.cursor=\'grabbing\'" onmouseup="this.style.cursor=\'grab\'">‚ö°</div>',
                iconSize: [28, 28],
                iconAnchor: [14, 14],
                className: 'draggable-marker'
            });
        }
        
        function updateMarkerPopup(marker, circle) {
            const latlng = marker.getLatLng();
            const model = allModels[currentType].models[currentModel];
            const radius = getCurrentRadius();
            const color = getCurrentColor();
            const idx = markers.indexOf(marker);
            
            marker.setPopupContent(`
                <div class="popup-content">
                    <h3>‚ö° Ingesco ${currentModel}</h3>
                    <table class="popup-table">
                        <tr><td>Tipus:</td><td style="color:${color}">${allModels[currentType].name}</td></tr>
                        <tr><td>Œît:</td><td>${model.dt} ¬µs</td></tr>
                        <tr><td>Nivell:</td><td>${['I','II','III','IV'][currentLevel-1]}</td></tr>
                        <tr><td>Radi:</td><td style="color:${color}">${radius} m</td></tr>
                    </table>
                    <hr style="border:none;border-top:1px solid #ddd;margin:8px 0;">
                    <div style="font-size:0.8em;color:#666;">
                        ${latlng.lat.toFixed(6)}¬∞N, ${latlng.lng.toFixed(6)}¬∞E
                    </div>
                    <div style="margin-top:10px; display:flex; gap:8px; justify-content:center;">
                        <button class="popup-delete" onclick="removeMarker(${idx})">üóëÔ∏è Esborrar</button>
                    </div>
                    <div style="font-size:0.7em; color:#999; margin-top:8px;">
                        ‚úã Arrossega per moure
                    </div>
                </div>
            `);
        }
        
        function addMarker(latlng, openPopup = true) {
            const radius = getCurrentRadius();
            const color = getCurrentColor();
            
            const circle = L.circle(latlng, {
                color: color,
                fillColor: color,
                fillOpacity: 0.2,
                radius: radius,
                weight: 3
            }).addTo(map);
            
            const marker = L.marker(latlng, { 
                icon: createLightningIcon(),
                draggable: true
            }).addTo(map);
            
            markers.push(marker);
            circles.push(circle);
            
            marker.bindPopup('');
            updateMarkerPopup(marker, circle);
            if (openPopup) marker.openPopup();
            
            marker.on('drag', e => circle.setLatLng(e.latlng));
            marker.on('dragend', () => updateMarkerPopup(marker, circle));
        }
        
        window.removeMarker = function(idx) {
            if (idx >= 0 && idx < markers.length) {
                map.removeLayer(markers[idx]);
                map.removeLayer(circles[idx]);
                markers.splice(idx, 1);
                circles.splice(idx, 1);
            }
        };
        
        function clearAllMarkers() {
            markers.forEach(m => map.removeLayer(m));
            circles.forEach(c => map.removeLayer(c));
            markers = [];
            circles = [];
        }
        
        // ============================================
        // CERCA PER ADRE√áA (Nominatim)
        // ============================================
        
        async function searchAddress() {
            const query = document.getElementById('addressInput').value.trim();
            if (!query) return;
            
            const btn = document.getElementById('searchBtn');
            const resultsDiv = document.getElementById('searchResults');
            
            btn.disabled = true;
            btn.textContent = '...';
            resultsDiv.classList.remove('show');
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`,
                    { headers: { 'Accept-Language': 'ca,es,en' } }
                );
                const results = await response.json();
                
                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div class="search-result-item" style="color:#999;">No s\'han trobat resultats</div>';
                } else {
                    resultsDiv.innerHTML = results.map((r, i) => `
                        <div class="search-result-item" onclick="selectAddress(${r.lat}, ${r.lon}, '${r.display_name.replace(/'/g, "\\'")}')">
                            üìç ${r.display_name}
                        </div>
                    `).join('');
                }
                resultsDiv.classList.add('show');
                
            } catch (error) {
                resultsDiv.innerHTML = '<div class="search-result-item" style="color:#e74c3c;">Error en la cerca</div>';
                resultsDiv.classList.add('show');
            }
            
            btn.disabled = false;
            btn.textContent = 'Cercar';
        }
        
        window.selectAddress = function(lat, lon, name) {
            const latlng = L.latLng(lat, lon);
            map.setView(latlng, 18);
            addMarker(latlng);
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('addressInput').value = '';
        };
        
        // Tancar resultats al clicar fora
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchResults').classList.remove('show');
            }
        });
        
        // Enter per cercar
        document.getElementById('addressInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchAddress();
        });
        
        // ============================================
        // GENERAR TAULES DE LA LLEGENDA
        // ============================================
        
        function generateTables() {
            for (const [type, data] of Object.entries(allModels)) {
                const tbody = document.querySelector(`#table${type.toUpperCase()} tbody`);
                tbody.innerHTML = '';
                
                for (const [name, model] of Object.entries(data.models)) {
                    const tr = document.createElement('tr');
                    tr.dataset.type = type;
                    tr.dataset.model = name;
                    tr.innerHTML = `
                        <td>${name.replace('PDC.E ', '').replace('PDC ', '').replace('AIR ', '')}</td>
                        <td>${model.dt}¬µs</td>
                        <td>${model.radii[1]}</td>
                        <td>${model.radii[2]}</td>
                        <td>${model.radii[3]}</td>
                        <td>${model.radii[4]}</td>
                    `;
                    tbody.appendChild(tr);
                }
            }
        }
        
        function highlightTableCell() {
            // Treure tots els highlights
            document.querySelectorAll('.legend-table td').forEach(td => td.classList.remove('highlight'));
            
            // Trobar la fila correcta
            const row = document.querySelector(`tr[data-type="${currentType}"][data-model="${currentModel}"]`);
            if (row) {
                row.cells[0].classList.add('highlight');
                row.cells[currentLevel + 1].classList.add('highlight');
            }
        }
        
        // ============================================
        // EVENTS DEL MAPA
        // ============================================
        
        map.on('click', e => addMarker(e.latlng));
        
        map.on('mousemove', e => {
            document.getElementById('currentCoords').textContent = 
                `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
        });
        
        // ============================================
        // INICIALITZACI√ì
        // ============================================
        
        generateTables();
        populateModelSelect();
        updateDisplay();
        
        // Afegir marcador inicial
        addMarker(L.latLng(initialLat, initialLng), false);
    </script>
</body>
</html>
