<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculador de Cobertura - Pararrayos Ingesco</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
        
        #map { height: calc(100vh - 220px); width: 100%; }
        
        .header {
            background: linear-gradient(135deg, #1a5276 0%, #2e86ab 100%);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header h1 { font-size: 1.2em; }
        .header-info { font-size: 0.8em; opacity: 0.9; }
        
        .control-panel {
            background: white;
            padding: 8px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            border-bottom: 3px solid #2e86ab;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .control-group label {
            font-size: 0.72em;
            color: #555;
            font-weight: 600;
            white-space: nowrap;
        }
        .control-group select, .control-group input {
            padding: 5px 8px;
            border: 2px solid #2e86ab;
            border-radius: 5px;
            font-size: 0.8em;
            background: white;
            color: #1a5276;
            font-weight: 600;
        }
        .control-group input[type="number"] { width: 70px; }
        
        .type-tabs {
            display: flex;
            gap: 2px;
            background: #e8f4f8;
            padding: 2px;
            border-radius: 5px;
        }
        .type-tab {
            padding: 4px 8px;
            border: none;
            background: transparent;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.72em;
            font-weight: 600;
            transition: all 0.2s;
        }
        .type-tab.active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .type-tab.pdc { color: #3498db; }
        .type-tab.pdce { color: #9b59b6; }
        .type-tab.air { color: #e67e22; }
        
        .level-selector { display: flex; gap: 2px; }
        .level-btn {
            padding: 4px 8px;
            border: 2px solid #2e86ab;
            background: white;
            color: #2e86ab;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.75em;
            transition: all 0.2s;
        }
        .level-btn.active { background: #2e86ab; color: white; }
        .level-btn:hover { background: #1a5276; color: white; border-color: #1a5276; }
        
        .info-display {
            background: #e8f4f8;
            padding: 4px 8px;
            border-radius: 5px;
            text-align: center;
        }
        .info-display .label { font-size: 0.55em; color: #666; text-transform: uppercase; }
        .info-display .value { font-size: 0.9em; font-weight: bold; color: #1a5276; }
        
        .search-container {
            display: flex;
            gap: 4px;
            position: relative;
        }
        .search-input {
            padding: 5px 8px;
            border: 2px solid #27ae60;
            border-radius: 5px;
            font-size: 0.75em;
            width: 200px;
        }
        .search-input:focus { outline: none; border-color: #1e8449; }
        .search-formats {
            font-size: 0.7em;
            color: #666;
            margin-top: 2px;
            padding: 0 5px;
        }
        .search-btn {
            padding: 5px 10px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75em;
        }
        .search-btn:hover { background: #1e8449; }
        .search-btn:disabled { background: #94a3b8; cursor: wait; }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 40px;
            background: white;
            border: 2px solid #27ae60;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
        }
        .search-results.show { display: block; }
        .search-result-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.75em;
        }
        .search-result-item:hover { background: #e8f8f0; }
        .search-result-item:last-child { border-bottom: none; }
        
        .btn-action {
            padding: 5px 10px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.72em;
        }
        .btn-clear { background: #e74c3c; }
        .btn-clear:hover { background: #c0392b; }
        .btn-pdf { background: #8e44ad; }
        .btn-pdf:hover { background: #7d3c98; }
        .btn-draw { background: #27ae60; }
        .btn-draw:hover { background: #1e8449; }
        .btn-draw.active { background: #1e8449; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }
        .btn-pararrayos { background: #e67e22; }
        .btn-pararrayos:hover { background: #d35400; }
        .btn-pararrayos.active { background: #d35400; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }
        .btn-bajante { background: #3498db; }
        .btn-bajante:hover { background: #2980b9; }
        .btn-bajante.active { background: #2980b9; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }
        .btn-tierra { background: #795548; }
        .btn-tierra:hover { background: #5d4037; }
        .btn-tierra.active { background: #5d4037; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }
        .btn-plano { background: #16a085; }
        .btn-plano:hover { background: #138d75; }
        .btn-plano.active { background: #138d75; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }
        
        .tierra-icon {
            background: transparent !important;
            border: none !important;
        }
        
        /* ============================================ */
        /* MODO PLANO - Estilos                        */
        /* ============================================ */
        
        #planoWrapper {
            height: calc(100vh - 220px);
            width: 100%;
            display: none;
            position: relative;
            overflow: hidden;
            background: #e0e0e0;
        }
        #planoWrapper.show { display: block; }
        
        #planoContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            cursor: grab;
        }
        #planoContainer:active { cursor: grabbing; }
        #planoContainer.crosshair { cursor: crosshair !important; }
        
        #planoInner {
            position: relative;
            transform-origin: 0 0;
        }
        
        #planoImage {
            display: block;
            max-width: none;
        }
        
        #planoCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        .plano-toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .plano-toolbar h4 { 
            color: #16a085; 
            font-size: 0.9em;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 3px;
        }
        .plano-toolbar .info-row {
            font-size: 0.8em;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .plano-toolbar .info-value { 
            font-weight: bold; 
            color: #1a5276; 
        }
        .plano-toolbar button {
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: 600;
            transition: all 0.2s;
        }
        .plano-btn-scale { background: #f39c12; color: white; }
        .plano-btn-scale:hover { background: #d68910; }
        .plano-btn-scale.active { background: #d68910; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }
        .plano-btn-exit { background: #e74c3c; color: white; }
        .plano-btn-exit:hover { background: #c0392b; }
        
        .plano-zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
        }
        .plano-zoom-btn {
            width: 36px;
            height: 36px;
            background: white;
            border: 2px solid #16a085;
            border-radius: 5px;
            font-size: 1.2em;
            font-weight: bold;
            color: #16a085;
            cursor: pointer;
            transition: all 0.2s;
        }
        .plano-zoom-btn:hover { background: #16a085; color: white; }
        
        .scale-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 3000;
            display: none;
            min-width: 320px;
        }
        .scale-panel.show { display: block; }
        .scale-panel h3 { color: #16a085; margin-bottom: 15px; text-align: center; }
        .scale-panel p { font-size: 0.9em; color: #666; margin-bottom: 15px; text-align: center; }
        .scale-panel input {
            width: 100%;
            padding: 12px;
            border: 2px solid #16a085;
            border-radius: 8px;
            font-size: 1.1em;
            text-align: center;
            margin-bottom: 15px;
        }
        .scale-panel .scale-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .scale-panel .scale-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .scale-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(243, 156, 18, 0.95);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.85em;
            z-index: 1000;
            display: none;
        }
        .scale-indicator.show { display: block; }
        
        .plano-mode-banner {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(22, 160, 133, 0.95);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85em;
            z-index: 1000;
        }
        
        /* Popup del plano para editar/eliminar elementos */
        .plano-popup {
            position: absolute;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            z-index: 1500;
            min-width: 220px;
            display: none;
            overflow: hidden;
        }
        .plano-popup.show { display: block; }
        .plano-popup-header {
            background: #1a5276;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .plano-popup-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            padding: 0 5px;
        }
        .plano-popup-body {
            padding: 12px 15px;
        }
        .plano-popup-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        .plano-popup-row label { color: #666; }
        .plano-popup-row span { font-weight: bold; color: #1a5276; }
        .plano-popup-row select {
            padding: 3px 6px;
            border: 2px solid #2e86ab;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: 600;
            color: #1a5276;
        }
        .plano-popup-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .plano-popup-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8em;
        }
        .plano-btn-delete { background: #e74c3c; color: white; }
        .plano-btn-delete:hover { background: #c0392b; }
        .plano-btn-edit { background: #2e86ab; color: white; }
        .plano-btn-edit:hover { background: #1a5276; }
        
        .draw-mode-indicator {
            position: fixed;
            top: 80px;
            left: 20px;
            background: rgba(39, 174, 96, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: bold;
            z-index: 2000;
            display: none;
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
        }
        .draw-mode-indicator.show { display: block; }
        
        .building-protected { 
            stroke: #27ae60 !important; 
            fill: #27ae60 !important; 
        }
        .building-unprotected { 
            stroke: #e74c3c !important; 
            fill: #e74c3c !important; 
        }
        
        .ng-display {
            background: linear-gradient(135deg, #1a5276, #2874a6);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 8px 0;
            text-align: center;
        }
        .ng-title {
            font-size: 0.75em;
            opacity: 0.9;
            margin-bottom: 3px;
        }
        .ng-value {
            font-size: 1.8em;
            font-weight: bold;
        }
        .ng-desc {
            font-size: 0.7em;
            opacity: 0.8;
        }
        .ng-risk {
            font-size: 0.75em;
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        .ng-risk.low { background: #27ae60; }
        .ng-risk.medium { background: #f39c12; }
        .ng-risk.high { background: #e74c3c; }
        .ng-risk.very-high { background: #8e44ad; }
        
        .instruction {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.7em;
        }
        
        /* Panel pressupost */
        .budget-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 3000;
            max-width: 500px;
            width: 90%;
            display: none;
        }
        .budget-panel.show { display: block; }
        .budget-panel h3 { color: #1a5276; margin-bottom: 15px; text-align: center; }
        .budget-form { display: flex; flex-direction: column; gap: 12px; }
        .budget-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .budget-row label { font-size: 0.9em; color: #333; flex: 1; }
        .budget-row input, .budget-row select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
            width: 150px;
        }
        .budget-row .calculated {
            background: #e8f4f8;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
            color: #1a5276;
            min-width: 100px;
            text-align: center;
        }
        .budget-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        .budget-buttons button {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
        }
        .btn-generate { background: #27ae60; color: white; }
        .btn-generate:hover { background: #1e8449; }
        .btn-cancel { background: #95a5a6; color: white; }
        .btn-cancel:hover { background: #7f8c8d; }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2999;
            display: none;
        }
        .overlay.show { display: block; }
        
        .discount-option {
            display: flex;
            gap: 10px;
        }
        .discount-option label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .discount-option input[type="radio"] { display: none; }
        .discount-option input[type="radio"]:checked + label {
            border-color: #2e86ab;
            background: #e8f4f8;
        }
        
        .legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 320px;
            font-size: 0.68em;
            max-height: calc(100vh - 290px);
            overflow-y: auto;
        }
        .legend h4 {
            margin-bottom: 6px;
            color: #1a5276;
            font-size: 1em;
            position: sticky;
            top: 0;
            background: white;
            padding-bottom: 4px;
            border-bottom: 1px solid #eee;
        }
        .legend-section { margin-bottom: 6px; }
        .legend-section h5 {
            font-size: 0.85em;
            margin-bottom: 3px;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .legend-section.pdc h5 { background: #d6eaf8; color: #2874a6; }
        .legend-section.pdce h5 { background: #e8daef; color: #7d3c98; }
        .legend-section.air h5 { background: #fdebd0; color: #b9770e; }
        
        .legend-table { width: 100%; border-collapse: collapse; }
        .legend-table th, .legend-table td {
            padding: 2px 3px;
            text-align: center;
            font-size: 0.85em;
            border: 1px solid #ddd;
        }
        .legend-table th { background: #34495e; color: white; }
        .legend-table .highlight { background: #d5f5e3 !important; font-weight: bold; }
        
        .coords-display {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 0.72em;
        }
        
        .measure-display {
            position: absolute;
            top: 70px;
            right: 10px;
            background: rgba(52, 152, 219, 0.95);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
            z-index: 1500;
            font-size: 0.85em;
            display: none;
            min-width: 150px;
        }
        .measure-display.show { display: block; }
        .measure-display h4 { 
            margin-bottom: 8px; 
            font-size: 0.9em;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 5px;
        }
        .measure-display .measure-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }
        .measure-display .measure-value {
            font-weight: bold;
        }
        
        .popup-content { text-align: center; min-width: 200px; }
        .popup-content h3 { color: #1a5276; margin-bottom: 8px; font-size: 1.1em; }
        .popup-table { width: 100%; font-size: 0.85em; margin-bottom: 8px; }
        .popup-table td { padding: 3px; }
        .popup-table td:first-child { text-align: left; color: #666; }
        .popup-table td:last-child { text-align: right; font-weight: bold; }
        .popup-delete {
            margin-top: 8px;
            padding: 5px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .popup-delete:hover { background: #c0392b; }
        
        .draggable-marker { cursor: grab !important; }
        .draggable-marker:active { cursor: grabbing !important; }
        .leaflet-marker-draggable { cursor: grab !important; }
        
        @media (max-width: 900px) {
            .search-input { width: 150px; }
            .legend { max-width: 260px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚ö° Calculador de Cobertura - Pararrayos Ingesco</h1>
        <div class="header-info">Seg√∫n UNE 21186:2011 / NFC 17-102:2011</div>
    </div>
    
    <div class="control-panel">
        <div class="control-group">
            <label>üì° Tipo:</label>
            <div class="type-tabs">
                <button class="type-tab pdc active" onclick="setType('pdc')">PDC</button>
                <button class="type-tab pdce" onclick="setType('pdce')">PDC.E</button>
                <button class="type-tab air" onclick="setType('air')">AIR</button>
            </div>
        </div>
        
        <div class="control-group">
            <label>Modelo:</label>
            <select id="modelSelect" onchange="updateModel()"></select>
        </div>
        
        <div class="control-group">
            <label>üõ°Ô∏è Nivel:</label>
            <div class="level-selector">
                <button class="level-btn active" onclick="setLevel(1)">I</button>
                <button class="level-btn" onclick="setLevel(2)">II</button>
                <button class="level-btn" onclick="setLevel(3)">III</button>
                <button class="level-btn" onclick="setLevel(4)">IV</button>
            </div>
        </div>
        
        <div class="info-display">
            <div class="label">Radio</div>
            <div class="value" id="radiusDisplay">80 m</div>
        </div>
        
        <div class="control-group">
            <div class="search-container">
                <input type="text" id="addressInput" class="search-input" placeholder="üîç Direcci√≥n, coords decimales, DMS o UTM...">
                <div class="search-formats">Formatos: Direcci√≥n | 41.395, 2.175 | 41¬∞23'45"N 2¬∞10'30"E | 31T 431234 4591234</div>
                <button class="search-btn" id="searchBtn" onclick="searchAddress()">Buscar</button>
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>
        
        <button class="btn-action btn-pararrayos" id="btnPararrayos" onclick="togglePararrayosMode()">‚ö° Colocar Pararrayos</button>
        <button class="btn-action btn-bajante" id="btnBajante" onclick="toggleBajanteMode()">üìè Dibujar Bajante</button>
        <button class="btn-action btn-tierra" id="btnTierra" onclick="toggleTierraMode()">√¢¬è≈° Toma de Tierra</button>
        <button class="btn-action btn-draw" id="btnDrawRect" onclick="startDrawing('rectangle')">üè¢ Edificio</button>
        <button class="btn-action btn-draw" id="btnDrawPoly" onclick="startDrawing('polygon')">√¢≈ì¬èÔ∏è Pol√≠gono</button>
        <button class="btn-action btn-plano" id="btnPlano" onclick="openPlanoFileDialog()">üìÑ Cargar Plano</button>
        <button class="btn-action btn-pdf" onclick="openBudgetPanel('image')">üó∫Ô∏è Imprimir Mapa</button>
        <button class="btn-action btn-pdf" onclick="openBudgetPanel('full')">üìÑ Mapa y Lista de Materiales</button>
        <button class="btn-action btn-clear" onclick="clearAllMarkers()">üóëÔ∏è Borrar todo</button>
        
        <!-- Input oculto para cargar plano -->
        <input type="file" id="planoFileInput" accept="image/*" style="display:none;" onchange="loadPlanoFile(event)">
        
        <!-- Densidad de rayos -->
        <div class="ng-display" id="ngDisplay">
            <div class="ng-title">‚õàÔ∏è Densidad de rayos (Ng)</div>
            <div class="ng-value" id="ngValue">-</div>
            <div class="ng-desc" id="ngDesc">Clic en el mapa para ver</div>
            <div class="ng-risk" id="ngRisk"></div>
        </div>
        
        <div class="instruction" id="instruction">‚ö° Activa "Colocar Pararrayos" para a√±adir | üè¢ Dibuja edificios para verificar cobertura</div>
    </div>
    
    <div id="map"></div>
    
    <!-- Contenedor del Plano (modo alternativo) -->
    <div id="planoWrapper">
        <div id="planoContainer">
            <div id="planoInner">
                <img id="planoImage" src="" alt="Plano">
                <canvas id="planoCanvas"></canvas>
            </div>
        </div>
        
        <!-- Toolbar del plano -->
        <div class="plano-toolbar" id="planoToolbar">
            <h4>üìÑ Modo Plano</h4>
            <div class="info-row">
                <span>Escala:</span>
                <span class="info-value" id="planoScaleDisplay">No definida</span>
            </div>
            <div class="info-row">
                <span>Pararrayos:</span>
                <span class="info-value" id="planoRodCount">0</span>
            </div>
            <div class="info-row">
                <span>Zoom:</span>
                <span class="info-value" id="planoZoomDisplay">100%</span>
            </div>
            <hr style="border:none;border-top:1px solid #ddd;margin:5px 0;">
            <button class="plano-btn-scale" id="btnPlanoScale" onclick="startPlanoScale()">üìè Definir Escala</button>
            <button class="plano-btn-exit" onclick="exitPlanoMode()">‚úñ Volver al Mapa</button>
        </div>
        
        <!-- Controles de zoom -->
        <div class="plano-zoom-controls">
            <button class="plano-zoom-btn" onclick="planoZoom(1.2)">+</button>
            <button class="plano-zoom-btn" onclick="planoZoom(0.8)">‚àí</button>
            <button class="plano-zoom-btn" onclick="planoZoom('fit')">‚ä°</button>
        </div>
        
        <!-- Indicador de escala -->
        <div class="scale-indicator" id="scaleIndicator">
            üìè Clic en el punto INICIAL de la l√≠nea de referencia
        </div>
        
        <!-- Banner modo -->
        <div class="plano-mode-banner">üìÑ MODO PLANO - Dibuja sobre la imagen</div>
        
        <!-- Popup para editar/eliminar elementos del plano -->
        <div class="plano-popup" id="planoPopup">
            <div class="plano-popup-header">
                <span id="planoPopupTitle">‚ö° Pararrayos</span>
                <button class="plano-popup-close" onclick="closePlanoPopup()">‚úï</button>
            </div>
            <div class="plano-popup-body" id="planoPopupBody">
                <!-- Se rellena din√°micamente -->
            </div>
        </div>
    </div>
    
    <!-- Panel para definir metros de escala -->
    <div class="scale-panel" id="scalePanel">
        <h3>üìè Definir Escala</h3>
        <p>Has dibujado una l√≠nea de <strong id="scalePixelsDisplay">0</strong> p√≠xeles.</p>
        <p>¬øCu√°ntos metros representa esta l√≠nea en la realidad?</p>
        <input type="number" id="scaleMetersInput" placeholder="Metros..." min="0.1" step="0.1" value="10">
        <div class="scale-buttons">
            <button class="btn-cancel" onclick="cancelPlanoScale()">Cancelar</button>
            <button class="btn-generate" onclick="confirmPlanoScale()">‚úÖ Confirmar</button>
        </div>
    </div>
    
    <!-- Indicador modo dibujo -->
    <div class="draw-mode-indicator" id="drawIndicator">
        üè¢ Modo dibujo activo - Clic en el mapa para dibujar
        <br><small>ESC para cancelar</small>
    </div>
    
    <!-- Panel Presupuesto -->
    <div class="overlay" id="overlay" onclick="closeAllPanels()"></div>
    <div class="budget-panel" id="budgetPanel">
        <h3 id="budgetPanelTitle">üìÑ Generar PDF</h3>
        <div class="budget-form">
            <div class="budget-row">
                <label>üåê Idioma del PDF:</label>
                <select id="langSelect" onchange="setLanguage(this.value)" style="padding:6px 10px;border:2px solid #2e86ab;border-radius:5px;font-size:0.9em;font-weight:600;color:#1a5276;">
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="en">üá¨üáß English</option>
                    <option value="fr">üá´üá∑ Fran√ßais</option>
                    <option value="pt">üáµüáπ Portugu√™s</option>
                </select>
            </div>
            <div class="budget-row">
                <label>N¬∫ Proyecto:</label>
                <input type="text" id="projectNumber" placeholder="175642/173685...">
            </div>
            <div class="budget-row">
                <label>Empresa:</label>
                <input type="text" id="companyName" placeholder="Nombre empresa...">
            </div>
            <div class="budget-row">
                <label>Modelo seleccionado:</label>
                <div class="calculated" id="budgetModel">PDC 6.4</div>
            </div>
            <div class="budget-row">
                <label>Referencia proyecto:</label>
                <input type="text" id="clientRef" placeholder="Nombre proyecto...">
            </div>
            
            <!-- Campos solo para presupuesto -->
            <div id="budgetOnlyFields">
                <div class="budget-row">
                    <label>Altura edificio (m):</label>
                    <input type="number" id="buildingHeight" value="10" min="2" max="100" onchange="updateBudgetCalc()">
                </div>
                <div class="budget-row">
                    <label>Metros cable bajada:</label>
                    <div class="calculated" id="cableMeters">15 m</div>
                </div>
                <div class="budget-row">
                    <label>Abrazaderas necesarias:</label>
                    <div class="calculated" id="clampCount">45 uds</div>
                </div>
                <div class="budget-row">
                    <label>Tipo de descuento:</label>
                </div>
                <div class="budget-row" style="justify-content: center;">
                    <div class="discount-option">
                        <input type="radio" name="discount" id="discInstaller" value="installer" checked>
                        <label for="discInstaller">üîß Instalador<br><small>(40+7)</small></label>
                        <input type="radio" name="discount" id="discDistributor" value="distributor">
                        <label for="discDistributor">üè™ Distribuidor<br><small>(50+7)</small></label>
                    </div>
                </div>
            </div>
        </div>
        <div class="budget-buttons">
            <button class="btn-cancel" onclick="closeBudgetPanel()">Cancelar</button>
            <button class="btn-generate" id="generatePdfBtn" onclick="generatePDF()">üì• Generar PDF</button>
        </div>
    </div>
    
    <div class="legend" id="legend">
        <h4>üìã Radios de Protecci√≥n (h=20m)</h4>
        
        <div class="legend-section pdc">
            <h5>PDC (No electr√≥nico)</h5>
            <table class="legend-table" id="tablePDC">
                <thead><tr><th>Modelo</th><th>√é‚Äùt</th><th>I</th><th>II</th><th>III</th><th>IV</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div class="legend-section pdce">
            <h5>PDC.E (Electr√≥nico)</h5>
            <table class="legend-table" id="tablePDCE">
                <thead><tr><th>Modelo</th><th>√é‚Äùt</th><th>I</th><th>II</th><th>III</th><th>IV</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div class="legend-section air">
            <h5>AIR (Electr√≥nico avanzado)</h5>
            <table class="legend-table" id="tableAIR">
                <thead><tr><th>Modelo</th><th>√é‚Äùt</th><th>I</th><th>II</th><th>III</th><th>IV</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div class="coords-display">
        <strong>üìç</strong> <span id="currentCoords">-</span>
    </div>
    
    <div class="measure-display" id="measureDisplay">
        <h4>üìê Medidas</h4>
        <div class="measure-row">
            <span>Ancho:</span>
            <span class="measure-value" id="measureWidth">-</span>
        </div>
        <div class="measure-row">
            <span>Alto:</span>
            <span class="measure-value" id="measureHeight">-</span>
        </div>
        <div class="measure-row">
            <span>√Årea:</span>
            <span class="measure-value" id="measureArea">-</span>
        </div>
        <div class="measure-row">
            <span>Per√≠metro:</span>
            <span class="measure-value" id="measurePerimeter">-</span>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ============================================
        // DATOS DE LOS PARARRAYOS INGESCO
        // ============================================
        const allModels = {
            pdc: {
                name: 'PDC',
                color: '#3498db',
                models: {
                    'PDC 3.1': { dt: 15, ref: '101000', radii: { 1: 35, 2: 45, 3: 60, 4: 75 }, price: 891.00 },
                    'PDC 3.3': { dt: 30, ref: '101001', radii: { 1: 50, 2: 60, 3: 75, 4: 90 }, price: 950.00 },
                    'PDC 3.4': { dt: 40, ref: '101003', radii: { 1: 60, 2: 70, 3: 85, 4: 100 }, price: 1020.00 },
                    'PDC 6.3': { dt: 54, ref: '101008', radii: { 1: 74, 2: 84, 3: 99, 4: 114 }, price: 1150.00 },
                    'PDC 6.4': { dt: 60, ref: '101009', radii: { 1: 80, 2: 90, 3: 105, 4: 120 }, price: 1250.00 }
                }
            },
            pdce: {
                name: 'PDC.E',
                color: '#9b59b6',
                models: {
                    'PDC.E 15': { dt: 15, ref: '102004', radii: { 1: 35, 2: 45, 3: 60, 4: 75 }, price: 920.00 },
                    'PDC.E 30': { dt: 30, ref: '102005', radii: { 1: 50, 2: 60, 3: 75, 4: 90 }, price: 980.00 },
                    'PDC.E 45': { dt: 45, ref: '102006', radii: { 1: 65, 2: 75, 3: 90, 4: 105 }, price: 1080.00 },
                    'PDC.E 60': { dt: 60, ref: '102007', radii: { 1: 80, 2: 90, 3: 105, 4: 120 }, price: 1180.00 }
                }
            },
            air: {
                name: 'AIR',
                color: '#e67e22',
                models: {
                    'AIR 20': { dt: 20, ref: '103020', radii: { 1: 40, 2: 50, 3: 65, 4: 80 }, price: 1100.00 },
                    'AIR 40': { dt: 40, ref: '103040', radii: { 1: 60, 2: 70, 3: 85, 4: 100 }, price: 1250.00 },
                    'AIR 60': { dt: 60, ref: '103060', radii: { 1: 80, 2: 90, 3: 105, 4: 120 }, price: 1400.00 }
                }
            }
        };
        
        // Cat√°logo de productos
        const productCatalog = {
            piezaAdapt: { name: 'Pieza adapt. 1\'1/4" √ÉÀú20 redondo', ref: '111011', price: 60.90, disc1: '30+5', disc2: '40+5' },
            mastil6m: { name: 'M√°stil 6m √ò1\'1/2"+ √ò1\'1/4 Ac. Galv.', ref: '114065', price: 226.60, disc1: '30+5', disc2: '40+5' },
            mastil4m: { name: 'M√°stil 4m √ò1\'1/2"+ √ò1\'1/4 Ac. Galv.', ref: '114045', price: 180.00, disc1: '30+5', disc2: '40+5' },
            anclaje: { name: 'Anclaje Placa V6 15 √ÉÀú1\'1/4"-2"', ref: '112158', price: 72.10, disc1: '30+0', disc2: '40+0' },
            abrazadera: { name: 'Abraz. abat. M8 cable 50-70mm¬≤', ref: '118109', price: 6.00, disc1: '30+0', disc2: '40+0' },
            contador: { name: 'Contador de rayos CDR-11', ref: '430019', price: 359.90, disc1: '40+7', disc2: '50+7' },
            tuboProtec: { name: 'Tubo protecci√≥n Ac. Galv. 2m √ò32mm', ref: '119109', price: 28.50, disc1: '30+0', disc2: '40+0' },
            senal: { name: 'Se√±alizaci√≥n pararrayos PVC', ref: '256003', price: 33.30, disc1: '30+5', disc2: '40+5' },
            arqueta: { name: 'Arqueta sin fondo 30x30 tapa PP', ref: '253058', price: 66.50, disc1: '40+7', disc2: '50+7' },
            barraEquip: { name: 'Barra equipot. arqueta 3 bornes', ref: '250027', price: 43.90, disc1: '30+0', disc2: '40+0' },
            pica: { name: 'Pica Ac. Cobre 2m √ò14,2mm 254¬µm', ref: '252124', price: 36.70, disc1: '10+10', disc2: '20+10' },
            cableCobre: { name: 'Cable cobre desnudo 50mm¬≤ (por metro)', ref: '116050', price: 12.50, disc1: '30+0', disc2: '40+0' },
            protectorTri: { name: 'Protector sobretensiones T1+T2 3F', ref: '370242', price: 392.00, disc1: '40+7', disc2: '50+7' }
        };
        
        
        
        // ============================================
        // IMATGES EMBEGUDES PER AL PDF
        // ============================================
        const INGESCO_LOGO_B64 = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAA0JCgsKCA0LCwsPDg0QFCEVFBISFCgdHhghMCoyMS8qLi00O0tANDhHOS0uQllCR05QVFVUMz9dY1xSYktTVFH/2wBDAQ4PDxQRFCcVFSdRNi42UVFRUVFRUVFRUVFRUVFRUVFRUVFRUVFRUVFRUVFRUVFRUVFRUVFRUVFRUVFRUVFRUVH/wAARCADsA10DASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD0aiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAoJAGScAVha94qsNHBjLefc/wDPJD0+p7V55q/ijVNVYiSYxQ9o4+B+PrVxg2Jysej6l4o0jTiVluhJIP4IvmP+Fc3efETkrZ2P0aRv6CuCorVU0iOZnTT+OtblzteGIf7Cf41UbxdrzHP9oOPYKv8AhWJRVcq7CuzdTxhrydb4t/vKP8KvW/j7VoyBKkEo91IP865SijlXYLs9GsfiFZyEC8tJIf8AaQ7h/SumsNY07UVzaXcch/u5wfyNeJ06OR4nDxuyMOhU4IqXTXQakz3iivMNE8cX9kVivf8ASoBxk/fA+vevQdL1ay1aDzbOYP8A3lPDL9RWMouJady9RRRUjCiiigAooooAKqXtvdTsht7wwADkBc5q3RQBkeH7m4uI5/tEpkKOACRinaxd3EctvaWrbJJzjf6CofDP3Lr/AK6f0q1q2nPeCOWGTy54jlCelAFG8S90mNbpbxp0DAOjjrWndR3N3BE1pc+RnknbnIrC1n+1Hhihu3h+d8KkfVj6mumgTy4ET+6oFAHP339qWjwxjUfMklbaFCAfjWvd/bIrJVtQJZ+AWb+dULI/b9dmuTzHANqemen+NbZ6UAc/fDUdOt1uW1DzHyAYyvB+lb0TF4kdhgkAkelYOo6bPBE1+180ksXzDeox9K19OuGurGKdxhmXJoAs0UUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRUN1dW9nF5lzMkSerHGaAJqKyh4i0knBuioPRmjcA/iRWnFLHNGJInV0bkMpyDTs0A6iiikAUUUUAFFFFABRRRQAUUUUAIxCqWYgAckntXBeKvGh3PZaU+AOHnH8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mCLDH+I8mn3tnFfQCKbO3O7g4qxRQBVsbCCwRlgDYY5OTmoLrRbK6naaRGDt12nGa0aKAI4oUigWBRlFG3B54rOm8PWEjFlRkJ/unitWigDPtNGsrSQSJGWcdCxzitCiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/2Q==';
        const INSTALL_DIAGRAM_B64 = 'data:image/jpeg;base64,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';
        
// ============================================
        // SISTEMA DE TRADUCCIONES / TRANSLATIONS
        // ============================================
        let currentLang = 'es';
        
        const translations = {
            es: {
                header_title: '‚ö° Calculador de Cobertura - Pararrayos Ingesco',
                header_norm: 'Seg√∫n UNE 21186:2011 / NFC 17-102:2011',
                btn_place_rod: '‚ö° Colocar Pararrayos',
                btn_draw_bajante: 'üìê Dibujar Bajante',
                btn_ground: '‚èö Toma de Tierra',
                btn_building: 'üè¢ Edificio',
                btn_polygon: '‚úèÔ∏è Pol√≠gono',
                btn_load_plan: 'üìÑ Cargar Plano',
                btn_print_map: 'üó∫Ô∏è Imprimir Mapa',
                btn_map_materials: 'üìÑ Mapa y Lista de Materiales',
                btn_clear: 'üóëÔ∏è Borrar todo',
                label_type: 'üì° Tipo:',
                label_model: 'Modelo:',
                label_level: 'üõ°Ô∏è Nivel:',
                label_radius: 'Radio',
                label_ng: '‚õàÔ∏è Densidad de rayos (Ng)',
                ng_click: 'Clic en el mapa para ver',
                search_placeholder: 'üîç Direcci√≥n, coords decimales, DMS o UTM...',
                instruction_default: '‚ö° Activa "Colocar Pararrayos" para a√±adir | üè¢ Dibuja edificios para verificar cobertura',
                // PDF fields
                pdf_project_num: 'N¬∫ Proyecto:',
                pdf_company: 'Empresa:',
                pdf_model_selected: 'Modelo seleccionado:',
                pdf_project_ref: 'Referencia proyecto:',
                pdf_building_height: 'Altura edificio (m):',
                pdf_cable_meters: 'Metros cable bajada:',
                pdf_clamps: 'Abrazaderas necesarias:',
                pdf_discount_type: 'Tipo de descuento:',
                // PDF document strings
                pdf_title: 'Estudio de protecci√≥n contra descargas atmosf√©ricas',
                pdf_project: 'Proyecto:',
                pdf_empresa: 'Empresa:',
                pdf_num_installations: 'N√∫mero de instalaciones de pararrayos:',
                pdf_coverage_plan: 'Plano de cobertura',
                pdf_legend: 'Leyenda:',
                pdf_legend_text: '√Årea azul: √Årea de protecci√≥n del pararrayos de acuerdo con las normas NP 4426:2013/UNE 21.186:2011/NFC 17-102:2011.',
                pdf_model_col: 'Modelo',
                pdf_type_col: 'Tipo',
                pdf_dt_col: 'Œît',
                pdf_level_col: 'Nivel',
                pdf_radius_col: 'Radio',
                pdf_coords_col: 'Coordenadas',
                pdf_position_col: 'Posici√≥n',
                pdf_level_names: {1: 'I (Alto)', 2: 'II (Medio)', 3: 'III (Bajo)', 4: 'IV (M√≠nimo)'},
                pdf_on_plan: '(Sobre plano)',
                pdf_no_rods: 'No hay pararrayos colocados.',
                pdf_rods_installed: 'PARARRAYOS INSTALADOS',
                pdf_coverage_map: 'MAPA DE COBERTURA',
                pdf_coverage_plan_title: 'PLANO DE COBERTURA',
                pdf_norms: 'Seg√∫n UNE 21186:2011 / NFC 17-102:2011 / NP 4426:2013',
                pdf_scale_info: 'Escala del plano: 1m =',
                pdf_pixels: 'p√≠xeles',
                pdf_materials_title: 'Lista de Materiales',
                pdf_ext_protection: 'PROTECCI√ìN EXTERNA',
                pdf_material: 'Material',
                pdf_reference: 'Referencia',
                pdf_quantity: 'Cantidad',
                pdf_int_protection: 'PROTECCI√ìN INTERNA (Recomendada seg√∫n RBT ITC-BT-23)',
                pdf_date: 'Fecha:',
                // Installation instructions
                inst_title: 'Instrucciones de instalaci√≥n de un sistema de pararrayos',
                inst_rod_title: 'PARARRAYOS',
                inst_rod_1: 'Fijar el eje central del terminal a√©reo de captaci√≥n a la pieza adaptadora del m√°stil.',
                inst_rod_2: 'Pasar el conductor de bajada por el interior del m√°stil y conectarlo a la base del adaptador, fij√°ndolo con dos tornillos Allen.',
                inst_rod_3: 'Introducir el adaptador en el interior del m√°stil y fijarlo con el tornillo correspondiente.',
                inst_rod_4: 'Conectar todas las estructuras met√°licas que se encuentren dentro de la distancia de seguridad utilizando centelladores.',
                inst_down_title: 'CONDUCTOR DE BAJADA',
                inst_down_1: 'Fijar el m√°stil a la estructura utilizando el soporte m√°s adecuado y, si es necesario, fijar el m√°stil a la cubierta mediante cinchas de anclaje.',
                inst_down_2: 'Fijar el conductor de bajada con soportes de fijaci√≥n, asegur√°ndose de que est√°n bien apretados y utilizando, como referencia, tres fijaciones por metro.',
                inst_down_3: 'Instalar el contador de rayos en la parte inferior del conductor, dos o tres metros por encima del suelo.',
                inst_down_4: 'Proteger la parte inferior del conductor de bajada con un tubo de protecci√≥n con longitud m√≠nima de 2m.',
                inst_down_5: 'Cada pararrayos PDC debe conectarse a tierra mediante dos conductores de bajada. Para edificios con altura superior a 60m, se necesitan cuatro conductores de bajada.',
                inst_ground_title: 'SISTEMA DE PUESTA A TIERRA',
                inst_ground_1: 'Existen dos tipos de sistemas de puesta a tierra, Tipo A y Tipo B:',
                inst_ground_1a: 'Tipo A1: electrodos horizontales "pata de ganso".',
                inst_ground_1b: 'Tipo A2: electrodos verticales rectos o triangulares.',
                inst_ground_1c: 'Tipo B: electrodos en forma de anillo fuera de la estructura.',
                inst_ground_2: 'Otra configuraci√≥n posible, particularmente recomendada para terrenos rocosos que no permiten excavaciones a grandes profundidades, consiste en colocar verticalmente una placa de toma de tierra de electrodos en un agujero con volumen m√≠nimo de 1m¬≥.',
                inst_ground_3: 'Se recomienda a√±adir compuesto Quibacsol para mejorar la conductividad del suelo.',
                inst_ground_4: 'Conectar el sistema de puesta a tierra del rayo al sistema de puesta a tierra general del edificio mediante un centellador.'
            },
            en: {
                header_title: '‚ö° Coverage Calculator - Ingesco Lightning Rods',
                header_norm: 'According to UNE 21186:2011 / NFC 17-102:2011',
                btn_place_rod: '‚ö° Place Lightning Rod',
                btn_draw_bajante: 'üìê Draw Down Conductor',
                btn_ground: '‚èö Ground Connection',
                btn_building: 'üè¢ Building',
                btn_polygon: '‚úèÔ∏è Polygon',
                btn_load_plan: 'üìÑ Load Plan',
                btn_print_map: 'üó∫Ô∏è Print Map',
                btn_map_materials: 'üìÑ Map & Materials List',
                btn_clear: 'üóëÔ∏è Clear All',
                label_type: 'üì° Type:',
                label_model: 'Model:',
                label_level: 'üõ°Ô∏è Level:',
                label_radius: 'Radius',
                label_ng: '‚õàÔ∏è Lightning Density (Ng)',
                ng_click: 'Click on map to see',
                search_placeholder: 'üîç Address, decimal coords, DMS or UTM...',
                instruction_default: '‚ö° Activate "Place Lightning Rod" to add | üè¢ Draw buildings to verify coverage',
                pdf_project_num: 'Project No.:',
                pdf_company: 'Company:',
                pdf_model_selected: 'Selected model:',
                pdf_project_ref: 'Project reference:',
                pdf_building_height: 'Building height (m):',
                pdf_cable_meters: 'Down conductor cable (m):',
                pdf_clamps: 'Clamps needed:',
                pdf_discount_type: 'Discount type:',
                pdf_title: 'Lightning protection study',
                pdf_project: 'Project:',
                pdf_empresa: 'Company:',
                pdf_num_installations: 'Number of lightning rod installations:',
                pdf_coverage_plan: 'Coverage plan',
                pdf_legend: 'Legend:',
                pdf_legend_text: 'Blue area: Lightning rod protection area according to NP 4426:2013/UNE 21.186:2011/NFC 17-102:2011.',
                pdf_model_col: 'Model',
                pdf_type_col: 'Type',
                pdf_dt_col: 'Œît',
                pdf_level_col: 'Level',
                pdf_radius_col: 'Radius',
                pdf_coords_col: 'Coordinates',
                pdf_position_col: 'Position',
                pdf_level_names: {1: 'I (High)', 2: 'II (Medium)', 3: 'III (Low)', 4: 'IV (Minimum)'},
                pdf_on_plan: '(On plan)',
                pdf_no_rods: 'No lightning rods placed.',
                pdf_rods_installed: 'INSTALLED LIGHTNING RODS',
                pdf_coverage_map: 'COVERAGE MAP',
                pdf_coverage_plan_title: 'COVERAGE PLAN',
                pdf_norms: 'According to UNE 21186:2011 / NFC 17-102:2011 / NP 4426:2013',
                pdf_scale_info: 'Plan scale: 1m =',
                pdf_pixels: 'pixels',
                pdf_materials_title: 'Materials List',
                pdf_ext_protection: 'EXTERNAL PROTECTION',
                pdf_material: 'Material',
                pdf_reference: 'Reference',
                pdf_quantity: 'Quantity',
                pdf_int_protection: 'INTERNAL PROTECTION (Recommended per RBT ITC-BT-23)',
                pdf_date: 'Date:',
                inst_title: 'Lightning rod system installation instructions',
                inst_rod_title: 'LIGHTNING ROD',
                inst_rod_1: 'Fix the central axis of the air terminal to the mast adapter piece.',
                inst_rod_2: 'Pass the down conductor through the mast interior and connect it to the adapter base, securing with two Allen screws.',
                inst_rod_3: 'Insert the adapter into the mast interior and fix it with the corresponding screw.',
                inst_rod_4: 'Connect all metallic structures within the safety distance using spark gaps.',
                inst_down_title: 'DOWN CONDUCTOR',
                inst_down_1: 'Fix the mast to the structure using the most suitable support and, if necessary, fix the mast to the roof using anchor straps.',
                inst_down_2: 'Fix the down conductor with fixing supports, ensuring they are properly tightened and using three fixings per metre as reference.',
                inst_down_3: 'Install the lightning strike counter at the bottom of the conductor, two to three metres above ground.',
                inst_down_4: 'Protect the lower part of the down conductor with a protective tube with a minimum length of 2m.',
                inst_down_5: 'Each PDC lightning rod must be earthed via two down conductors. For buildings over 60m in height, four down conductors are required.',
                inst_ground_title: 'EARTHING SYSTEM',
                inst_ground_1: 'There are two types of earthing systems, Type A and Type B:',
                inst_ground_1a: 'Type A1: horizontal "crow\'s foot" electrodes.',
                inst_ground_1b: 'Type A2: straight or triangular vertical electrodes.',
                inst_ground_1c: 'Type B: ring-shaped electrodes outside the structure.',
                inst_ground_2: 'Another possible configuration, particularly recommended for rocky terrain that does not allow deep excavations, involves vertically placing an earthing electrode plate in a hole with a minimum volume of 1m\u00b3.',
                inst_ground_3: 'It is recommended to add Quibacsol compound to improve soil conductivity.',
                inst_ground_4: 'Connect the lightning earthing system to the general building earthing system via a spark gap.'
            },
            fr: {
                header_title: '‚ö° Calculateur de Couverture - Paratonnerres Ingesco',
                header_norm: 'Selon UNE 21186:2011 / NFC 17-102:2011',
                btn_place_rod: '‚ö° Placer Paratonnerre',
                btn_draw_bajante: 'üìê Descente',
                btn_ground: '‚èö Prise de Terre',
                btn_building: 'üè¢ B√¢timent',
                btn_polygon: '‚úèÔ∏è Polygone',
                btn_load_plan: 'üìÑ Charger Plan',
                btn_print_map: 'üó∫Ô∏è Imprimer Carte',
                btn_map_materials: 'üìÑ Carte et Liste Mat√©riaux',
                btn_clear: 'üóëÔ∏è Tout Effacer',
                label_type: 'üì° Type:',
                label_model: 'Mod√®le:',
                label_level: 'üõ°Ô∏è Niveau:',
                label_radius: 'Rayon',
                label_ng: '‚õàÔ∏è Densit√© de foudre (Ng)',
                ng_click: 'Cliquez sur la carte pour voir',
                search_placeholder: 'üîç Adresse, coordonn√©es d√©cimales, DMS ou UTM...',
                instruction_default: '‚ö° Activez "Placer Paratonnerre" pour ajouter | üè¢ Dessinez des b√¢timents pour v√©rifier la couverture',
                pdf_project_num: 'N¬∞ Projet:',
                pdf_company: 'Entreprise:',
                pdf_model_selected: 'Mod√®le s√©lectionn√©:',
                pdf_project_ref: 'R√©f√©rence projet:',
                pdf_building_height: 'Hauteur b√¢timent (m):',
                pdf_cable_meters: 'M√®tres c√¢ble descente:',
                pdf_clamps: 'Colliers n√©cessaires:',
                pdf_discount_type: 'Type de remise:',
                pdf_title: '√âtude de protection contre la foudre',
                pdf_project: 'Projet:',
                pdf_empresa: 'Entreprise:',
                pdf_num_installations: 'Nombre d\'installations de paratonnerres:',
                pdf_coverage_plan: 'Plan de couverture',
                pdf_legend: 'L√©gende:',
                pdf_legend_text: 'Zone bleue: Zone de protection du paratonnerre selon les normes NP 4426:2013/UNE 21.186:2011/NFC 17-102:2011.',
                pdf_model_col: 'Mod√®le',
                pdf_type_col: 'Type',
                pdf_dt_col: 'Œît',
                pdf_level_col: 'Niveau',
                pdf_radius_col: 'Rayon',
                pdf_coords_col: 'Coordonn√©es',
                pdf_position_col: 'Position',
                pdf_level_names: {1: 'I (Haut)', 2: 'II (Moyen)', 3: 'III (Bas)', 4: 'IV (Minimum)'},
                pdf_on_plan: '(Sur plan)',
                pdf_no_rods: 'Aucun paratonnerre plac√©.',
                pdf_rods_installed: 'PARATONNERRES INSTALL√âS',
                pdf_coverage_map: 'CARTE DE COUVERTURE',
                pdf_coverage_plan_title: 'PLAN DE COUVERTURE',
                pdf_norms: 'Selon UNE 21186:2011 / NFC 17-102:2011 / NP 4426:2013',
                pdf_scale_info: '√âchelle du plan: 1m =',
                pdf_pixels: 'pixels',
                pdf_materials_title: 'Liste des Mat√©riaux',
                pdf_ext_protection: 'PROTECTION EXTERNE',
                pdf_material: 'Mat√©riel',
                pdf_reference: 'R√©f√©rence',
                pdf_quantity: 'Quantit√©',
                pdf_int_protection: 'PROTECTION INTERNE (Recommand√©e selon RBT ITC-BT-23)',
                pdf_date: 'Date:',
                inst_title: 'Instructions d\'installation d\'un syst√®me de paratonnerre',
                inst_rod_title: 'PARATONNERRE',
                inst_rod_1: 'Fixer l\'axe central du terminal a√©rien de captation √† la pi√®ce d\'adaptation du m√¢t.',
                inst_rod_2: 'Passer le conducteur de descente √† l\'int√©rieur du m√¢t et le relier √† la base de l\'adaptateur, en le fixant avec deux vis Allen.',
                inst_rod_3: 'Introduire l\'adaptateur √† l\'int√©rieur du m√¢t et le fixer avec la vis correspondante.',
                inst_rod_4: 'Relier toutes les structures m√©talliques se trouvant dans la distance de s√©curit√© √† l\'aide d\'√©clateurs.',
                inst_down_title: 'CONDUCTEUR DE DESCENTE',
                inst_down_1: 'Fixer le m√¢t √† la structure en utilisant le support le plus adapt√© et, si n√©cessaire, fixer le m√¢t √† la toiture par des sangles d\'ancrage.',
                inst_down_2: 'Fixer le conducteur de descente avec des supports de fixation, en s\'assurant qu\'ils sont bien serr√©s et en utilisant, comme r√©f√©rence, trois fixations par m√®tre.',
                inst_down_3: 'Installer le compteur de coups de foudre dans la partie inf√©rieure du conducteur, √† deux ou trois m√®tres au-dessus du sol.',
                inst_down_4: 'Prot√©ger la partie inf√©rieure du conducteur de descente avec un tube de protection d\'une longueur minimale de 2m.',
                inst_down_5: 'Chaque paratonnerre PDC doit √™tre reli√© √† la terre par deux conducteurs de descente. Pour les b√¢timents de plus de 60m de hauteur, quatre conducteurs de descente sont n√©cessaires.',
                inst_ground_title: 'SYST√àME DE MISE √Ä LA TERRE',
                inst_ground_1: 'Il existe deux types de syst√®mes de mise √† la terre, Type A et Type B:',
                inst_ground_1a: 'Type A1: √©lectrodes horizontales "patte d\'oie".',
                inst_ground_1b: 'Type A2: √©lectrodes verticales droites ou triangulaires.',
                inst_ground_1c: 'Type B: √©lectrodes en forme d\'anneau √† l\'ext√©rieur de la structure.',
                inst_ground_2: 'Une autre configuration possible, particuli√®rement recommand√©e pour les terrains rocheux ne permettant pas les excavations profondes, consiste √† placer verticalement une plaque de mise √† la terre d\'√©lectrodes dans un trou d\'un volume minimum de 1m¬≥.',
                inst_ground_3: 'Il est recommand√© d\'ajouter du compos√© Quibacsol pour am√©liorer la conductivit√© du sol.',
                inst_ground_4: 'Connecter le syst√®me de mise √† la terre de la foudre au syst√®me de mise √† la terre g√©n√©ral du b√¢timent par un √©clateur.'
            },
            pt: {
                header_title: '‚ö° Calculador de Cobertura - Para-raios Ingesco',
                header_norm: 'Segundo UNE 21186:2011 / NFC 17-102:2011',
                btn_place_rod: '‚ö° Colocar Para-raios',
                btn_draw_bajante: 'üìê Condutor de Baixada',
                btn_ground: '‚èö Liga√ß√£o √† Terra',
                btn_building: 'üè¢ Edif√≠cio',
                btn_polygon: '‚úèÔ∏è Pol√≠gono',
                btn_load_plan: 'üìÑ Carregar Plano',
                btn_print_map: 'üó∫Ô∏è Imprimir Mapa',
                btn_map_materials: 'üìÑ Mapa e Lista de Materiais',
                btn_clear: 'üóëÔ∏è Apagar tudo',
                label_type: 'üì° Tipo:',
                label_model: 'Modelo:',
                label_level: 'üõ°Ô∏è N√≠vel:',
                label_radius: 'Raio',
                label_ng: '‚õàÔ∏è Densidade de raios (Ng)',
                ng_click: 'Clique no mapa para ver',
                search_placeholder: 'üîç Endere√ßo, coordenadas decimais, DMS ou UTM...',
                instruction_default: '‚ö° Ative "Colocar Para-raios" para adicionar | üè¢ Desenhe edif√≠cios para verificar cobertura',
                pdf_project_num: 'N¬∞ Projeto:',
                pdf_company: 'Empresa:',
                pdf_model_selected: 'Modelo selecionado:',
                pdf_project_ref: 'Refer√™ncia do projeto:',
                pdf_building_height: 'Altura edif√≠cio (m):',
                pdf_cable_meters: 'Metros cabo descida:',
                pdf_clamps: 'Abra√ßadeiras necess√°rias:',
                pdf_discount_type: 'Tipo de desconto:',
                pdf_title: 'Estudo de prote√ß√£o contra descargas atmosf√©ricas',
                pdf_project: 'Projeto:',
                pdf_empresa: 'Empresa:',
                pdf_num_installations: 'N√∫mero de instala√ß√µes de para-raios:',
                pdf_coverage_plan: 'Plano de cobertura',
                pdf_legend: 'Legenda:',
                pdf_legend_text: '√Årea azul: √Årea de prote√ß√£o para-raios de acordo com as normas NP 4426:2013/UNE 21.186:2011/NFC 17-102:2011.',
                pdf_model_col: 'Modelo',
                pdf_type_col: 'Tipo',
                pdf_dt_col: 'Œît',
                pdf_level_col: 'N√≠vel',
                pdf_radius_col: 'Raio',
                pdf_coords_col: 'Coordenadas',
                pdf_position_col: 'Posi√ß√£o',
                pdf_level_names: {1: 'I (Alto)', 2: 'II (M√©dio)', 3: 'III (Baixo)', 4: 'IV (M√≠nimo)'},
                pdf_on_plan: '(Sobre plano)',
                pdf_no_rods: 'N√£o h√° para-raios colocados.',
                pdf_rods_installed: 'PARA-RAIOS INSTALADOS',
                pdf_coverage_map: 'MAPA DE COBERTURA',
                pdf_coverage_plan_title: 'PLANO DE COBERTURA',
                pdf_norms: 'Segundo UNE 21186:2011 / NFC 17-102:2011 / NP 4426:2013',
                pdf_scale_info: 'Escala do plano: 1m =',
                pdf_pixels: 'p√≠xeis',
                pdf_materials_title: 'Lista de Materiais',
                pdf_ext_protection: 'PROTE√á√ÉO EXTERNA',
                pdf_material: 'Material',
                pdf_reference: 'Refer√™ncia',
                pdf_quantity: 'Quantidade',
                pdf_int_protection: 'PROTE√á√ÉO INTERNA (Recomendada segundo RBT ITC-BT-23)',
                pdf_date: 'Data:',
                inst_title: 'Instru√ß√µes de instala√ß√£o de um sistema de para-raios',
                inst_rod_title: 'PARA-RAIOS',
                inst_rod_1: 'Fixar o eixo central do terminal a√©reo de capta√ß√£o √† pe√ßa adaptadora do mastro.',
                inst_rod_2: 'Passar o condutor de descida pelo interior do mastro e lig√°-lo √† base do adaptador, fixando-o com dois parafusos Allen.',
                inst_rod_3: 'Introduzir o adaptador no interior do mastro e fix√°-lo com o respetivo parafuso.',
                inst_rod_4: 'Ligar todas as estruturas met√°licas que se encontrem dentro da dist√¢ncia de seguran√ßa utilizando centelhadores.',
                inst_down_title: 'CONDUTOR DE BAIXADA',
                inst_down_1: 'Fixar o mastro √† estrutura utilizando o suporte mais adequado e, se necess√°rio, fixar o mastro √† cobertura atrav√©s de cintas de ancoragem.',
                inst_down_2: 'Fixar o condutor de baixada com suportes de fixa√ß√£o, certificando-se de que est√£o bem apertados e utilizando, como refer√™ncia, tr√™s fixa√ß√µes por metro.',
                inst_down_3: 'Instalar o contador de raios na parte inferior do condutor, dois ou tr√™s metros acima do solo.',
                inst_down_4: 'Proteger a parte inferior do condutor de baixada com um tubo de prote√ß√£o com comprimento m√≠nimo de 2m.',
                inst_down_5: 'Cada para-raios PDC deve ser ligado √† terra atrav√©s de dois condutores de descida. Para edif√≠cios com altura superior a 60m, s√£o necess√°rios quatro condutores de descida.',
                inst_ground_title: 'SISTEMA DE LIGA√á√ÉO √Ä TERRA',
                inst_ground_1: 'Existem dois tipos de sistemas de liga√ß√£o a terra, Tipo A e Tipo B:',
                inst_ground_1a: 'Tipo A1: el√©trodos horizontais "p√©-de-ganso".',
                inst_ground_1b: 'Tipo A2: el√©trodos verticais retos ou triangulares.',
                inst_ground_1c: 'Tipo B: el√©trodos em forma de anel fora da estrutura.',
                inst_ground_2: 'Outra configura√ß√£o poss√≠vel, particularmente recomendada para terrenos rochosos que n√£o permitem escava√ß√µes a grandes profundidades, consiste em colocar verticalmente uma placa de aterramento de eletrodos em um furo com volume m√≠nimo de 1m¬≥.',
                inst_ground_3: 'Recomenda-se adicionar comp√≥sito Quibacsol para melhorar a condutividade do solo.',
                inst_ground_4: 'Conectar o sistema de aterramento do raio ao sistema de aterramento geral do edif√≠cio atrav√©s de um centelhador.'
            }
        };
        
        function t(key) {
            return translations[currentLang][key] || translations['es'][key] || key;
        }
        
        function setLanguage(lang) {
            currentLang = lang;
            document.getElementById('langSelect').value = lang;
            }
        
        function applyTranslations() {
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });
            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[currentLang][key]) {
                    el.placeholder = translations[currentLang][key];
                }
            });
        }
        
// Estado actual (para nuevos pararrayos)
        let currentType = 'pdc';
        let currentModel = 'PDC 6.4';
        let currentLevel = 1;
        
        // Arrays con objetos completos para cada pararrayos
        let lightningRods = []; // { marker, circle, type, model, level }
        let buildings = []; // Array de edificios
        let bajantes = []; // Array de l√≠neas bajantes
        let tierras = []; // Array de tomas de tierra
        let drawingMode = null; // 'rectangle' o 'polygon'
        let currentDrawer = null;
        let pdfMode = 'full'; // 'image' o 'full'
        
        // Modos de edici√≥n
        let pararrayosMode = false;
        let bajanteMode = false;
        let tierraMode = false;
        let bajanteStart = null; // Punto inicial de la bajante
        
        // ============================================
        // MODO PLANO - Variables
        // ============================================
        let planoMode = false;
        let planoScale = null; // p√≠xeles por metro
        let planoZoomLevel = 1;
        let planoScaleMode = false;
        let planoScaleStart = null;
        let planoScaleEnd = null;
        let planoScaleLine = null;
        let planoElements = {
            rods: [],      // {x, y, type, model, level, radius}
            tierras: [],   // {x, y}
            bajantes: []   // {x1, y1, x2, y2}
        };
        let planoDragging = false;
        let planoDragStart = {x: 0, y: 0};
        let planoScrollStart = {x: 0, y: 0};
        // Interacci√≥ elements pl√†nol
        let planoSelectedElement = null; // {type: 'rod'|'tierra'|'bajante', index: N}
        let planoDraggingElement = false;
        let planoDragElementOffset = {x: 0, y: 0};
        let planoMouseMoved = false;
        
        // Coordenadas iniciales
        const initialLat = 41.557323;
        const initialLng = 2.031215;
        
        // ============================================
        // INICIALIZAR MAPA
        // ============================================
        
        // Usar Canvas renderer para mejor compatibilidad con html2canvas
        const canvasRenderer = L.canvas({ padding: 0.5 });
        
        const map = L.map('map', {
            preferCanvas: true,
            renderer: canvasRenderer
        }).setView([initialLat, initialLng], 20);
        
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; Esri'
        });
        const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        });
        const labels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}');
        
        satellite.addTo(map);
        labels.addTo(map);
        
        L.control.layers({ "üõ∞Ô∏è Sat√©lite": satellite, "üó∫Ô∏è Calles": streets }).addTo(map);
        L.control.scale({ metric: true, imperial: false, position: 'bottomright' }).addTo(map);
        
        // ============================================
        // FUNCIONS PRINCIPALS
        // ============================================
        
        function getCurrentRadius() {
            return allModels[currentType].models[currentModel].radii[currentLevel];
        }
        
        function getCurrentColor() {
            return allModels[currentType].color;
        }
        
        function updateDisplay() {
            document.getElementById('radiusDisplay').textContent = getCurrentRadius() + ' m';
            highlightTableCell();
        }
        
        function populateModelSelect() {
            const select = document.getElementById('modelSelect');
            select.innerHTML = '';
            const models = allModels[currentType].models;
            
            for (const [name, data] of Object.entries(models)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (${data.dt}¬µs)`;
                select.appendChild(option);
            }
            
            const modelNames = Object.keys(models);
            currentModel = modelNames[modelNames.length - 1];
            select.value = currentModel;
        }
        
        function setType(type) {
            currentType = type;
            document.querySelectorAll('.type-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.classList.contains(type)) tab.classList.add('active');
            });
            populateModelSelect();
            updateDisplay();
            updateAllCircles();
        }
        
        function updateModel() {
            currentModel = document.getElementById('modelSelect').value;
            updateDisplay();
            updateAllCircles();
        }
        
        function setLevel(level) {
            currentLevel = level;
            document.querySelectorAll('.level-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i + 1 === level);
            });
            updateDisplay();
            updateAllCircles();
        }
        
        function updateAllCircles() {
            // Ja no actualitza els cercles existents - cada un mant√© la seva configuraci√≥
            // Nom√©s actualitza el display
            updateDisplay();
        }
        
        // Actualitzar un cercle espec√≠fic amb nova configuraci√≥
        function updateLightningRod(idx, newType, newModel, newLevel) {
            if (idx < 0 || idx >= lightningRods.length) return;
            
            const rod = lightningRods[idx];
            rod.type = newType;
            rod.model = newModel;
            rod.level = newLevel;
            
            const modelData = allModels[newType].models[newModel];
            const radius = modelData.radii[newLevel];
            const color = allModels[newType].color;
            
            rod.circle.setRadius(radius);
            rod.circle.setStyle({ color: color, fillColor: color });
            
            updateMarkerPopup(idx);
            updateAllBuildingsProtection();
        }
        
        // ============================================
        // GESTI√É‚Äú DE MARCADORS
        // ============================================
        
        function createLightningIcon() {
            return L.divIcon({
                html: '<div style="font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); cursor: grab;">‚ö°</div>',
                iconSize: [28, 28],
                iconAnchor: [14, 14],
                className: 'draggable-marker'
            });
        }
        
        function updateMarkerPopup(idx) {
            const rod = lightningRods[idx];
            const latlng = rod.marker.getLatLng();
            const modelData = allModels[rod.type].models[rod.model];
            const radius = modelData.radii[rod.level];
            const color = allModels[rod.type].color;
            
            // Generar opcions de models per al tipus actual del parallamps
            let modelOptions = '';
            for (const [name, data] of Object.entries(allModels[rod.type].models)) {
                const selected = name === rod.model ? 'selected' : '';
                modelOptions += `<option value="${name}" ${selected}>${name} (${data.dt}¬µs)</option>`;
            }
            
            rod.marker.setPopupContent(`
                <div class="popup-content">
                    <h3>‚ö° Ingesco ${rod.model}</h3>
                    <table class="popup-table">
                        <tr><td>Tipo:</td><td style="color:${color}">${allModels[rod.type].name}</td></tr>
                        <tr><td>Œît:</td><td>${modelData.dt} ¬µs</td></tr>
                        <tr><td>Nivel:</td><td>${['I','II','III','IV'][rod.level-1]}</td></tr>
                        <tr><td>Radio:</td><td style="color:${color}">${radius} m</td></tr>
                    </table>
                    <hr style="border:none;border-top:1px solid #ddd;margin:8px 0;">
                    
                    <div style="font-size:0.8em; margin-bottom:8px;">
                        <strong>Editar:</strong>
                    </div>
                    <div style="display:flex; gap:4px; margin-bottom:6px; flex-wrap:wrap; justify-content:center;">
                        <button class="popup-type-btn ${rod.type === 'pdc' ? 'active' : ''}" style="background:${rod.type === 'pdc' ? '#3498db' : '#ddd'}; color:${rod.type === 'pdc' ? 'white' : '#333'}; border:none; padding:3px 8px; border-radius:3px; cursor:pointer; font-size:0.75em;" onclick="changeRodType(${idx}, 'pdc')">PDC</button>
                        <button class="popup-type-btn ${rod.type === 'pdce' ? 'active' : ''}" style="background:${rod.type === 'pdce' ? '#9b59b6' : '#ddd'}; color:${rod.type === 'pdce' ? 'white' : '#333'}; border:none; padding:3px 8px; border-radius:3px; cursor:pointer; font-size:0.75em;" onclick="changeRodType(${idx}, 'pdce')">PDC.E</button>
                        <button class="popup-type-btn ${rod.type === 'air' ? 'active' : ''}" style="background:${rod.type === 'air' ? '#e67e22' : '#ddd'}; color:${rod.type === 'air' ? 'white' : '#333'}; border:none; padding:3px 8px; border-radius:3px; cursor:pointer; font-size:0.75em;" onclick="changeRodType(${idx}, 'air')">AIR</button>
                    </div>
                    <div style="margin-bottom:6px;">
                        <select onchange="changeRodModel(${idx}, this.value)" style="width:100%; padding:4px; font-size:0.8em; border-radius:4px; border:1px solid #ddd;">
                            ${modelOptions}
                        </select>
                    </div>
                    <div style="display:flex; gap:3px; justify-content:center; margin-bottom:8px;">
                        <button style="padding:4px 10px; border:2px solid ${rod.level === 1 ? '#2e86ab' : '#ddd'}; background:${rod.level === 1 ? '#2e86ab' : 'white'}; color:${rod.level === 1 ? 'white' : '#333'}; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.75em;" onclick="changeRodLevel(${idx}, 1)">I</button>
                        <button style="padding:4px 10px; border:2px solid ${rod.level === 2 ? '#2e86ab' : '#ddd'}; background:${rod.level === 2 ? '#2e86ab' : 'white'}; color:${rod.level === 2 ? 'white' : '#333'}; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.75em;" onclick="changeRodLevel(${idx}, 2)">II</button>
                        <button style="padding:4px 10px; border:2px solid ${rod.level === 3 ? '#2e86ab' : '#ddd'}; background:${rod.level === 3 ? '#2e86ab' : 'white'}; color:${rod.level === 3 ? 'white' : '#333'}; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.75em;" onclick="changeRodLevel(${idx}, 3)">III</button>
                        <button style="padding:4px 10px; border:2px solid ${rod.level === 4 ? '#2e86ab' : '#ddd'}; background:${rod.level === 4 ? '#2e86ab' : 'white'}; color:${rod.level === 4 ? 'white' : '#333'}; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.75em;" onclick="changeRodLevel(${idx}, 4)">IV</button>
                    </div>
                    
                    <hr style="border:none;border-top:1px solid #ddd;margin:8px 0;">
                    <div style="font-size:0.7em;color:#666;">
                        üìç ${latlng.lat.toFixed(6)}¬∞N, ${latlng.lng.toFixed(6)}¬∞E
                    </div>
                    <div style="margin-top:10px;">
                        <button class="popup-delete" onclick="removeMarker(${idx})">üóëÔ∏è Eliminar</button>
                    </div>
                    <div style="font-size:0.7em; color:#999; margin-top:6px;">‚úã Arrossega per moure</div>
                </div>
            `);
        }
        
        // Funcions per canviar configuraci√≥ d'un parallamps
        window.changeRodType = function(idx, newType) {
            const rod = lightningRods[idx];
            // Agafar el primer model del nou tipus
            const firstModel = Object.keys(allModels[newType].models)[0];
            updateLightningRod(idx, newType, firstModel, rod.level);
            rod.marker.openPopup();
        };
        
        window.changeRodModel = function(idx, newModel) {
            const rod = lightningRods[idx];
            updateLightningRod(idx, rod.type, newModel, rod.level);
            rod.marker.openPopup();
        };
        
        window.changeRodLevel = function(idx, newLevel) {
            const rod = lightningRods[idx];
            updateLightningRod(idx, rod.type, rod.model, newLevel);
            rod.marker.openPopup();
        };
        
        function addMarker(latlng, openPopup = true) {
            const radius = getCurrentRadius();
            const color = getCurrentColor();
            
            const circle = L.circle(latlng, {
                color: color,
                fillColor: color,
                fillOpacity: 0.2,
                radius: radius,
                weight: 3,
                renderer: canvasRenderer
            }).addTo(map);
            
            const marker = L.marker(latlng, { 
                icon: createLightningIcon(),
                draggable: true
            }).addTo(map);
            
            // Guardar amb la configuraci√≥ actual
            const rodData = {
                marker: marker,
                circle: circle,
                type: currentType,
                model: currentModel,
                level: currentLevel
            };
            lightningRods.push(rodData);
            
            const idx = lightningRods.length - 1;
            
            marker.bindPopup('');
            updateMarkerPopup(idx);
            if (openPopup) marker.openPopup();
            
            marker.on('drag', e => circle.setLatLng(e.latlng));
            marker.on('dragend', () => {
                updateMarkerPopup(idx);
                updateAllBuildingsProtection();
            });
            
            // Actualitzar protecci√≥ dels edificis
            updateAllBuildingsProtection();
        }
        
        window.removeMarker = function(idx) {
            if (idx >= 0 && idx < lightningRods.length) {
                const rod = lightningRods[idx];
                map.removeLayer(rod.marker);
                map.removeLayer(rod.circle);
                lightningRods.splice(idx, 1);
                
                // Actualitzar els √≠ndexs dels popups restants
                lightningRods.forEach((r, i) => updateMarkerPopup(i));
                
                updateAllBuildingsProtection();
            }
        };
        
        // ============================================
        // MODOS DE EDICI√É‚ÄúN
        // ============================================
        
        function updateInstruction(text) {
            document.getElementById('instruction').innerHTML = text;
        }
        
        function deactivateAllModes() {
            pararrayosMode = false;
            bajanteMode = false;
            tierraMode = false;
            bajanteStart = null;
            planoBajanteStart = null;
            document.getElementById('btnPararrayos').classList.remove('active');
            document.getElementById('btnBajante').classList.remove('active');
            document.getElementById('btnTierra').classList.remove('active');
            // Restaurar cursor del pl√†nol
            if (planoMode) {
                document.getElementById('planoContainer').style.cursor = 'grab';
                document.getElementById('planoContainer').classList.remove('crosshair');
            }
            updateInstruction(planoMode 
                ? 'üìÑ MODO PLANO: Clic en un elemento para seleccionarlo, arrastra para mover'
                : '‚ö° Activa "Colocar Pararrayos" para a√±adir | üè¢ Dibuja edificios para verificar cobertura');
        }
        
        function togglePararrayosMode() {
            if (pararrayosMode) {
                deactivateAllModes();
            } else {
                deactivateAllModes();
                pararrayosMode = true;
                document.getElementById('btnPararrayos').classList.add('active');
                if (planoMode) {
                    document.getElementById('planoContainer').style.cursor = 'crosshair';
                    closePlanoPopup();
                }
                updateInstruction('‚ö° <strong>MODO PARARRAYOS ACTIVO</strong> - Clic en el mapa para colocar | Clic de nuevo en el bot√≥n para desactivar');
            }
        }
        
        function toggleBajanteMode() {
            if (bajanteMode) {
                deactivateAllModes();
            } else {
                deactivateAllModes();
                bajanteMode = true;
                document.getElementById('btnBajante').classList.add('active');
                if (planoMode) {
                    document.getElementById('planoContainer').style.cursor = 'crosshair';
                    closePlanoPopup();
                }
                updateInstruction('üìè <strong>MODO BAJANTE ACTIVO</strong> - Clic en inicio (pararrayos), luego clic en final (tierra)');
            }
        }
        
        function toggleTierraMode() {
            if (tierraMode) {
                deactivateAllModes();
            } else {
                deactivateAllModes();
                tierraMode = true;
                document.getElementById('btnTierra').classList.add('active');
                if (planoMode) {
                    document.getElementById('planoContainer').style.cursor = 'crosshair';
                    closePlanoPopup();
                }
                updateInstruction('√¢¬è≈° <strong>MODO TOMA DE TIERRA ACTIVO</strong> - Clic en el mapa para colocar s√≠mbolo');
            }
        }
        
        // ============================================
        // BAJANTES (L√çNEAS)
        // ============================================
        
        function addBajante(start, end) {
            const polyline = L.polyline([start, end], {
                color: '#8B4513',
                weight: 4,
                opacity: 0.9,
                dashArray: '10, 5',
                renderer: canvasRenderer
            }).addTo(map);
            
            // Calcular longitud
            const distance = map.distance(start, end);
            
            // Popup con info
            polyline.bindPopup(`
                <div class="popup-content">
                    <h3>üìè Bajante</h3>
                    <table class="popup-table">
                        <tr><td>Longitud:</td><td>${distance.toFixed(1)} m</td></tr>
                    </table>
                    <button class="popup-delete" onclick="deleteBajante(${bajantes.length})">üóëÔ∏è Eliminar</button>
                </div>
            `);
            
            bajantes.push(polyline);
        }
        
        window.deleteBajante = function(index) {
            if (bajantes[index]) {
                map.removeLayer(bajantes[index]);
                bajantes.splice(index, 1);
                // Actualizar √≠ndices de los popups
                bajantes.forEach((b, i) => {
                    const distance = map.distance(b.getLatLngs()[0], b.getLatLngs()[1]);
                    b.setPopupContent(`
                        <div class="popup-content">
                            <h3>üìè Bajante</h3>
                            <table class="popup-table">
                                <tr><td>Longitud:</td><td>${distance.toFixed(1)} m</td></tr>
                            </table>
                            <button class="popup-delete" onclick="deleteBajante(${i})">üóëÔ∏è Eliminar</button>
                        </div>
                    `);
                });
            }
        };
        
        // ============================================
        // TOMAS DE TIERRA
        // ============================================
        
        function createTierraIcon() {
            return L.divIcon({
                className: 'tierra-icon',
                html: `<svg width="30" height="36" viewBox="0 0 30 36" xmlns="http://www.w3.org/2000/svg">
                    <line x1="15" y1="0" x2="15" y2="12" stroke="#8B4513" stroke-width="3"/>
                    <line x1="5" y1="12" x2="25" y2="12" stroke="#228B22" stroke-width="3"/>
                    <line x1="8" y1="18" x2="22" y2="18" stroke="#228B22" stroke-width="3"/>
                    <line x1="11" y1="24" x2="19" y2="24" stroke="#228B22" stroke-width="3"/>
                    <line x1="14" y1="30" x2="16" y2="30" stroke="#228B22" stroke-width="3"/>
                </svg>`,
                iconSize: [30, 36],
                iconAnchor: [15, 12]
            });
        }
        
        function addTomaTierra(latlng) {
            const marker = L.marker(latlng, {
                icon: createTierraIcon(),
                draggable: true
            }).addTo(map);
            
            const idx = tierras.length;
            
            marker.bindPopup(`
                <div class="popup-content">
                    <h3>√¢¬è≈° Toma de Tierra</h3>
                    <table class="popup-table">
                        <tr><td>Lat:</td><td>${latlng.lat.toFixed(6)}</td></tr>
                        <tr><td>Lng:</td><td>${latlng.lng.toFixed(6)}</td></tr>
                    </table>
                    <button class="popup-delete" onclick="deleteTierra(${idx})">üóëÔ∏è Eliminar</button>
                </div>
            `);
            
            tierras.push(marker);
            
            // Actualizar popup al arrastrar
            marker.on('dragend', function() {
                const newPos = marker.getLatLng();
                const currentIdx = tierras.indexOf(marker);
                marker.setPopupContent(`
                    <div class="popup-content">
                        <h3>√¢¬è≈° Toma de Tierra</h3>
                        <table class="popup-table">
                            <tr><td>Lat:</td><td>${newPos.lat.toFixed(6)}</td></tr>
                            <tr><td>Lng:</td><td>${newPos.lng.toFixed(6)}</td></tr>
                        </table>
                        <button class="popup-delete" onclick="deleteTierra(${currentIdx})">üóëÔ∏è Eliminar</button>
                    </div>
                `);
            });
        }
        
        window.deleteTierra = function(index) {
            if (tierras[index]) {
                map.removeLayer(tierras[index]);
                tierras.splice(index, 1);
                // Actualizar √≠ndices
                tierras.forEach((t, i) => {
                    const pos = t.getLatLng();
                    t.setPopupContent(`
                        <div class="popup-content">
                            <h3>√¢¬è≈° Toma de Tierra</h3>
                            <table class="popup-table">
                                <tr><td>Lat:</td><td>${pos.lat.toFixed(6)}</td></tr>
                                <tr><td>Lng:</td><td>${pos.lng.toFixed(6)}</td></tr>
                            </table>
                            <button class="popup-delete" onclick="deleteTierra(${i})">üóëÔ∏è Eliminar</button>
                        </div>
                    `);
                });
            }
        };
        
        function clearAllMarkers() {
            lightningRods.forEach(rod => {
                map.removeLayer(rod.marker);
                map.removeLayer(rod.circle);
            });
            buildings.forEach(b => buildingsLayer.removeLayer(b));
            bajantes.forEach(b => map.removeLayer(b));
            tierras.forEach(t => map.removeLayer(t));
            lightningRods = [];
            buildings = [];
            bajantes = [];
            tierras = [];
            deactivateAllModes();
        }
        
        // ============================================
        // B√É≈°SQUEDA POR DIRECCI√É‚ÄúN
        // ============================================
        
        // Funciones de conversi√≥n de coordenadas
        function parseDecimalCoords(query) {
            // Formato: 41.395, 2.175 o 41.395 2.175
            const match = query.match(/^(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)$/);
            if (match) {
                const lat = parseFloat(match[1]);
                const lng = parseFloat(match[2]);
                if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                    return { lat, lng, format: 'Coordenadas decimales' };
                }
            }
            return null;;
        }
        
        function parseDMSCoords(query) {
            // Format: 41¬∞23'45"N 2¬∞10'30"E o 41¬∫23'45"N 2¬∫10'30"E
            const dmsRegex = /(\d+)[¬∞¬∫](\d+)[''‚Ä≤](\d+\.?\d*)[""‚Ä≥]?\s*([NSns])\s*(\d+)[¬∞¬∫](\d+)[''‚Ä≤](\d+\.?\d*)[""‚Ä≥]?\s*([EWOewo])/;
            const match = query.match(dmsRegex);
            if (match) {
                let lat = parseInt(match[1]) + parseInt(match[2])/60 + parseFloat(match[3])/3600;
                let lng = parseInt(match[5]) + parseInt(match[6])/60 + parseFloat(match[7])/3600;
                
                if (match[4].toUpperCase() === 'S') lat = -lat;
                if (match[8].toUpperCase() === 'W' || match[8].toUpperCase() === 'O') lng = -lng;
                
                return { lat, lng, format: 'Graus, minuts i segons (DMS)' };
            }
            return null;
        }
        
        function parseUTMCoords(query) {
            // Format: 31T 431234 4591234 o 31N 431234 4591234
            const utmRegex = /^(\d{1,2})([C-X])\s+(\d+\.?\d*)\s+(\d+\.?\d*)$/i;
            const match = query.match(utmRegex);
            if (match) {
                const zone = parseInt(match[1]);
                const band = match[2].toUpperCase();
                const easting = parseFloat(match[3]);
                const northing = parseFloat(match[4]);
                
                // Conversi√≥ UTM a Lat/Lng
                const result = utmToLatLng(zone, band, easting, northing);
                if (result) {
                    result.format = `UTM Zona ${zone}${band}`;
                    return result;
                }
            }
            return null;
        }
        
        function utmToLatLng(zone, band, easting, northing) {
            // Conversi√≥ UTM a WGS84
            const k0 = 0.9996;
            const a = 6378137; // WGS84 semi-eix major
            const e = 0.081819191; // WGS84 excentricitat
            const e2 = e * e;
            const e1 = (1 - Math.sqrt(1 - e2)) / (1 + Math.sqrt(1 - e2));
            
            const x = easting - 500000; // Remove false easting
            let y = northing;
            
            // Ajustar per hemisferis sud
            const isNorthern = band >= 'N';
            if (!isNorthern) {
                y = y - 10000000; // Remove false northing
            }
            
            const lonOrigin = (zone - 1) * 6 - 180 + 3; // Central meridian
            
            const M = y / k0;
            const mu = M / (a * (1 - e2/4 - 3*e2*e2/64 - 5*e2*e2*e2/256));
            
            const phi1 = mu + (3*e1/2 - 27*e1*e1*e1/32) * Math.sin(2*mu)
                           + (21*e1*e1/16 - 55*e1*e1*e1*e1/32) * Math.sin(4*mu)
                           + (151*e1*e1*e1/96) * Math.sin(6*mu);
            
            const sinPhi1 = Math.sin(phi1);
            const cosPhi1 = Math.cos(phi1);
            const tanPhi1 = Math.tan(phi1);
            
            const N1 = a / Math.sqrt(1 - e2 * sinPhi1 * sinPhi1);
            const T1 = tanPhi1 * tanPhi1;
            const C1 = (e2 / (1 - e2)) * cosPhi1 * cosPhi1;
            const R1 = a * (1 - e2) / Math.pow(1 - e2 * sinPhi1 * sinPhi1, 1.5);
            const D = x / (N1 * k0);
            
            let lat = phi1 - (N1 * tanPhi1 / R1) * (D*D/2 - (5 + 3*T1 + 10*C1 - 4*C1*C1 - 9*(e2/(1-e2))) * D*D*D*D/24
                     + (61 + 90*T1 + 298*C1 + 45*T1*T1 - 252*(e2/(1-e2)) - 3*C1*C1) * D*D*D*D*D*D/720);
            
            let lng = lonOrigin + (D - (1 + 2*T1 + C1) * D*D*D/6
                     + (5 - 2*C1 + 28*T1 - 3*C1*C1 + 8*(e2/(1-e2)) + 24*T1*T1) * D*D*D*D*D/120) / cosPhi1;
            
            lat = lat * 180 / Math.PI;
            lng = lng * 180 / Math.PI;
            
            if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                return { lat, lng };
            }
            return null;
        }
        
        async function searchAddress() {
            const query = document.getElementById('addressInput').value.trim();
            if (!query) return;
            
            const btn = document.getElementById('searchBtn');
            const resultsDiv = document.getElementById('searchResults');
            
            btn.disabled = true;
            btn.textContent = '...';
            resultsDiv.classList.remove('show');
            
            // Intentar parsejar com a coordenades
            let coordResult = parseDecimalCoords(query) || parseDMSCoords(query) || parseUTMCoords(query);
            
            if (coordResult) {
                // √âs una coordenada, anar directament
                resultsDiv.innerHTML = `
                    <div class="search-result-item" onclick="selectAddress(${coordResult.lat}, ${coordResult.lng}, '${coordResult.format}')">
                        üìç <strong>${coordResult.format}</strong><br>
                        <small>Lat: ${coordResult.lat.toFixed(6)}, Lng: ${coordResult.lng.toFixed(6)}</small>
                    </div>
                `;
                resultsDiv.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Cercar';
                return;
            }
            
            // Si no √©s coordenada, cercar per adre√ßa
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`,
                    { headers: { 'Accept-Language': 'ca,es,en' } }
                );
                const results = await response.json();
                
                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div class="search-result-item" style="color:#999;">No s\'han trobat resultats</div>';
                } else {
                    resultsDiv.innerHTML = results.map((r, i) => `
                        <div class="search-result-item" onclick="selectAddress(${r.lat}, ${r.lon}, '${r.display_name.replace(/'/g, "\\'")}')">
                            üìç ${r.display_name}
                        </div>
                    `).join('');
                }
                resultsDiv.classList.add('show');
            } catch (error) {
                resultsDiv.innerHTML = '<div class="search-result-item" style="color:#e74c3c;">Error en la cerca</div>';
                resultsDiv.classList.add('show');
            }
            
            btn.disabled = false;
            btn.textContent = 'Cercar';
        }
        
        window.selectAddress = function(lat, lon, name) {
            const latlng = L.latLng(lat, lon);
            map.setView(latlng, 18);
            addMarker(latlng);
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('addressInput').value = '';
        };
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchResults').classList.remove('show');
            }
        });
        
        document.getElementById('addressInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchAddress();
        });
        
        // ============================================
        // PANEL PRESSUPOST
        // ============================================
        
        function openBudgetPanel(mode = 'full') {
            pdfMode = mode;
            
            // Actualitzar t√≠tol i botons segons el mode
            const title = document.getElementById('budgetPanelTitle');
            const budgetFields = document.getElementById('budgetOnlyFields');
            const generateBtn = document.getElementById('generatePdfBtn');
            
            if (mode === 'image') {
                title.textContent = 'üó∫Ô∏è Imprimir Mapa';
                budgetFields.style.display = 'none';
                generateBtn.textContent = 'üì• Generar Mapa PDF';
            } else {
                title.textContent = 'üìÑ Mapa i Llista de Materials';
                budgetFields.style.display = 'block';
                generateBtn.textContent = 'üì• Generar PDF Complet';
            }
            
            // Mostrar model actual o resum (comprovant tant mapa com pl√†nol)
            const isInPlanoMode = planoMode && planoElements.rods.length > 0;
            const rodsForDisplay = isInPlanoMode ? planoElements.rods : lightningRods;
            
            if (rodsForDisplay.length === 0) {
                document.getElementById('budgetModel').textContent = 'Sin pararrayos';
            } else if (rodsForDisplay.length === 1) {
                document.getElementById('budgetModel').textContent = rodsForDisplay[0].model;
            } else {
                document.getElementById('budgetModel').textContent = `${rodsForDisplay.length} pararrayos`;
            }
            
            updateBudgetCalc();
            document.getElementById('overlay').classList.add('show');
            document.getElementById('budgetPanel').classList.add('show');
        }
        
        function closeBudgetPanel() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('budgetPanel').classList.remove('show');
        }
        
        function closeAllPanels() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('budgetPanel').classList.remove('show');
        }
        
        // ============================================
        // DENSITAT DE LLAMPS (Ng)
        // ============================================
        
        // Dades globals de Ng basades en NASA LIS/OTD i estudis cient√≠fics
        // Fonts: Cecil et al. 2014, Albrecht et al. 2016, Soula et al. 2016
        function calculateNg(lat, lng) {
            let ng = 1.0; // Valor per defecte
            
            // ========== √ÄFRICA ==========
            // Congo (DRC) - M√†xim mundial terrestre (80-160+)
            if (lat > -10 && lat < 5 && lng > 15 && lng < 35) {
                // Zona de m√†xim absolut: Est DRC (Kivu, Virunga)
                if (lat > -3 && lat < 1 && lng > 26 && lng < 30) {
                    ng = 140 + Math.random() * 60; // 140-200
                }
                // Resta del Congo Basin
                else {
                    ng = 60 + Math.random() * 40; // 60-100
                }
            }
            // Camerun, Nig√®ria, Golf de Guinea
            else if (lat > 2 && lat < 12 && lng > 5 && lng < 15) {
                ng = 40 + Math.random() * 30; // 40-70
            }
            // √Äfrica Oriental (Uganda, Kenya, Tanzania)
            else if (lat > -10 && lat < 5 && lng > 29 && lng < 42) {
                ng = 30 + Math.random() * 30; // 30-60
            }
            // Sud-√Äfrica (nord-est)
            else if (lat > -30 && lat < -22 && lng > 25 && lng < 35) {
                ng = 15 + Math.random() * 15; // 15-30
            }
            
            // ========== AM√ÉÀÜRICA DEL SUD ==========
            // Vene√ßuela - Lake Maracaibo (M√†xim mundial absolut)
            else if (lat > 8 && lat < 11 && lng > -73 && lng < -71) {
                ng = 200 + Math.random() * 50; // 200-250
            }
            // Col√≤mbia
            else if (lat > 0 && lat < 10 && lng > -78 && lng < -70) {
                ng = 80 + Math.random() * 60; // 80-140
            }
            // Brasil - Amaz√≤nia i centre
            else if (lat > -15 && lat < 0 && lng > -65 && lng < -45) {
                ng = 25 + Math.random() * 30; // 25-55
            }
            // Brasil - Sud-est
            else if (lat > -25 && lat < -15 && lng > -55 && lng < -40) {
                ng = 15 + Math.random() * 15; // 15-30
            }
            // Argentina - Nord
            else if (lat > -30 && lat < -20 && lng > -65 && lng < -55) {
                ng = 10 + Math.random() * 15; // 10-25
            }
            
            // ========== AM√ÉÀÜRICA CENTRAL I CARIB ==========
            // Guatemala, Honduras
            else if (lat > 13 && lat < 18 && lng > -92 && lng < -87) {
                ng = 80 + Math.random() * 40; // 80-120
            }
            // Panam√†, Costa Rica
            else if (lat > 7 && lat < 12 && lng > -85 && lng < -77) {
                ng = 50 + Math.random() * 40; // 50-90
            }
            // Cuba, Hispaniola
            else if (lat > 18 && lat < 24 && lng > -85 && lng < -68) {
                ng = 20 + Math.random() * 20; // 20-40
            }
            
            // ========== AM√ÉÀÜRICA DEL NORD ==========
            // Florida
            else if (lat > 24 && lat < 31 && lng > -88 && lng < -79) {
                ng = 20 + Math.random() * 15; // 20-35
            }
            // Golf de M√®xic / Texas / Louisiana
            else if (lat > 28 && lat < 35 && lng > -100 && lng < -88) {
                ng = 8 + Math.random() * 10; // 8-18
            }
            // Midwest USA (Kansas, Oklahoma, Nebraska)
            else if (lat > 35 && lat < 42 && lng > -102 && lng < -94) {
                ng = 6 + Math.random() * 8; // 6-14
            }
            // Resta USA
            else if (lat > 25 && lat < 50 && lng > -125 && lng < -65) {
                ng = 2 + Math.random() * 5; // 2-7
            }
            // Canad√† sud
            else if (lat > 45 && lat < 55 && lng > -130 && lng < -60) {
                ng = 1 + Math.random() * 2; // 1-3
            }
            
            // ========== √ÄSIA ==========
            // Mal√†isia, Singapur, Indonesia
            else if (lat > -8 && lat < 8 && lng > 95 && lng < 140) {
                ng = 50 + Math.random() * 50; // 50-100
            }
            // √çndia - Mons√≥ (nord-est)
            else if (lat > 20 && lat < 30 && lng > 75 && lng < 95) {
                ng = 30 + Math.random() * 40; // 30-70
            }
            // Pakistan (Himalaia)
            else if (lat > 30 && lat < 37 && lng > 70 && lng < 78) {
                ng = 25 + Math.random() * 35; // 25-60
            }
            // Bangladesh
            else if (lat > 20 && lat < 27 && lng > 88 && lng < 93) {
                ng = 40 + Math.random() * 30; // 40-70
            }
            // Tail√†ndia, Vietnam, Myanmar
            else if (lat > 10 && lat < 25 && lng > 95 && lng < 110) {
                ng = 25 + Math.random() * 25; // 25-50
            }
            // Xina sud
            else if (lat > 20 && lat < 30 && lng > 105 && lng < 120) {
                ng = 15 + Math.random() * 20; // 15-35
            }
            // Jap√≥
            else if (lat > 30 && lat < 45 && lng > 128 && lng < 146) {
                ng = 5 + Math.random() * 10; // 5-15
            }
            
            // ========== OCEANIA ==========
            // Austr√†lia nord (Darwin)
            else if (lat > -20 && lat < -10 && lng > 125 && lng < 145) {
                ng = 25 + Math.random() * 25; // 25-50
            }
            // Austr√†lia est
            else if (lat > -35 && lat < -20 && lng > 145 && lng < 155) {
                ng = 8 + Math.random() * 12; // 8-20
            }
            // Nova Zelanda
            else if (lat > -47 && lat < -34 && lng > 166 && lng < 179) {
                ng = 1 + Math.random() * 2; // 1-3
            }
            
            // ========== EUROPA ==========
            // Espanya - Pirineus
            else if (lat > 42 && lat < 43.5 && lng > -2 && lng < 3) {
                ng = 3 + Math.random() * 1.5; // 3-4.5
            }
            // Espanya - Sistema Central, Arag√≥
            else if (lat > 39 && lat < 42 && lng > -4 && lng < 1) {
                ng = 2 + Math.random() * 1.5; // 2-3.5
            }
            // Espanya - Mediterrani
            else if (lat > 36 && lat < 42 && lng > -1 && lng < 5) {
                ng = 1.5 + Math.random() * 1; // 1.5-2.5
            }
            // Espanya - Cant√†bric
            else if (lat > 42.5 && lat < 44 && lng > -9 && lng < -1) {
                ng = 2 + Math.random() * 1.5; // 2-3.5
            }
            // Espanya - Andalusia
            else if (lat > 36 && lat < 39 && lng > -8 && lng < -2) {
                ng = 1.5 + Math.random() * 1; // 1.5-2.5
            }
            // Espanya - General
            else if (lat > 35 && lat < 44 && lng > -10 && lng < 5) {
                ng = 1.5 + Math.random() * 1.5; // 1.5-3
            }
            // It√†lia nord
            else if (lat > 44 && lat < 47 && lng > 7 && lng < 14) {
                ng = 3 + Math.random() * 2; // 3-5
            }
            // Alps
            else if (lat > 45 && lat < 48 && lng > 5 && lng < 15) {
                ng = 2.5 + Math.random() * 2; // 2.5-4.5
            }
            // Fran√ßa sud
            else if (lat > 42 && lat < 46 && lng > -1 && lng < 8) {
                ng = 2 + Math.random() * 1.5; // 2-3.5
            }
            // Alemanya, Pol√≤nia
            else if (lat > 47 && lat < 55 && lng > 5 && lng < 22) {
                ng = 1.5 + Math.random() * 2; // 1.5-3.5
            }
            // UK, Irlanda
            else if (lat > 50 && lat < 60 && lng > -11 && lng < 2) {
                ng = 0.5 + Math.random() * 1; // 0.5-1.5
            }
            // Escandin√†via
            else if (lat > 55 && lat < 72 && lng > 4 && lng < 32) {
                ng = 0.3 + Math.random() * 1; // 0.3-1.3
            }
            // Europa de l'Est
            else if (lat > 42 && lat < 55 && lng > 20 && lng < 45) {
                ng = 2 + Math.random() * 2; // 2-4
            }
            // R√∫ssia
            else if (lat > 50 && lat < 70 && lng > 30 && lng < 180) {
                ng = 0.5 + Math.random() * 1.5; // 0.5-2
            }
            
            // ========== REGIONS POLARS ==========
            // √Ärtic
            else if (lat > 66) {
                ng = 0.01 + Math.random() * 0.1; // gaireb√© 0
            }
            // Ant√†rtida
            else if (lat < -60) {
                ng = 0.01 + Math.random() * 0.05; // gaireb√© 0
            }
            
            // ========== OCEANS (baixa activitat) ==========
            else if (Math.abs(lat) > 50) {
                ng = 0.1 + Math.random() * 0.5; // 0.1-0.6
            }
            // Tr√≤pics oce√†nics
            else if (Math.abs(lat) < 25) {
                ng = 1 + Math.random() * 3; // 1-4
            }
            // Zones temperades oce√†niques
            else {
                ng = 0.5 + Math.random() * 1.5; // 0.5-2
            }
            
            return Math.round(ng * 10) / 10;
        }
        
        function updateNgDisplay(lat, lng) {
            const ng = calculateNg(lat, lng);
            const ngValue = document.getElementById('ngValue');
            const ngDesc = document.getElementById('ngDesc');
            const ngRisk = document.getElementById('ngRisk');
            
            ngValue.textContent = ng + ' fl/km¬≤/any';
            ngDesc.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            
            // Determinar nivell de risc (escala global)
            let riskClass, riskText;
            if (ng < 2) {
                riskClass = 'low';
                riskText = 'üü¢ Baix';
            } else if (ng < 5) {
                riskClass = 'medium';
                riskText = 'üü° Moderat';
            } else if (ng < 20) {
                riskClass = 'high';
                riskText = 'üü† Alt';
            } else {
                riskClass = 'very-high';
                riskText = 'üî¥ Molt alt';
            }
            
            ngRisk.className = 'ng-risk ' + riskClass;
            ngRisk.textContent = riskText;
        }
        
        function updateBudgetCalc() {
            const height = parseFloat(document.getElementById('buildingHeight').value) || 10;
            const cableMeters = Math.ceil(height * 1.5);
            const clampCount = cableMeters * 3;
            
            document.getElementById('cableMeters').textContent = cableMeters + ' m';
            document.getElementById('clampCount').textContent = clampCount + ' uds';
        }
        
        function applyDiscount(price, discountStr) {
            const parts = discountStr.split('+');
            let result = price;
            for (const d of parts) {
                result = result * (1 - parseFloat(d) / 100);
            }
            return result;
        }
        
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            
            // Determinar si estem en mode pl√†nol o mapa
            const isPlanoMode = planoMode && planoElements.rods.length > 0;
            
            // Obtenir llista de pararrayos segons el mode
            const rodsToUse = isPlanoMode ? planoElements.rods : lightningRods;
            const rodCount = rodsToUse.length;
            
            // Mostrar indicador de c√†rrega
            const generateBtn = document.getElementById('generatePdfBtn');
            const originalText = generateBtn.textContent;
            generateBtn.textContent = '‚è≥ Generando...';
            generateBtn.disabled = true;
            
            try {
                let mapImage;
                let capturedCanvas;
                
                if (isPlanoMode) {
                    // MODE PL√ÄNOL: Capturar el pl√†nol amb els elements dibuixats
                    const planoInner = document.getElementById('planoInner');
                    
                    // Guardar zoom actual i posar a 100% per captura n√≠tida
                    const originalZoom = planoZoomLevel;
                    planoInner.style.transform = 'scale(1)';
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    // Crear canvas combinat (imatge + dibuixos)
                    const img = document.getElementById('planoImage');
                    const drawCanvas = document.getElementById('planoCanvas');
                    
                    capturedCanvas = document.createElement('canvas');
                    capturedCanvas.width = img.naturalWidth;
                    capturedCanvas.height = img.naturalHeight;
                    const ctx = capturedCanvas.getContext('2d');
                    
                    // Dibuixar imatge de fons
                    ctx.drawImage(img, 0, 0);
                    
                    // Dibuixar elements del canvas per sobre
                    ctx.drawImage(drawCanvas, 0, 0);
                    
                    mapImage = capturedCanvas.toDataURL('image/jpeg', 0.9);
                    
                    // Restaurar zoom
                    planoInner.style.transform = `scale(${originalZoom})`;
                    
                } else {
                    // MODE MAPA: Capturar el mapa Leaflet
                    if (lightningRods.length > 0) {
                        const bounds = L.latLngBounds();
                        lightningRods.forEach(rod => {
                            bounds.extend(rod.marker.getLatLng());
                            bounds.extend(rod.circle.getBounds());
                        });
                        buildings.forEach(building => {
                            bounds.extend(building.getBounds());
                        });
                        map.fitBounds(bounds, { padding: [30, 30] });
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    const mapElement = document.getElementById('map');
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    capturedCanvas = await html2canvas(mapElement, {
                        useCORS: true,
                        allowTaint: true,
                        scale: 2,
                        logging: false
                    });
                    mapImage = capturedCanvas.toDataURL('image/jpeg', 0.8);
                }
                
                const doc = new jsPDF();
                const clientRef = document.getElementById('clientRef').value || (currentLang === 'pt' ? 'Sem referencia' : currentLang === 'fr' ? 'Sans reference' : currentLang === 'en' ? 'No reference' : 'Sin referencia');
                const projectNum = document.getElementById('projectNumber').value || '';
                const companyName = document.getElementById('companyName').value || '';
                const today = new Date().toLocaleDateString(currentLang === 'pt' ? 'pt-PT' : currentLang === 'fr' ? 'fr-FR' : currentLang === 'en' ? 'en-GB' : 'es-ES');
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = 20;
                
                // Helper for accented text - jsPDF helvetica doesn't support all chars
                function cleanText(text) {
                    return text
                        .replace(/[√°√†√¢√£]/g, 'a').replace(/[√Å√Ä√Ç√É]/g, 'A')
                        .replace(/[√©√®√™√´]/g, 'e').replace(/[√â√à√ä√ã]/g, 'E')
                        .replace(/[√≠√¨√Æ√Ø]/g, 'i').replace(/[√ç√å√é√è]/g, 'I')
                        .replace(/[√≥√≤√¥√µ]/g, 'o').replace(/[√ì√í√î√ï]/g, 'O')
                        .replace(/[√∫√π√ª√º]/g, 'u').replace(/[√ö√ô√õ√ú]/g, 'U')
                        .replace(/[√±]/g, 'n').replace(/[√ë]/g, 'N')
                        .replace(/[√ß]/g, 'c').replace(/[√á]/g, 'C')
                        .replace(/[Œî]/g, 'D').replace(/[¬µ]/g, 'u')
                        .replace(/[¬≥]/g, '3').replace(/[¬≤]/g, '2')
                        .replace(/[¬∫]/g, 'o').replace(/[¬™]/g, 'a')
                        .replace(/[‚Äî‚Äì]/g, '-');
                }
                
                // ==========================================
                // PAGINA 1: DADES TECNIQUES (Report style matching INGESCO format)
                // ==========================================
                
                // Header bar
                doc.setFillColor(255, 255, 255);
                doc.rect(0, 0, pageWidth, 32, 'F');
                doc.setDrawColor(26, 82, 118);
                doc.setLineWidth(0.8);
                doc.line(0, 32, pageWidth, 32);
                
                // INGESCO logo image
                try { doc.addImage(INGESCO_LOGO_B64, 'JPEG', 10, 3, 55, 15); } catch(e) {}
                
                // Title right side
                doc.setTextColor(26, 82, 118);
                doc.setFontSize(13);
                doc.setFont('helvetica', 'bold');
                doc.text(cleanText(t('pdf_title')), pageWidth - 15, 12, { align: 'right' });
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(cleanText(t('pdf_date')) + ' ' + today, pageWidth - 15, 22, { align: 'right' });
                
                y = 42;
                
                // Project info box
                doc.setFillColor(240, 248, 255);
                doc.rect(15, y - 5, pageWidth - 30, 22, 'F');
                doc.setDrawColor(26, 82, 118);
                doc.setLineWidth(0.5);
                doc.rect(15, y - 5, pageWidth - 30, 22, 'S');
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(cleanText(t('pdf_project')) + ' ', 20, y + 2);
                doc.setFont('helvetica', 'normal');
                const projText = projectNum ? projectNum + ' ' + clientRef : clientRef;
                doc.setFont('helvetica', 'bold');
                doc.text(projText, 42, y + 2);
                
                doc.setFont('helvetica', 'bold');
                doc.text(cleanText(t('pdf_empresa')) + ' ', 120, y + 2);
                doc.setFont('helvetica', 'bold');
                doc.text(companyName || '-', 142, y + 2);
                doc.setFont('helvetica', 'normal');
                
                y += 22;
                
                // Number of installations line
                doc.setFillColor(240, 248, 255);
                doc.rect(15, y, pageWidth - 30, 10, 'F');
                doc.setDrawColor(26, 82, 118);
                doc.rect(15, y, pageWidth - 30, 10, 'S');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(cleanText(t('pdf_num_installations')) + ' ', 20, y + 7);
                doc.setFont('helvetica', 'bold');
                doc.text(String(rodCount), 20 + doc.getTextWidth(cleanText(t('pdf_num_installations')) + ' '), y + 7);
                
                y += 16;
                
                // Lightning rods table (matching report format: N. | Modelo | Tipo | Œît | Nivel | Radio)
                // Table header
                doc.setFillColor(240, 240, 240);
                doc.rect(15, y, pageWidth - 30, 8, 'F');
                doc.setDrawColor(26, 82, 118);
                doc.rect(15, y, pageWidth - 30, 8, 'S');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text('N.', 20, y + 5.5);
                doc.text(cleanText(t('pdf_model_col')), 35, y + 5.5);
                doc.text(cleanText(t('pdf_type_col')), 85, y + 5.5);
                doc.text(cleanText(t('pdf_dt_col')), 110, y + 5.5);
                doc.text(cleanText(t('pdf_level_col')), 130, y + 5.5);
                doc.text(cleanText(t('pdf_radius_col')), 160, y + 5.5);
                
                y += 8;
                
                const typeColors = { pdc: [52, 152, 219], pdce: [155, 89, 182], air: [230, 126, 34] };
                
                if (rodCount === 0) {
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(9);
                    doc.text(cleanText(t('pdf_no_rods')), 20, y + 5);
                    y += 12;
                } else {
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    
                    rodsToUse.forEach((rod, i) => {
                        // Alternating row bg
                        if (i % 2 === 0) {
                            doc.setFillColor(250, 250, 250);
                            doc.rect(15, y, pageWidth - 30, 8, 'F');
                        }
                        doc.setDrawColor(200, 200, 200);
                        doc.rect(15, y, pageWidth - 30, 8, 'S');
                        
                        let modelData, radius;
                        if (isPlanoMode) {
                            modelData = allModels[rod.type].models[rod.model];
                            radius = rod.radiusM;
                        } else {
                            modelData = allModels[rod.type].models[rod.model];
                            radius = modelData.radii[rod.level];
                        }
                        
                        const levelName = t('pdf_level_names')[rod.level] || ['I','II','III','IV'][rod.level-1];
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFont('helvetica', 'bold');
                        doc.text(String(i + 1), 20, y + 5.5);
                        doc.text('INGESCO' + rod.model, 35, y + 5.5);
                        
                        const typeColor = typeColors[rod.type];
                        doc.setTextColor(typeColor[0], typeColor[1], typeColor[2]);
                        doc.text(allModels[rod.type].name === 'PDC' ? 'PDA' : allModels[rod.type].name, 85, y + 5.5);
                        
                        doc.setTextColor(0, 0, 0);
                        doc.text(modelData.dt + 'uS', 110, y + 5.5);
                        doc.text(cleanText(levelName), 130, y + 5.5);
                        doc.text(radius + 'm', 160, y + 5.5);
                        
                        y += 8;
                    });
                    
                    y += 5;
                }
                
                // Coverage plan title
                doc.setFillColor(46, 134, 171);
                doc.rect(15, y, pageWidth - 30, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(cleanText(isPlanoMode ? t('pdf_coverage_plan_title') : t('pdf_coverage_map')), 20, y + 5.5);
                
                y += 12;
                
                // Map/plan image
                const imgWidth = pageWidth - 30;
                const imgHeight = (capturedCanvas.height / capturedCanvas.width) * imgWidth;
                const maxImgHeight = pageHeight - y - 30;
                const finalImgHeight = Math.min(imgHeight, maxImgHeight);
                
                doc.addImage(mapImage, 'JPEG', 15, y, imgWidth, finalImgHeight);
                
                // Frame
                doc.setDrawColor(46, 134, 171);
                doc.setLineWidth(1);
                doc.rect(15, y, imgWidth, finalImgHeight, 'S');
                
                // Legend below map
                y += finalImgHeight + 6;
                doc.setFontSize(7);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'italic');
                doc.text(cleanText(t('pdf_legend')), 15, y);
                doc.text(cleanText(t('pdf_legend_text')), 15, y + 4);
                
                if (isPlanoMode && planoScale) {
                    doc.text(cleanText(t('pdf_scale_info')) + ' ' + Math.round(planoScale) + ' ' + cleanText(t('pdf_pixels')), 15, y + 8);
                }
                
                // Footer
                doc.setFontSize(7);
                doc.setTextColor(26, 82, 118);
                doc.text('DENA DESARROLLOS SL', pageWidth - 15, pageHeight - 15, { align: 'right' });
                doc.text('Cardener 5 | 08223 Terrassa | Barcelona | Spain', pageWidth - 15, pageHeight - 11, { align: 'right' });
                doc.text('937 360 305 | ingesco.com | info@ingesco.com', pageWidth - 15, pageHeight - 7, { align: 'right' });
                
                // ==========================================
                // PAGINA 2: LISTA DE MATERIALES (only if mode = 'full')
                // ==========================================
                
                if (pdfMode === 'full') {
                    const height = parseFloat(document.getElementById('buildingHeight').value) || 10;
                    const cableMeters = Math.ceil(height * 1.5);
                    const clampCount = cableMeters * 3;
                    
                    const mastil = height > 15 ? productCatalog.mastil6m : productCatalog.mastil4m;
                    
                    doc.addPage();
                    y = 20;
                    
                    // Header page 2
                    doc.setFillColor(255, 255, 255);
                    doc.rect(0, 0, pageWidth, 25, 'F');
                    doc.setDrawColor(26, 82, 118);
                    doc.setLineWidth(0.8);
                    doc.line(0, 25, pageWidth, 25);
                    
                    try { doc.addImage(INGESCO_LOGO_B64, 'JPEG', 10, 3, 50, 14); } catch(e) {}
                    
                    doc.setTextColor(26, 82, 118);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(cleanText(t('pdf_materials_title')), pageWidth / 2, 15, { align: 'center' });
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Ref: ' + clientRef, pageWidth - 15, 15, { align: 'right' });
                    
                    y = 35;
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(9);
                    doc.text(cleanText(t('pdf_building_height')) + ' ' + height + 'm', 15, y);
                    
                    y += 12;
                    
                    // External protection title
                    doc.setFillColor(46, 134, 171);
                    doc.rect(15, y, pageWidth - 30, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(cleanText(t('pdf_ext_protection')), 17, y + 5.5);
                    
                    y += 12;
                    
                    // Table header
                    doc.setFillColor(240, 240, 240);
                    doc.rect(15, y, pageWidth - 30, 7, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(cleanText(t('pdf_material')), 17, y + 5);
                    doc.text(cleanText(t('pdf_reference')), 120, y + 5);
                    doc.text(cleanText(t('pdf_quantity')), 165, y + 5);
                    
                    y += 10;
                    
                    // Materials
                    const materials = [];
                    
                    const rodsByModel = {};
                    rodsToUse.forEach(rod => {
                        const key = rod.type + '-' + rod.model;
                        if (!rodsByModel[key]) {
                            rodsByModel[key] = { type: rod.type, model: rod.model, count: 0 };
                        }
                        rodsByModel[key].count++;
                    });
                    
                    for (const key in rodsByModel) {
                        const rodInfo = rodsByModel[key];
                        const modelData = allModels[rodInfo.type].models[rodInfo.model];
                        materials.push({
                            name: 'Pararrayos INGESCO ' + rodInfo.model,
                            ref: modelData.ref,
                            qty: rodInfo.count,
                            unit: 'ud'
                        });
                    }
                    
                    const numRods = rodCount || 1;
                    
                    materials.push({ name: productCatalog.piezaAdapt.name, ref: productCatalog.piezaAdapt.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: mastil.name, ref: mastil.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.anclaje.name, ref: productCatalog.anclaje.ref, qty: numRods * 2, unit: 'ud' });
                    materials.push({ name: 'Cable cobre desnudo 50mm2', ref: productCatalog.cableCobre.ref, qty: cableMeters * numRods * 2, unit: 'm' });
                    materials.push({ name: productCatalog.abrazadera.name, ref: productCatalog.abrazadera.ref, qty: clampCount * numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.contador.name, ref: productCatalog.contador.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.tuboProtec.name, ref: productCatalog.tuboProtec.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.senal.name, ref: productCatalog.senal.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.arqueta.name, ref: productCatalog.arqueta.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.barraEquip.name, ref: productCatalog.barraEquip.ref, qty: numRods, unit: 'ud' });
                    materials.push({ name: productCatalog.pica.name, ref: productCatalog.pica.ref, qty: numRods * 3, unit: 'ud' });
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    
                    materials.forEach((mat, i) => {
                        if (i % 2 === 0) {
                            doc.setFillColor(250, 250, 250);
                            doc.rect(15, y - 3, pageWidth - 30, 7, 'F');
                        }
                        
                        doc.setTextColor(0, 0, 0);
                        doc.text(cleanText(mat.name), 17, y + 1);
                        doc.text(mat.ref, 120, y + 1);
                        doc.setFont('helvetica', 'bold');
                        doc.text(mat.qty + ' ' + mat.unit, 167, y + 1);
                        doc.setFont('helvetica', 'normal');
                        
                        y += 7;
                    });
                    
                    y += 8;
                    
                    // Internal protection
                    doc.setFillColor(46, 134, 171);
                    doc.rect(15, y, pageWidth - 30, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(cleanText(t('pdf_int_protection')), 17, y + 5.5);
                    
                    y += 12;
                    doc.setFillColor(250, 250, 250);
                    doc.rect(15, y - 3, pageWidth - 30, 7, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.text(cleanText(productCatalog.protectorTri.name), 17, y + 1);
                    doc.text(productCatalog.protectorTri.ref, 120, y + 1);
                    doc.setFont('helvetica', 'bold');
                    doc.text('1 ud', 167, y + 1);
                    
                    // Footer
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(100, 100, 100);
                    y += 20;
                    doc.text(cleanText(t('pdf_norms')), 15, y);
                    y += 4;
                    doc.setTextColor(26, 82, 118);
                    doc.text('DENA DESARROLLOS SL | Cardener 5 | 08223 Terrassa | Barcelona | Spain', 15, y);
                    doc.text('937 360 305 | ingesco.com | info@ingesco.com', 15, y + 4);
                }
                
                // ==========================================
                // INSTALLATION INSTRUCTIONS PAGE (always added)
                // ==========================================
                doc.addPage();
                y = 0;
                
                // Header with logo
                doc.setFillColor(255, 255, 255);
                doc.rect(0, 0, pageWidth, 32, 'F');
                doc.setDrawColor(26, 82, 118);
                doc.setLineWidth(0.8);
                doc.line(0, 32, pageWidth, 32);
                
                try { doc.addImage(INGESCO_LOGO_B64, 'JPEG', 10, 3, 55, 15); } catch(e) {}
                
                doc.setTextColor(26, 82, 118);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                const instTitleLines = doc.splitTextToSize(cleanText(t('inst_title')), 100);
                doc.text(instTitleLines, pageWidth - 15, 12, { align: 'right' });
                
                // Installation diagram image on left side
                const imgLeftX = 12;
                const imgTopY = 36;
                const imgW = 25;  // narrow column for the image
                const imgH = 200; // tall image
                try { doc.addImage(INSTALL_DIAGRAM_B64, 'JPEG', imgLeftX, imgTopY, imgW, imgH); } catch(e) {}
                
                // Text starts to the right of the image
                const textLeftX = imgLeftX + imgW + 8;
                const textWidth = pageWidth - textLeftX - 15;
                
                y = 42;
                
                // Lightning Rod section
                doc.setFillColor(26, 82, 118);
                doc.rect(textLeftX - 3, y, textWidth + 3, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(cleanText(t('inst_rod_title')), textLeftX, y + 5.5);
                y += 12;
                
                doc.setTextColor(51, 51, 51);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                const rodInstructions = [t('inst_rod_1'), t('inst_rod_2'), t('inst_rod_3'), t('inst_rod_4')];
                rodInstructions.forEach(inst => {
                    const lines = doc.splitTextToSize('¬∑ ' + cleanText(inst), textWidth - 5);
                    doc.text(lines, textLeftX, y);
                    y += lines.length * 4.2 + 1.5;
                });
                
                y += 3;
                
                // Down conductor section
                doc.setFillColor(26, 82, 118);
                doc.rect(textLeftX - 3, y, textWidth + 3, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(cleanText(t('inst_down_title')), textLeftX, y + 5.5);
                y += 12;
                
                doc.setTextColor(51, 51, 51);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                const downInstructions = [t('inst_down_1'), t('inst_down_2'), t('inst_down_3'), t('inst_down_4'), t('inst_down_5')];
                downInstructions.forEach(inst => {
                    const lines = doc.splitTextToSize('¬∑ ' + cleanText(inst), textWidth - 5);
                    doc.text(lines, textLeftX, y);
                    y += lines.length * 4.2 + 1.5;
                });
                
                y += 3;
                
                // Earthing section
                doc.setFillColor(26, 82, 118);
                doc.rect(textLeftX - 3, y, textWidth + 3, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(cleanText(t('inst_ground_title')), textLeftX, y + 5.5);
                y += 12;
                
                doc.setTextColor(51, 51, 51);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                
                // First item with sub-items
                let gLines = doc.splitTextToSize('¬∑ ' + cleanText(t('inst_ground_1')), textWidth - 5);
                doc.text(gLines, textLeftX, y);
                y += gLines.length * 4.2 + 1.5;
                
                const subItems = [t('inst_ground_1a'), t('inst_ground_1b'), t('inst_ground_1c')];
                subItems.forEach(sub => {
                    const sLines = doc.splitTextToSize('  ¬∑ ' + cleanText(sub), textWidth - 10);
                    doc.text(sLines, textLeftX + 5, y);
                    y += sLines.length * 4.2 + 1;
                });
                
                const groundInstructions = [t('inst_ground_2'), t('inst_ground_3'), t('inst_ground_4')];
                groundInstructions.forEach(inst => {
                    const lines = doc.splitTextToSize('¬∑ ' + cleanText(inst), textWidth - 5);
                    doc.text(lines, textLeftX, y);
                    y += lines.length * 4.2 + 1.5;
                });
                
                // Footer on installation page
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(26, 82, 118);
                doc.text('DENA DESARROLLOS SL', pageWidth - 15, pageHeight - 18, { align: 'right' });
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.text('Cardener 5 | 08223 Terrassa | Barcelona | Spain', pageWidth - 15, pageHeight - 13, { align: 'right' });
                doc.text('937 360 305 | T (+34) 937 360 314', pageWidth - 15, pageHeight - 9, { align: 'right' });
                doc.setTextColor(46, 134, 171);
                doc.text('ingesco.com', pageWidth - 15, pageHeight - 5, { align: 'right' });
                
// Descarregar
                const modePrefix = isPlanoMode ? 'Plano' : 'Mapa';
                const filePrefix = pdfMode === 'image' ? modePrefix : 'Materiales';
                const safeRef = clientRef.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
                doc.save(`${filePrefix}_${safeRef}_${today.replace(/\//g, '-')}.pdf`);
                
                closeBudgetPanel();
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                alert('Error generando el PDF. Vuelve a intentarlo.');
            } finally {
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
            }
        }
        
        // ============================================
        // GENERAR TAULES
        // ============================================
        
        function generateTables() {
            for (const [type, data] of Object.entries(allModels)) {
                const tbody = document.querySelector(`#table${type.toUpperCase()} tbody`);
                tbody.innerHTML = '';
                
                for (const [name, model] of Object.entries(data.models)) {
                    const tr = document.createElement('tr');
                    tr.dataset.type = type;
                    tr.dataset.model = name;
                    tr.innerHTML = `
                        <td>${name.replace('PDC.E ', '').replace('PDC ', '').replace('AIR ', '')}</td>
                        <td>${model.dt}</td>
                        <td>${model.radii[1]}</td>
                        <td>${model.radii[2]}</td>
                        <td>${model.radii[3]}</td>
                        <td>${model.radii[4]}</td>
                    `;
                    tbody.appendChild(tr);
                }
            }
        }
        
        function highlightTableCell() {
            document.querySelectorAll('.legend-table td').forEach(td => td.classList.remove('highlight'));
            const row = document.querySelector(`tr[data-type="${currentType}"][data-model="${currentModel}"]`);
            if (row) {
                row.cells[0].classList.add('highlight');
                row.cells[currentLevel + 1].classList.add('highlight');
            }
        }
        
        // ============================================
        // EVENTOS DEL MAPA
        // ============================================
        
        map.on('click', e => {
            // Modo colocar pararrayos
            if (pararrayosMode && !drawingMode) {
                addMarker(e.latlng);
            }
            // Modo dibujar bajante
            else if (bajanteMode && !drawingMode) {
                if (!bajanteStart) {
                    // Primer clic: inicio de la bajante
                    bajanteStart = e.latlng;
                    updateInstruction('üìè Bajante: Clic en el punto final (toma de tierra)');
                } else {
                    // Segundo clic: fin de la bajante
                    addBajante(bajanteStart, e.latlng);
                    bajanteStart = null;
                    updateInstruction('üìè Bajante: Clic en el inicio (pararrayos)');
                }
            }
            // Modo toma de tierra
            else if (tierraMode && !drawingMode) {
                addTomaTierra(e.latlng);
            }
            // Actualizar densidad de rayos
            updateNgDisplay(e.latlng.lat, e.latlng.lng);
        });
        
        // ============================================
        // DIBUIX D'EDIFICIS
        // ============================================
        
        // Capa per edificis
        const buildingsLayer = new L.FeatureGroup();
        map.addLayer(buildingsLayer);
        
        // Configuraci√≥ Leaflet.draw amb mides
        const drawControlFull = new L.Control.Draw({
            position: 'topright',
            draw: {
                polyline: false,
                circle: false,
                circlemarker: false,
                marker: false,
                polygon: {
                    allowIntersection: false,
                    showArea: true,
                    showLength: true,
                    metric: true,
                    shapeOptions: {
                        color: '#3498db',
                        fillColor: '#3498db',
                        fillOpacity: 0.3,
                        weight: 2,
                        smoothFactor: 0
                    }
                },
                rectangle: {
                    showArea: true,
                    showLength: true,
                    metric: true,
                    shapeOptions: {
                        color: '#3498db',
                        fillColor: '#3498db',
                        fillOpacity: 0.3,
                        weight: 2,
                        smoothFactor: 0
                    }
                }
            },
            edit: {
                featureGroup: buildingsLayer,
                remove: true
            }
        });
        
        // Configurar idioma catal√† per les mides
        L.drawLocal.draw.handlers.polygon.tooltip.start = 'Clica per comen√ßar a dibuixar';
        L.drawLocal.draw.handlers.polygon.tooltip.cont = 'Clica per continuar dibuixant';
        L.drawLocal.draw.handlers.polygon.tooltip.end = 'Clica el primer punt per tancar';
        L.drawLocal.draw.handlers.rectangle.tooltip.start = 'Clica i arrossega per dibuixar';
        L.drawLocal.draw.handlers.simpleshape.tooltip.end = 'Deixa anar per finalitzar';
        
        function startDrawing(type) {
            // Cancel¬∑lar dibuix anterior si existeix
            if (currentDrawer) {
                currentDrawer.disable();
            }
            
            drawingMode = type;
            document.getElementById('drawIndicator').classList.add('show');
            document.getElementById('measureDisplay').classList.add('show');
            
            // Reiniciar valors de mides
            document.getElementById('measureWidth').textContent = '-';
            document.getElementById('measureHeight').textContent = '-';
            document.getElementById('measureArea').textContent = '-';
            document.getElementById('measurePerimeter').textContent = '-';
            
            document.querySelectorAll('.btn-draw').forEach(btn => btn.classList.remove('active'));
            
            if (type === 'rectangle') {
                document.getElementById('btnDrawRect').classList.add('active');
                currentDrawer = new L.Draw.Rectangle(map, drawControlFull.options.draw.rectangle);
            } else {
                document.getElementById('btnDrawPoly').classList.add('active');
                currentDrawer = new L.Draw.Polygon(map, drawControlFull.options.draw.polygon);
            }
            
            currentDrawer.enable();
        }
        
        function stopDrawing() {
            if (currentDrawer) {
                currentDrawer.disable();
                currentDrawer = null;
            }
            drawingMode = null;
            document.getElementById('drawIndicator').classList.remove('show');
            document.getElementById('measureDisplay').classList.remove('show');
            document.querySelectorAll('.btn-draw').forEach(btn => btn.classList.remove('active'));
        }
        
        // Event quan es crea un edifici
        map.on(L.Draw.Event.CREATED, function(e) {
            let layer = e.layer;
            
            // Guardar coordenades originals per evitar deformaci√≥
            if (layer instanceof L.Rectangle) {
                layer._originalBounds = layer.getBounds();
            } else {
                const latlngs = layer.getLatLngs();
                if (Array.isArray(latlngs[0])) {
                    layer._originalLatLngs = latlngs[0].map(ll => [ll.lat, ll.lng]);
                } else {
                    layer._originalLatLngs = latlngs.map(ll => [ll.lat, ll.lng]);
                }
            }
            
            layer.options.smoothFactor = 0;
            layer.options.noClip = true;
            
            buildingsLayer.addLayer(layer);
            buildings.push(layer);
            
            // Comprovar protecci√≥ i afegir popup
            updateBuildingProtection(layer);
            
            // Amagar mides
            document.getElementById('measureDisplay').classList.remove('show');
            
            stopDrawing();
        });
        
        // For√ßar redibuixat dels edificis quan canvia el zoom
        map.on('zoomend', function() {
            buildings.forEach(layer => {
                if (layer._originalLatLngs) {
                    const newLatLngs = layer._originalLatLngs.map(ll => L.latLng(ll[0], ll[1]));
                    layer.setLatLngs(newLatLngs);
                } else if (layer._originalBounds) {
                    layer.setBounds(layer._originalBounds);
                }
            });
        });
        
        // Event quan es dibuixa (temps real)
        map.on('draw:drawvertex', function(e) {
            updateLiveMeasurements();
        });
        
        // Actualitzar mides mentre es mou el ratol√≠ durant el dibuix
        map.on('mousemove', function(e) {
            // Actualitzar coordenades
            document.getElementById('currentCoords').textContent = 
                `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
            
            // Si estem dibuixant, actualitzar mides
            if (drawingMode && currentDrawer && currentDrawer._shape) {
                updateLiveMeasurementsFromShape(currentDrawer._shape, e.latlng);
            }
        });
        
        // Funci√≥ per actualitzar mides en temps real
        function updateLiveMeasurementsFromShape(shape, currentLatLng) {
            const measureDisplay = document.getElementById('measureDisplay');
            
            if (shape instanceof L.Rectangle) {
                measureDisplay.classList.add('show');
                const bounds = shape.getBounds();
                
                if (bounds.isValid()) {
                    const nw = bounds.getNorthWest();
                    const ne = bounds.getNorthEast();
                    const sw = bounds.getSouthWest();
                    
                    const width = Math.round(map.distance(nw, ne) * 10) / 10;
                    const height = Math.round(map.distance(nw, sw) * 10) / 10;
                    const area = Math.round(width * height * 10) / 10;
                    const perimeter = Math.round((width + height) * 2 * 10) / 10;
                    
                    document.getElementById('measureWidth').textContent = width + ' m';
                    document.getElementById('measureHeight').textContent = height + ' m';
                    document.getElementById('measureArea').textContent = area + ' m¬≤';
                    document.getElementById('measurePerimeter').textContent = perimeter + ' m';
                }
            } else if (shape instanceof L.Polygon) {
                measureDisplay.classList.add('show');
                let latlngs = shape.getLatLngs();
                if (latlngs.length > 0 && Array.isArray(latlngs[0])) {
                    latlngs = latlngs[0];
                }
                
                // Afegir punt actual si existeix
                if (currentLatLng && latlngs.length > 0) {
                    latlngs = [...latlngs, currentLatLng];
                }
                
                if (latlngs.length >= 2) {
                    let perimeter = 0;
                    for (let i = 0; i < latlngs.length; i++) {
                        const next = (i + 1) % latlngs.length;
                        perimeter += map.distance(latlngs[i], latlngs[next]);
                    }
                    perimeter = Math.round(perimeter * 10) / 10;
                    
                    const area = latlngs.length >= 3 ? Math.round(calculatePolygonArea(latlngs) * 10) / 10 : 0;
                    
                    document.getElementById('measureWidth').textContent = latlngs.length + ' punts';
                    document.getElementById('measureHeight').textContent = '-';
                    document.getElementById('measureArea').textContent = area + ' m¬≤';
                    document.getElementById('measurePerimeter').textContent = perimeter + ' m';
                }
            }
        }
        
        function updateLiveMeasurements() {
            if (currentDrawer && currentDrawer._shape) {
                updateLiveMeasurementsFromShape(currentDrawer._shape, null);
            }
        }
        
        // Event quan s'esborra un edifici
        map.on(L.Draw.Event.DELETED, function(e) {
            e.layers.eachLayer(layer => {
                const idx = buildings.indexOf(layer);
                if (idx > -1) buildings.splice(idx, 1);
            });
        });
        
        // Cancel¬∑lar amb ESC
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && drawingMode) {
                stopDrawing();
            }
        });
        
        // Comprovar si un punt est√† dins d'algun cercle de protecci√≥
        function isPointProtected(latlng) {
            for (const rod of lightningRods) {
                const center = rod.circle.getLatLng();
                const radius = rod.circle.getRadius();
                const distance = map.distance(latlng, center);
                if (distance <= radius) {
                    return true;
                }
            }
            return false;
        }
        
        // Comprovar si tot l'edifici est√† protegit
        function isBuildingProtected(layer) {
            if (lightningRods.length === 0) return false;
            
            let bounds;
            let points = [];
            
            if (layer instanceof L.Rectangle) {
                bounds = layer.getBounds();
                // Comprovar les 4 cantonades + centre
                points = [
                    bounds.getNorthWest(),
                    bounds.getNorthEast(),
                    bounds.getSouthWest(),
                    bounds.getSouthEast(),
                    bounds.getCenter()
                ];
            } else if (layer instanceof L.Polygon) {
                // Comprovar tots els v√®rtexs
                points = layer.getLatLngs()[0];
                // Afegir el centre
                bounds = layer.getBounds();
                points.push(bounds.getCenter());
            }
            
            // Tots els punts han d'estar protegits
            return points.every(point => isPointProtected(point));
        }
        
        // Actualizar visualizaci√≥n de protecci√≥n de un edificio
        function updateBuildingProtection(layer) {
            const isProtected = isBuildingProtected(layer);
            const color = isProtected ? '#27ae60' : '#e74c3c';
            const status = isProtected ? '‚úÖ PROTEGIDO' : '‚ö†Ô∏è FUERA DE COBERTURA';
            
            layer.setStyle({
                color: color,
                fillColor: color,
                fillOpacity: 0.3,
                weight: 3,
                smoothFactor: 0,
                noClip: true
            });
            
            const bounds = layer.getBounds();
            const measurements = calculateMeasurements(layer);
            
            let dimensionsHtml = '';
            if (layer instanceof L.Rectangle) {
                dimensionsHtml = `
                    <tr><td>Ancho:</td><td>${measurements.width} m</td></tr>
                    <tr><td>Alto:</td><td>${measurements.height} m</td></tr>
                    <tr><td>√Årea:</td><td>${measurements.area} m¬≤</td></tr>
                    <tr><td>Per√≠metro:</td><td>${measurements.perimeter} m</td></tr>
                `;
            } else {
                dimensionsHtml = `
                    <tr><td>√Årea:</td><td>${measurements.area} m¬≤</td></tr>
                    <tr><td>Per√≠metro:</td><td>${measurements.perimeter} m</td></tr>
                    <tr><td>V√©rtices:</td><td>${measurements.vertices}</td></tr>
                `;
            }
            
            layer.bindPopup(`
                <div class="popup-content">
                    <h3>üè¢ Edificio</h3>
                    <div style="font-size: 1.1em; font-weight: bold; color: ${color}; margin: 10px 0;">
                        ${status}
                    </div>
                    <table class="popup-table">
                        ${dimensionsHtml}
                    </table>
                    <button class="popup-delete" onclick="removeBuilding(${buildings.indexOf(layer)})">üóëÔ∏è Eliminar edificio</button>
                </div>
            `);
        }
        
        // Calcular mides detallades
        function calculateMeasurements(layer) {
            if (layer instanceof L.Rectangle) {
                const bounds = layer.getBounds();
                const nw = bounds.getNorthWest();
                const ne = bounds.getNorthEast();
                const sw = bounds.getSouthWest();
                
                const width = Math.round(map.distance(nw, ne) * 10) / 10;
                const height = Math.round(map.distance(nw, sw) * 10) / 10;
                const area = Math.round(width * height * 10) / 10;
                const perimeter = Math.round((width + height) * 2 * 10) / 10;
                
                return { width, height, area, perimeter };
            } else if (layer instanceof L.Polygon) {
                const latlngs = layer.getLatLngs()[0];
                let perimeter = 0;
                
                // Calcular per√≠metre
                for (let i = 0; i < latlngs.length; i++) {
                    const next = (i + 1) % latlngs.length;
                    perimeter += map.distance(latlngs[i], latlngs[next]);
                }
                perimeter = Math.round(perimeter * 10) / 10;
                
                // Calcular √†rea amb f√≥rmula de Shoelace
                const area = Math.round(calculatePolygonArea(latlngs) * 10) / 10;
                
                return { area, perimeter, vertices: latlngs.length };
            }
            
            return { area: 0, perimeter: 0 };
        }
        
        // Calcular √†rea d'un pol√≠gon usant coordenades geogr√†fiques
        function calculatePolygonArea(latlngs) {
            // Convertir a metres usant projecci√≥
            const earthRadius = 6371000; // metres
            let area = 0;
            
            if (latlngs.length < 3) return 0;
            
            // F√≥rmula de l'√†rea geod√®sica simplificada
            for (let i = 0; i < latlngs.length; i++) {
                const j = (i + 1) % latlngs.length;
                const xi = latlngs[i].lng * Math.PI / 180;
                const yi = latlngs[i].lat * Math.PI / 180;
                const xj = latlngs[j].lng * Math.PI / 180;
                const yj = latlngs[j].lat * Math.PI / 180;
                
                area += (xj - xi) * (2 + Math.sin(yi) + Math.sin(yj));
            }
            
            area = Math.abs(area * earthRadius * earthRadius / 2);
            return area;
        }
        
        // Esborrar un edifici
        window.removeBuilding = function(idx) {
            if (idx >= 0 && idx < buildings.length) {
                buildingsLayer.removeLayer(buildings[idx]);
                buildings.splice(idx, 1);
            }
        };
        
        // Actualitzar tots els edificis quan canvien els cercles
        function updateAllBuildingsProtection() {
            buildings.forEach(building => updateBuildingProtection(building));
        }
        
        // ============================================
        // MODO PLANO - Funciones
        // ============================================
        
        function openPlanoFileDialog() {
            document.getElementById('planoFileInput').click();
        }
        
        function loadPlanoFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('planoImage');
                img.onload = function() {
                    enterPlanoMode(img.naturalWidth, img.naturalHeight);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function enterPlanoMode(imgWidth, imgHeight) {
            planoMode = true;
            planoScale = null;
            planoZoomLevel = 1;
            planoElements = { rods: [], tierras: [], bajantes: [] };
            
            // Ocultar mapa, mostrar plano
            document.getElementById('map').style.display = 'none';
            document.getElementById('planoWrapper').classList.add('show');
            
            // Configurar canvas
            const canvas = document.getElementById('planoCanvas');
            const inner = document.getElementById('planoInner');
            canvas.width = imgWidth;
            canvas.height = imgHeight;
            inner.style.width = imgWidth + 'px';
            inner.style.height = imgHeight + 'px';
            
            // Ajustar zoom inicial para que quepa
            planoZoom('fit');
            
            // Actualizar UI
            document.getElementById('planoScaleDisplay').textContent = 'No definida';
            document.getElementById('planoRodCount').textContent = '0';
            document.getElementById('btnPlano').classList.add('active');
            updateInstruction('üìÑ MODO PLANO: Define la escala primero con "üìè Definir Escala"');
            
            // Configurar eventos del plano
            setupPlanoEvents();
        }
        
        function exitPlanoMode() {
            planoMode = false;
            planoScaleMode = false;
            
            document.getElementById('map').style.display = 'block';
            document.getElementById('planoWrapper').classList.remove('show');
            document.getElementById('btnPlano').classList.remove('active');
            document.getElementById('scaleIndicator').classList.remove('show');
            document.getElementById('scalePanel').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
            
            updateInstruction('‚ö° Activa "Colocar Pararrayos" para a√±adir | üè¢ Dibuja edificios para verificar cobertura');
        }
        
        function setupPlanoEvents() {
            const container = document.getElementById('planoContainer');
            const canvas = document.getElementById('planoCanvas');
            
            // Obtenir coordenades del pl√†nol des d'un event del ratol√≠
            function getPlanoCoords(e) {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: (e.clientX - rect.left) / planoZoomLevel,
                    y: (e.clientY - rect.top) / planoZoomLevel
                };
            }
            
            // Hit detection: trobar element sota el cursor
            function hitTest(px, py) {
                const hitRadius = 18 / planoZoomLevel; // radi de detecci√≥ adaptat al zoom
                
                // Comprovar pararrayos (prioritat alta)
                for (let i = planoElements.rods.length - 1; i >= 0; i--) {
                    const rod = planoElements.rods[i];
                    const dx = px - rod.x;
                    const dy = py - rod.y;
                    if (Math.sqrt(dx*dx + dy*dy) < hitRadius) {
                        return {type: 'rod', index: i};
                    }
                }
                // Comprovar tomes de terra
                for (let i = planoElements.tierras.length - 1; i >= 0; i--) {
                    const t = planoElements.tierras[i];
                    const dx = px - t.x;
                    const dy = py - t.y;
                    if (Math.sqrt(dx*dx + dy*dy) < hitRadius) {
                        return {type: 'tierra', index: i};
                    }
                }
                // Comprovar bajantes (dist√†ncia a la l√≠nia)
                for (let i = planoElements.bajantes.length - 1; i >= 0; i--) {
                    const b = planoElements.bajantes[i];
                    const dist = pointToLineDistance(px, py, b.x1, b.y1, b.x2, b.y2);
                    if (dist < hitRadius) {
                        return {type: 'bajante', index: i};
                    }
                }
                return null;
            }
            
            // Dist√†ncia d'un punt a un segment
            function pointToLineDistance(px, py, x1, y1, x2, y2) {
                const A = px - x1;
                const B = py - y1;
                const C = x2 - x1;
                const D = y2 - y1;
                const dot = A*C + B*D;
                const lenSq = C*C + D*D;
                let t = lenSq !== 0 ? dot / lenSq : -1;
                t = Math.max(0, Math.min(1, t));
                const xx = x1 + t * C;
                const yy = y1 + t * D;
                return Math.sqrt((px - xx)*(px - xx) + (py - yy)*(py - yy));
            }
            
            // MOUSEDOWN
            container.onmousedown = function(e) {
                if (e.button !== 0) return; // Nom√©s bot√≥ esquerre
                planoMouseMoved = false;
                
                const coords = getPlanoCoords(e);
                
                // Si estem en mode escala o col¬∑locaci√≥, no arrossegar elements
                if (planoScaleMode || pararrayosMode || tierraMode || bajanteMode) {
                    // Pan del pl√†nol no en mode eina
                    return;
                }
                
                // Comprovar si fem clic sobre un element existent
                const hit = hitTest(coords.x, coords.y);
                if (hit && (hit.type === 'rod' || hit.type === 'tierra')) {
                    // Iniciar arrossegament d'element
                    planoDraggingElement = true;
                    planoSelectedElement = hit;
                    const elem = hit.type === 'rod' ? planoElements.rods[hit.index] : planoElements.tierras[hit.index];
                    planoDragElementOffset = {
                        x: coords.x - elem.x,
                        y: coords.y - elem.y
                    };
                    container.style.cursor = 'grabbing';
                    closePlanoPopup();
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                
                // Si no hi ha element, arrossegar el pl√†nol (pan)
                planoDragging = true;
                planoDragStart = {x: e.clientX, y: e.clientY};
                planoScrollStart = {x: container.scrollLeft, y: container.scrollTop};
                container.style.cursor = 'grabbing';
            };
            
            // MOUSEMOVE
            container.onmousemove = function(e) {
                if (planoDraggingElement) {
                    planoMouseMoved = true;
                    const coords = getPlanoCoords(e);
                    const newX = coords.x - planoDragElementOffset.x;
                    const newY = coords.y - planoDragElementOffset.y;
                    
                    if (planoSelectedElement.type === 'rod') {
                        planoElements.rods[planoSelectedElement.index].x = newX;
                        planoElements.rods[planoSelectedElement.index].y = newY;
                    } else if (planoSelectedElement.type === 'tierra') {
                        planoElements.tierras[planoSelectedElement.index].x = newX;
                        planoElements.tierras[planoSelectedElement.index].y = newY;
                    }
                    drawPlano();
                    return;
                }
                
                if (planoDragging) {
                    planoMouseMoved = true;
                    const dx = e.clientX - planoDragStart.x;
                    const dy = e.clientY - planoDragStart.y;
                    container.scrollLeft = planoScrollStart.x - dx;
                    container.scrollTop = planoScrollStart.y - dy;
                    return;
                }
                
                // Cursor segons element sota el ratol√≠
                if (!planoScaleMode && !pararrayosMode && !tierraMode && !bajanteMode) {
                    const coords = getPlanoCoords(e);
                    const hit = hitTest(coords.x, coords.y);
                    container.style.cursor = hit ? 'pointer' : 'grab';
                }
            };
            
            // MOUSEUP
            container.onmouseup = function(e) {
                if (planoDraggingElement) {
                    planoDraggingElement = false;
                    if (!planoMouseMoved) {
                        // Si no s'ha mogut, obrir popup
                        showPlanoPopup(planoSelectedElement, e);
                    }
                    container.style.cursor = 'pointer';
                    return;
                }
                
                planoDragging = false;
                if (planoScaleMode) {
                    container.style.cursor = 'crosshair';
                } else if (pararrayosMode || tierraMode || bajanteMode) {
                    container.style.cursor = 'crosshair';
                } else {
                    container.style.cursor = 'grab';
                }
            };
            
            container.onmouseleave = function() {
                planoDragging = false;
                planoDraggingElement = false;
                container.style.cursor = 'grab';
            };
            
            // CLICK - col¬∑locar elements o seleccionar
            container.onclick = function(e) {
                if (planoMouseMoved) return; // Si s'ha arrossegat, no processar clic
                
                const coords = getPlanoCoords(e);
                
                if (planoScaleMode) {
                    handlePlanoScaleClick(coords.x, coords.y);
                } else if (pararrayosMode && planoScale) {
                    addPlanoRod(coords.x, coords.y);
                } else if (tierraMode && planoScale) {
                    addPlanoTierra(coords.x, coords.y);
                } else if (bajanteMode && planoScale) {
                    handlePlanoBajanteClick(coords.x, coords.y);
                } else if (!planoScale && (pararrayosMode || tierraMode || bajanteMode)) {
                    alert('‚ö†Ô∏è Primero debes definir la escala del plano');
                } else {
                    // Mode selecci√≥: clic en element per obrir popup
                    const hit = hitTest(coords.x, coords.y);
                    if (hit) {
                        planoSelectedElement = hit;
                        showPlanoPopup(hit, e);
                    } else {
                        closePlanoPopup();
                        planoSelectedElement = null;
                        drawPlano();
                    }
                }
            };
            
            // Zoom amb rueda del ratol√≠
            container.onwheel = function(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                planoZoom(delta);
            };
        }
        
        // ============================================
        // PLANO - Popup d'edici√≥
        // ============================================
        
        function showPlanoPopup(element, mouseEvent) {
            const popup = document.getElementById('planoPopup');
            const title = document.getElementById('planoPopupTitle');
            const body = document.getElementById('planoPopupBody');
            
            // Posicionar popup al costat del clic
            const wrapper = document.getElementById('planoWrapper');
            const wrapperRect = wrapper.getBoundingClientRect();
            let popupX = mouseEvent.clientX - wrapperRect.left + 15;
            let popupY = mouseEvent.clientY - wrapperRect.top - 20;
            
            // Evitar que surti de la pantalla
            if (popupX + 230 > wrapperRect.width) popupX = popupX - 260;
            if (popupY + 200 > wrapperRect.height) popupY = wrapperRect.height - 210;
            if (popupY < 10) popupY = 10;
            
            popup.style.left = popupX + 'px';
            popup.style.top = popupY + 'px';
            
            if (element.type === 'rod') {
                const rod = planoElements.rods[element.index];
                const modelData = allModels[rod.type].models[rod.model];
                title.textContent = '‚ö° Pararrayos #' + (element.index + 1);
                
                // Generar opcions de models pel tipus actual
                let modelOptions = '';
                for (const [key, data] of Object.entries(allModels[rod.type].models)) {
                    modelOptions += `<option value="${key}" ${key === rod.model ? 'selected' : ''}>${key}</option>`;
                }
                
                body.innerHTML = `
                    <div class="plano-popup-row">
                        <label>Tipo:</label>
                        <span style="color: ${rod.type === 'pdc' ? '#3498db' : rod.type === 'pdce' ? '#9b59b6' : '#e67e22'}">${allModels[rod.type].name}</span>
                    </div>
                    <div class="plano-popup-row">
                        <label>Modelo:</label>
                        <select id="planoEditModel" onchange="updatePlanoRodModel(${element.index})">${modelOptions}</select>
                    </div>
                    <div class="plano-popup-row">
                        <label>Nivel:</label>
                        <select id="planoEditLevel" onchange="updatePlanoRodLevel(${element.index})">
                            <option value="1" ${rod.level===1?'selected':''}>I</option>
                            <option value="2" ${rod.level===2?'selected':''}>II</option>
                            <option value="3" ${rod.level===3?'selected':''}>III</option>
                            <option value="4" ${rod.level===4?'selected':''}>IV</option>
                        </select>
                    </div>
                    <div class="plano-popup-row">
                        <label>Radio:</label>
                        <span id="planoEditRadius">${rod.radiusM} m</span>
                    </div>
                    <div class="plano-popup-actions">
                        <button class="plano-btn-delete" onclick="deletePlanoElement('rod', ${element.index})">üóëÔ∏è Eliminar</button>
                    </div>
                `;
            } else if (element.type === 'tierra') {
                title.textContent = '√¢¬è≈° Toma de Tierra #' + (element.index + 1);
                body.innerHTML = `
                    <div class="plano-popup-row">
                        <label>Posici√≥n:</label>
                        <span>(${Math.round(planoElements.tierras[element.index].x)}, ${Math.round(planoElements.tierras[element.index].y)})</span>
                    </div>
                    <div class="plano-popup-actions">
                        <button class="plano-btn-delete" onclick="deletePlanoElement('tierra', ${element.index})">üóëÔ∏è Eliminar</button>
                    </div>
                `;
            } else if (element.type === 'bajante') {
                const b = planoElements.bajantes[element.index];
                const dx = b.x2 - b.x1;
                const dy = b.y2 - b.y1;
                const lengthPx = Math.sqrt(dx*dx + dy*dy);
                const lengthM = planoScale ? (lengthPx / planoScale).toFixed(1) : '?';
                
                title.textContent = 'üìè Bajante #' + (element.index + 1);
                body.innerHTML = `
                    <div class="plano-popup-row">
                        <label>Longitud:</label>
                        <span>${lengthM} m (${Math.round(lengthPx)} px)</span>
                    </div>
                    <div class="plano-popup-actions">
                        <button class="plano-btn-delete" onclick="deletePlanoElement('bajante', ${element.index})">üóëÔ∏è Eliminar</button>
                    </div>
                `;
            }
            
            popup.classList.add('show');
            
            // Ressaltar element seleccionat
            drawPlano();
        }
        
        function closePlanoPopup() {
            document.getElementById('planoPopup').classList.remove('show');
            planoSelectedElement = null;
            drawPlano();
        }
        
        // Editar model d'un pararrayos del pl√†nol
        window.updatePlanoRodModel = function(index) {
            const newModel = document.getElementById('planoEditModel').value;
            const rod = planoElements.rods[index];
            rod.model = newModel;
            
            const modelData = allModels[rod.type].models[newModel];
            rod.radiusM = modelData.radii[rod.level];
            rod.radiusPx = rod.radiusM * planoScale;
            
            document.getElementById('planoEditRadius').textContent = rod.radiusM + ' m';
            drawPlano();
        };
        
        // Editar nivell d'un pararrayos del pl√†nol
        window.updatePlanoRodLevel = function(index) {
            const newLevel = parseInt(document.getElementById('planoEditLevel').value);
            const rod = planoElements.rods[index];
            rod.level = newLevel;
            
            const modelData = allModels[rod.type].models[rod.model];
            rod.radiusM = modelData.radii[newLevel];
            rod.radiusPx = rod.radiusM * planoScale;
            
            document.getElementById('planoEditRadius').textContent = rod.radiusM + ' m';
            drawPlano();
        };
        
        // Eliminar element del pl√†nol
        window.deletePlanoElement = function(type, index) {
            if (type === 'rod') {
                planoElements.rods.splice(index, 1);
                document.getElementById('planoRodCount').textContent = planoElements.rods.length;
            } else if (type === 'tierra') {
                planoElements.tierras.splice(index, 1);
            } else if (type === 'bajante') {
                planoElements.bajantes.splice(index, 1);
            }
            closePlanoPopup();
            drawPlano();
        };
        
        function planoZoom(factor) {
            const container = document.getElementById('planoContainer');
            const inner = document.getElementById('planoInner');
            const img = document.getElementById('planoImage');
            
            if (factor === 'fit') {
                const containerRect = container.parentElement.getBoundingClientRect();
                const scaleX = containerRect.width / img.naturalWidth;
                const scaleY = containerRect.height / img.naturalHeight;
                planoZoomLevel = Math.min(scaleX, scaleY) * 0.95;
            } else {
                planoZoomLevel *= factor;
                planoZoomLevel = Math.max(0.1, Math.min(5, planoZoomLevel));
            }
            
            inner.style.transform = `scale(${planoZoomLevel})`;
            document.getElementById('planoZoomDisplay').textContent = Math.round(planoZoomLevel * 100) + '%';
        }
        
        // ============================================
        // PLANO - Escala
        // ============================================
        
        function startPlanoScale() {
            planoScaleMode = true;
            planoScaleStart = null;
            planoScaleEnd = null;
            
            document.getElementById('planoContainer').classList.add('crosshair');
            document.getElementById('scaleIndicator').textContent = 'üìè Clic en el punto INICIAL de la l√≠nea de referencia';
            document.getElementById('scaleIndicator').classList.add('show');
            document.getElementById('btnPlanoScale').classList.add('active');
            
            updateInstruction('üìè DEFINIR ESCALA: Clic en el punto inicial de una l√≠nea de referencia conocida');
        }
        
        function handlePlanoScaleClick(x, y) {
            if (!planoScaleStart) {
                // Primer clic - inicio
                planoScaleStart = {x, y};
                document.getElementById('scaleIndicator').textContent = 'üìè Clic en el punto FINAL de la l√≠nea de referencia';
                updateInstruction('üìè DEFINIR ESCALA: Ahora clic en el punto final de la l√≠nea');
                drawPlano(); // Redibujar para mostrar el punto
            } else {
                // Segundo clic - fin
                planoScaleEnd = {x, y};
                
                // Calcular longitud en p√≠xeles
                const dx = planoScaleEnd.x - planoScaleStart.x;
                const dy = planoScaleEnd.y - planoScaleStart.y;
                const pixelLength = Math.sqrt(dx*dx + dy*dy);
                
                // Mostrar panel para introducir metros
                document.getElementById('scalePixelsDisplay').textContent = Math.round(pixelLength);
                document.getElementById('scalePanel').classList.add('show');
                document.getElementById('overlay').classList.add('show');
                document.getElementById('scaleIndicator').classList.remove('show');
                
                drawPlano(); // Dibujar l√≠nea de escala
            }
        }
        
        function confirmPlanoScale() {
            const meters = parseFloat(document.getElementById('scaleMetersInput').value);
            if (!meters || meters <= 0) {
                alert('Introduce un valor v√°lido de metros');
                return;
            }
            
            // Calcular p√≠xeles por metro
            const dx = planoScaleEnd.x - planoScaleStart.x;
            const dy = planoScaleEnd.y - planoScaleStart.y;
            const pixelLength = Math.sqrt(dx*dx + dy*dy);
            
            planoScale = pixelLength / meters; // p√≠xeles por metro
            
            // Actualizar UI
            document.getElementById('planoScaleDisplay').textContent = meters + 'm = ' + Math.round(pixelLength) + 'px';
            document.getElementById('scalePanel').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('planoContainer').classList.remove('crosshair');
            document.getElementById('btnPlanoScale').classList.remove('active');
            
            planoScaleMode = false;
            planoScaleStart = null;
            planoScaleEnd = null;
            
            updateInstruction('‚úÖ Escala definida: 1m = ' + Math.round(planoScale) + 'px | Ahora puedes colocar pararrayos');
            
            drawPlano();
        }
        
        function cancelPlanoScale() {
            planoScaleMode = false;
            planoScaleStart = null;
            planoScaleEnd = null;
            
            document.getElementById('scalePanel').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('scaleIndicator').classList.remove('show');
            document.getElementById('planoContainer').classList.remove('crosshair');
            document.getElementById('btnPlanoScale').classList.remove('active');
            
            updateInstruction('üìÑ MODO PLANO: Define la escala con "üìè Definir Escala"');
            drawPlano();
        }
        
        // ============================================
        // PLANO - Elementos
        // ============================================
        
        function addPlanoRod(x, y) {
            const modelData = allModels[currentType].models[currentModel];
            const radiusMeters = modelData.radii[currentLevel];
            const radiusPixels = radiusMeters * planoScale;
            
            planoElements.rods.push({
                x: x,
                y: y,
                type: currentType,
                model: currentModel,
                level: currentLevel,
                radiusM: radiusMeters,
                radiusPx: radiusPixels
            });
            
            document.getElementById('planoRodCount').textContent = planoElements.rods.length;
            drawPlano();
        }
        
        function addPlanoTierra(x, y) {
            planoElements.tierras.push({x, y});
            drawPlano();
        }
        
        let planoBajanteStart = null;
        
        function handlePlanoBajanteClick(x, y) {
            if (!planoBajanteStart) {
                planoBajanteStart = {x, y};
                updateInstruction('üìè BAJANTE: Clic en el punto final');
            } else {
                planoElements.bajantes.push({
                    x1: planoBajanteStart.x,
                    y1: planoBajanteStart.y,
                    x2: x,
                    y2: y
                });
                planoBajanteStart = null;
                updateInstruction('üìè BAJANTE: Clic en el punto inicial');
                drawPlano();
            }
        }
        
        // ============================================
        // PLANO - Dibujar Canvas
        // ============================================
        
        function drawPlano() {
            const canvas = document.getElementById('planoCanvas');
            const ctx = canvas.getContext('2d');
            
            // Limpiar
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Colores per tipus
            const typeColors = {
                pdc: 'rgba(52, 152, 219, 0.25)',
                pdce: 'rgba(155, 89, 182, 0.25)',
                air: 'rgba(230, 126, 34, 0.25)'
            };
            const typeStrokeColors = {
                pdc: '#3498db',
                pdce: '#9b59b6',
                air: '#e67e22'
            };
            
            // Dibujar l√≠nea de escala temporal (si estamos definiendo)
            if (planoScaleStart) {
                ctx.strokeStyle = '#f39c12';
                ctx.lineWidth = 3;
                ctx.setLineDash([10, 5]);
                ctx.beginPath();
                ctx.moveTo(planoScaleStart.x, planoScaleStart.y);
                if (planoScaleEnd) {
                    ctx.lineTo(planoScaleEnd.x, planoScaleEnd.y);
                }
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Punt inicial
                ctx.fillStyle = '#f39c12';
                ctx.beginPath();
                ctx.arc(planoScaleStart.x, planoScaleStart.y, 8, 0, Math.PI * 2);
                ctx.fill();
                
                if (planoScaleEnd) {
                    ctx.beginPath();
                    ctx.arc(planoScaleEnd.x, planoScaleEnd.y, 8, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Dibujar bajantes
            planoElements.bajantes.forEach((b, i) => {
                const isSelected = planoSelectedElement && planoSelectedElement.type === 'bajante' && planoSelectedElement.index === i;
                ctx.strokeStyle = isSelected ? '#FF6600' : '#8B4513';
                ctx.lineWidth = isSelected ? 6 : 4;
                ctx.setLineDash([10, 5]);
                ctx.beginPath();
                ctx.moveTo(b.x1, b.y1);
                ctx.lineTo(b.x2, b.y2);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Mostrar longitud si seleccionat
                if (isSelected && planoScale) {
                    const mx = (b.x1 + b.x2) / 2;
                    const my = (b.y1 + b.y2) / 2;
                    const dx = b.x2 - b.x1;
                    const dy = b.y2 - b.y1;
                    const lengthM = (Math.sqrt(dx*dx + dy*dy) / planoScale).toFixed(1);
                    ctx.fillStyle = 'rgba(255,102,0,0.9)';
                    ctx.fillRect(mx - 25, my - 10, 50, 20);
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(lengthM + 'm', mx, my);
                }
            });
            
            // Dibujar c√≠rculos de cobertura
            planoElements.rods.forEach((rod, i) => {
                const isSelected = planoSelectedElement && planoSelectedElement.type === 'rod' && planoSelectedElement.index === i;
                
                // Cercle de cobertura
                ctx.fillStyle = typeColors[rod.type];
                ctx.strokeStyle = isSelected ? '#FF0000' : typeStrokeColors[rod.type];
                ctx.lineWidth = isSelected ? 5 : 3;
                if (isSelected) ctx.setLineDash([15, 8]);
                ctx.beginPath();
                ctx.arc(rod.x, rod.y, rod.radiusPx, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
                ctx.setLineDash([]);
            });
            
            // Dibujar marcadores de pararrayos
            planoElements.rods.forEach((rod, i) => {
                const isSelected = planoSelectedElement && planoSelectedElement.type === 'rod' && planoSelectedElement.index === i;
                const markerRadius = isSelected ? 16 : 12;
                
                // Halo de selecci√≥
                if (isSelected) {
                    ctx.strokeStyle = '#FF0000';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(rod.x, rod.y, 20, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // Icona del pararrayos
                ctx.fillStyle = typeStrokeColors[rod.type];
                ctx.beginPath();
                ctx.arc(rod.x, rod.y, markerRadius, 0, Math.PI * 2);
                ctx.fill();
                
                // Rayo
                ctx.fillStyle = 'white';
                ctx.font = `bold ${isSelected ? 16 : 14}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('‚ö°', rod.x, rod.y);
                
                // Etiqueta
                const labelBg = isSelected ? 'rgba(255,0,0,0.85)' : 'rgba(0,0,0,0.8)';
                ctx.fillStyle = labelBg;
                const labelText = rod.model + ' (R=' + rod.radiusM + 'm)';
                const labelWidth = Math.max(ctx.measureText(labelText).width + 10, 70);
                ctx.fillRect(rod.x - labelWidth/2, rod.y + 18, labelWidth, 18);
                ctx.fillStyle = 'white';
                ctx.font = '10px Arial';
                ctx.fillText(labelText, rod.x, rod.y + 27);
            });
            
            // Dibujar tomas de tierra
            planoElements.tierras.forEach((t, i) => {
                const isSelected = planoSelectedElement && planoSelectedElement.type === 'tierra' && planoSelectedElement.index === i;
                ctx.strokeStyle = isSelected ? '#FF0000' : '#228B22';
                ctx.lineWidth = isSelected ? 4 : 3;
                
                // Halo de selecci√≥
                if (isSelected) {
                    ctx.beginPath();
                    ctx.arc(t.x, t.y, 20, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // S√≠mbol de terra
                ctx.strokeStyle = isSelected ? '#FF6600' : '#228B22';
                ctx.beginPath();
                ctx.moveTo(t.x, t.y - 10);
                ctx.lineTo(t.x, t.y);
                ctx.moveTo(t.x - 15, t.y);
                ctx.lineTo(t.x + 15, t.y);
                ctx.moveTo(t.x - 10, t.y + 6);
                ctx.lineTo(t.x + 10, t.y + 6);
                ctx.moveTo(t.x - 5, t.y + 12);
                ctx.lineTo(t.x + 5, t.y + 12);
                ctx.stroke();
            });
            
            // Dibujar bajante en curs
            if (planoBajanteStart && bajanteMode) {
                ctx.fillStyle = '#8B4513';
                ctx.beginPath();
                ctx.arc(planoBajanteStart.x, planoBajanteStart.y, 6, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // ============================================
        // INICIALIZACI√É‚ÄúN
          // ============================================
        
        generateTables();
        populateModelSelect();
        updateDisplay();
        // No a√±adir pararrayos inicial - el usuario debe activar el modo primero
    </script>
</body>
</html>
